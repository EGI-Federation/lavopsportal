
<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  xmlns:date="http://exslt.org/dates-and-times" >

    <view name="ROD_CleanUP">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('ROD.portal.clean.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <serializer type="HTMLSerializer"/>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>

    <view name="DASHBOARD_probes_list"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


    <connector type="HTTPConnector">
        <parameter name="url" eval="property('poem-url')"/>
        <parameter name="force-redirect">true</parameter>

    </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">52</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

<!--
    <view name="DASHBOARD_probes_list"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <connector type="HTTPConnector">
            <parameter name="url" eval="property('poem-url')"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="property('poem-api-key')"/>
                <entry key="Accept">application/json</entry>
            </parameter>

        </connector>


        <serializer type="JSONSerializer"/>

        <processors>
                <elements path="/object/array/item/object/profiles/item/object/metrics">
                    <element-create if="ancestor::object/@name='ARGO_MON_CRITICAL'">
                        new_element('item',new_element('object',new_attribute('name','egi.eu.lowAvailability')|new_attribute('fqan','')|new_attribute('service_flavour','argo.avre')))
                    </element-create>

                </elements>

                <element in="object" out="e:entries">
                    <elements-ignore path="array/item/object/profiles/item/object/metrics/item">
                        <element in="object" out="e:entry">
                            <attribute-create out="profile">../../../../@name</attribute-create>
                        </element>

                    </elements-ignore>
                </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">52</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

    </view>-->

<view name="DASHBOARD_alarm_history"  authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
    <argument name="id"/>
    <connector type="SQLConnector">
        <parameter name="driver">com.mysql.jdbc.Driver</parameter>
        <parameter name="url" eval="property('ROD.db.url')"/>
        <parameter name="username" eval="property('ROD.db.username')"/>
        <parameter name="password" eval="property('ROD.db.password')"/>
        <parameter name="query">
            <entry>(SELECT * from rod_nagios_history where monitor_id =</entry>
            <entry eval="quot($id)"/>
            <entry> order by created_at asc)</entry>
            <entry>UNION</entry>
            <entry>(SELECT * from csi_nagios_history where monitor_id =</entry>
            <entry eval="quot($id)"/>
            <entry> order by created_at asc)</entry>
        </parameter>
    </connector>

    <processors>

        <element in="result" out="e:entries">
            <element in="row" out="e:entries">
                <element-ignore>
                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                </element-ignore>

            </element>
        </element>

    </processors>

    <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="contentType">text/xml</parameter>
        </renderer>
    </renderers>
</view>

    <view name="DASHBOARD_notepads"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


    <connector type="SQLConnector">
        <parameter name="driver">com.mysql.jdbc.Driver</parameter>
        <parameter name="url" eval="property('ROD.db.url')"/>
        <parameter name="username" eval="property('ROD.db.username')"/>
        <parameter name="password" eval="property('ROD.db.password')"/>
        <parameter name="query">
            SELECT * from notepad
        </parameter>
    </connector>

        <processors>
            <element in="result" out="e:entries">
                <element in="row" out="e:entries">
                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                    </element-ignore>
                </element>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">8</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="DASHBOARD_alarms_sec"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  authenticators="local">


        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('ROD.db.url')"/>
            <parameter name="username" eval="property('ROD.db.username')"/>
            <parameter name="password" eval="property('ROD.db.password')"/>
            <parameter name="query">
                SELECT * from csi_nagios_problem
            </parameter>
        </connector>

        <processors>

            <element in="result" out="e:entries">
                <element in="row" out="e:entries">
                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                    </element-ignore>
                    <element-create>entry('endpoint',concat(../host_name/text(),'__',../service/text()))</element-create>
                </element>
            </element>


            <element in="e:entries">
                <set variable="probeList">view('DASHBOARD_probes_list')/e:entries</set>

                <element in="e:entries">
                    <element-create>
                        entry('in_production',
                        choose(substring(../e:entry[@key='flags']/text(),4,1)!='',substring(../e:entry[@key='flags']/text(),4,1),-1))
                    </element-create>
                    <element-create>
                        entry('monitored',
                        choose(substring(../e:entry[@key='flags']/text(),3,1)!='',substring(../e:entry[@key='flags']/text(),3,1),-1))
                    </element-create>
                    <element-create>$probeList/e:entry[@name=current()/../e:entry[@key='test_name']/text()]</element-create>
                    <element-create if="contains(../e:entry[@key='summary']/text(),'egi.eu.lowAvailability')">$probeList/e:entry[@name='egi.eu.lowAvailability']</element-create>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-create-as-parent out="e:entries" attributes="new_attribute('key','profiles')">
                        <element in="e:entry" if="@profile">
                            <attribute-ignore/>
                            <text-create>../@profile</text-create>
                        </element>
                    </element-create-as-parent>

                </element>
            </element>


        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">2</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="DASHBOARD_alarms"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


    <connector type="SQLConnector">
        <parameter name="driver">com.mysql.jdbc.Driver</parameter>
        <parameter name="url" eval="property('ROD.db.url')"/>
        <parameter name="username" eval="property('ROD.db.username')"/>
        <parameter name="password" eval="property('ROD.db.password')"/>
        <parameter name="query">
            SELECT * from rod_nagios_problem
        </parameter>
    </connector>

    <processors>

        <element in="result" out="e:entries">
            <element in="row" out="e:entries">
                <element-ignore>
                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                </element-ignore>
                <element-create>entry('endpoint',concat(../host_name/text(),'__',../service/text()))</element-create>
            </element>
        </element>



        <element in="e:entries">
            <set variable="probeList">view('DASHBOARD_probes_list')/e:entries</set>

                <element in="e:entries">
                    <element-create>
                        entry('in_production',
                        choose(substring(../e:entry[@key='flags']/text(),4,1)!='',substring(../e:entry[@key='flags']/text(),4,1),-1))
                    </element-create>
                    <element-create>
                        entry('monitored',
                        choose(substring(../e:entry[@key='flags']/text(),3,1)!='',substring(../e:entry[@key='flags']/text(),3,1),-1))
                    </element-create>
                    <element-create>$probeList/e:entry[@name=current()/../e:entry[@key='test_name']/text()]</element-create>
                    <element-create if="contains(../e:entry[@key='summary']/text(),'egi.eu.lowAvailability')">$probeList/e:entry[@name='egi.eu.lowAvailability']</element-create>
                </element>
        </element>

        <element in="e:entries">
            <element in="e:entries">
                <element-create-as-parent out="e:entries" attributes="new_attribute('key','profiles')">
                    <element in="e:entry" if="@profile">
                        <attribute-ignore/>
                        <text-create>../@profile</text-create>
                    </element>
                </element-create-as-parent>

            </element>
        </element>


    </processors>

    <cache type="FileCache">
        <trigger type="DeltaTimeTrigger">
            <parameter name="minutes">1</parameter>
        </trigger>
        <trigger type="ViewNotifiedTrigger"/>
        <trigger type="ViewCreatedTrigger"/>
    </cache>

    <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="contentType">text/xml</parameter>
        </renderer>
    </renderers>
</view>





    <view name="DASHBOARD_alarms_filter"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">


        <argument name="SitesListFormatted">_1_</argument>
        <argument name="statusListFormatted">_2_</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="view('DASHBOARD_alarms')"/>
        </connector>

        <processors>
            <element in="e:entries">
                <attribute-create out="sites">$SitesListFormatted</attribute-create>
                <attribute-create out="status">$statusListFormatted</attribute-create>
            </element>

            <element in="e:entries" if="$SitesListFormatted!='_1_'">
                <element-ignore in="e:entries" if="not(contains($SitesListFormatted,concat(',',e:entry[@key='site']/text(),',')))"/>
            </element>


            <element in="e:entries" if="$statusListFormatted!='_2_'">
                <element-ignore in="e:entries" if="not(contains($statusListFormatted,concat(',',e:entry[@key='status']/text(),',')))"/>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="key">../e:entry[@key='id']/text()</attribute-create>
                </element>

            </element>
        </processors>

    </view>

    <view name="DASHBOARD_alarms_sec_filter"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" authenticators="local">


        <argument name="SitesListFormatted">_1_</argument>
        <argument name="statusListFormatted">_2_</argument>



        <connector type="XMLConnector">
            <parameter name="content" eval="view('DASHBOARD_alarms_sec')"/>
        </connector>

        <processors>


            <element in="e:entries" if="$SitesListFormatted!='_1_'">
                <element-ignore in="e:entries" if="not(contains($SitesListFormatted,concat(',',e:entry[@key='site']/text(),',')))"/>
            </element>


            <element in="e:entries" if="$statusListFormatted!='_2_'">
                <element-ignore in="e:entries" if="not(contains($statusListFormatted,concat(',',e:entry[@key='status']/text(),',')))"/>
            </element>



            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="key">../e:entry[@key='id']/text()</attribute-create>
                </element>

            </element>
        </processors>

    </view>

    <view name="DASHBOARD_ALARMS-L"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="ListID">024341cb-33e9-11e8-b58b-1418776844f0,031d8565-33e9-11e8-b58b-1418776844f0</argument>
        <variable name="ListIDFormatted" eval="concat(',',$ListID,',')"/>



        <connector type="XMLConnector">

            <parameter name="content" eval="view('DASHBOARD_alarms')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <element-ignore in="e:entries" if="not(contains($ListIDFormatted,concat(',',e:entry[@key='id']/text(),',')))"/>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="DASHBOARD_sites"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">
                <element in="SITE" out="e:entries">
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore/>

                    <element-create>entry('PRIMARY_KEY',../PRIMARY_KEY/text())</element-create>
                    <element-create>entry('NAME',../SHORT_NAME/text())</element-create>
                    <element-create>entry('NGI',../ROC/text())</element-create>
                    <element-create>entry('COUNTRY',../COUNTRY_CODE/text())</element-create>
                    <element-create>entry('PRODUCTION_INFRASTRUCTURE',../PRODUCTION_INFRASTRUCTURE/text())</element-create>
                    <element-create>entry('CERTIFICATION_STATUS',../CERTIFICATION_STATUS/text())</element-create>
                    <element-create>entry('LINK',join(../GOCDB_PORTAL_URL/text(),''))</element-create>
                    <element-ignore/>
                </element>

            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>





    <view name="DASHBOARD_AV_RE"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="summary">_summary_</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_AR_SITES')"/>
        </connector>

        <processors>

           <!-- </root/Profile/Site/Availability-->

            <element in="root" out="e:entries">

                <element-ignore in="Profile">
                    <element in="Site" out="e:entries" if="$summary='_summary_'">
                        <attribute in="site" out="key"/>
                        <element-create >entry('availability',choose(../@Availability_average,../@Availability_average,'N.A'))</element-create>
                        <element-create>entry('reliability',choose(../@Reliability_average,../@Reliability_average,'N.A'))</element-create>
                        <element-create>entry('unknown',choose(../@Unknown_average,../@Unknown_average,'N.A'))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="Site" out="e:entries" if="$summary!='_summary_'">
                            <attribute in="site" out="key"/>
                        <attribute-ignore/>
                            <element in="Availability" out="e:entries">
                                <attribute-ignore/>
                                <attribute-create out="key">choose(../@timestamp,../@timestamp,'N.A')</attribute-create>
                                <element-create >entry('availability',choose(../@availability,../@availability,'N.A'))</element-create>
                                <element-create>entry('reliability',choose(../@reliability,../@reliability,'N.A'))</element-create>
                                <element-create>entry('unknown',choose(../@unknown,../@unknown,'N.A'))</element-create>

                            </element>

                    </element>

                </element-ignore>
            </element>


        </processors>
    </view>


    <view name="DASHBOARD_TICKETS" xmlns:ns0="urn:GGUS_OPS"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="XMLConnector">
            <parameter name="content" eval="view('GGUS_OPS')"/>
        </connector>

        <processors>
            <element in="ns0:OpGetListOpsResponse" out="e:entries">

                <element in="ns0:getListValues" out="e:entries">

                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                    </element-ignore>
                </element>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="not(e:entry[@key='GHD_Affected_Site'])"/>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entry[@key='GHD_Problem_Type']/text()!='Operations'"/>
                <element-ignore in="e:entries" if="e:entry[@key='GHD_Status']/text()='verified'"/>
                <element in="e:entries">
                    <element-ignore in="e:entry" if="@key='GHD_Soap_Client_Data'">
                        <element-create>xml(../text())</element-create>
                    </element-ignore>

                </element>
            </element>

            <elements path="e:entries/e:entries/e:entries">
                <attribute-create out="key">'GHD_Soap_Client_Data'</attribute-create>
            </elements>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',22,5)"/>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="DASHBOARD_endpoints"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_service_endpoint')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>

            <element in="results" out="services">
                <element in="SERVICE_ENDPOINT" out="service">
                    <attribute-create out="in_production">choose(../IN_PRODUCTION/text()='Y','1','0')</attribute-create>
                    <attribute-create out="monitored">choose(../NODE_MONITORED/text()='Y','1','0')</attribute-create>
                    <attribute-create out="endpoint">concat(../HOSTNAME/text(),'__',../SERVICE_TYPE/text())</attribute-create>
                    <attribute-ignore/>
                    <element-ignore/>
                </element>
            </element>
    </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">26</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="DASHBOARD_VIEW"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" authenticators="local">

        <argument name="SitesList">egi</argument>
        <argument name="statusList">0,1,2,3</argument>
<!--        <argument name="profilesList">ARGO_MON_OPERATORS,MW_MONITOR,OPS_MONITOR</argument>-->
        <argument name="summary">_summary_</argument>



        <variable name="SitesListFormatted" eval="choose($SitesList!='egi',concat(',',$SitesList,','),'_1_')"/>

        <variable name="statusListFormatted" eval="concat(',',$statusList,',')"/>
<!--        <variable name="profilesListFormatted" eval="concat(',',$profilesList,',')"/>-->

        <connector type="XMLConnector">
            <parameter name="content" eval="view('DASHBOARD_sites')"/>
        </connector>

        <processors>

            <elements path="e:entries/e:entries">
                <element-create-as-parent out="e:entries" attributes="new_attribute('key','site')">
                    <element in="e:entry"/>
                </element-create-as-parent>
            </elements>

            <elements path="e:entries">
                <element in="e:entries" if="contains($SitesListFormatted,concat(',',@key,',')) or $SitesList='egi'">
                    <element-create>new_element('e:entries',new_attribute('key','alarms'))</element-create>

                    <element-create>new_element('e:entries',new_attribute('key','tickets'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','notepads'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','avre'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','downtimes'))</element-create>
                </element>
              <element-ignore/>
            </elements>

            <elements path="e:entries">
                <set variable="alarms">view('DASHBOARD_alarms_filter',entry('SitesListFormatted',$SitesListFormatted)|entry('statusListFormatted',$statusListFormatted))/e:entries</set>

                <set variable="avRe">view('DASHBOARD_AV_RE',entry('summary',$summary))/e:entries</set>
                <set variable="downtimes">view('OPSCORE_downtime_ongoing')/e:entries</set>
                <set variable="tickets">view('DASHBOARD_TICKETS')/e:entries</set>
                <set variable="notepads">view('DASHBOARD_notepads')/e:entries</set>

                <element in="e:entries">


                    <element in="e:entries" if="@key='alarms'">
                        <element-create>$alarms/e:entries[e:entry[@key='site']/text()=current()/../../@key]</element-create>
                    </element>





                    <element in="e:entries" if="@key='avre'">
                        <element-create>$avRe/e:entries[@key=current()/../../@key]/*</element-create>
                    </element>

                    <element in="e:entries" if="@key='downtimes'">
                        <element-create>$downtimes/e:entry[e:entry[@key='HOSTED_BY']/text()=current()/../../@key]</element-create>
                    </element>

                    <element in="e:entries" if="@key='tickets'">
                        <element-create>$tickets/e:entries[e:entry[@key='GHD_Affected_Site']/text()=current()/../../@key]</element-create>
                    </element>

                    <element in="e:entries" if="@key='notepads'">
                        <element-create>$notepads/e:entries[e:entry[@key='site']/text()=current()/../../@key]</element-create>
                    </element>

                </element>
            </elements>



            <element in="e:entries" if="$summary='_summary_'">

                <element in="e:entries">
                    <element in="e:entries" if="@key='alarms'">
                        <element-create>entry('nb_alarms_ok',count(../e:entries[e:entry[@key='status']/text()=0][e:entry[@key='ops_flags']/text()!=2]))</element-create>
                        <element-create>entry('nb_alarms_warning',count(../e:entries[e:entry[@key='status']/text()=1][e:entry[@key='ops_flags']/text()!=2]))</element-create>
                        <element-create>entry('nb_alarms_critical',count(../e:entries[e:entry[@key='status']/text()=2][e:entry[@key='ops_flags']/text()!=2]))</element-create>
                        <element-create>entry('nb_alarms_unknown',count(../e:entries[e:entry[@key='status']/text()=3][e:entry[@key='ops_flags']/text()!=2]))</element-create>
                        <element-create>entry('nb_alarms_assigned',count(../e:entries[e:entry[@key='ops_flags']/text()=2]))</element-create>
                        <element-ignore/>
                    </element>


                    <element in="e:entries" if="@key='tickets'">
                        <element-create>entry('nb_tickets',count(../e:entries))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="e:entries" if="@key='notepads'">
                        <element-create>entry('nb_notepads',count(../e:entries))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="e:entries" if="@key='downtimes'">
                        <element-create>entry('nb_downtimes',count(../e:entry))</element-create>
                        <element-ignore/>
                    </element>

                </element>


            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="DASHBOARD_VIEW_SEC"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" authenticators="local">

        <argument name="SitesList"></argument>

        <argument name="statusList">0,1</argument>
        <argument name="profilesList">ARGO_MON_OPERATORS,MW_MONITOR,OPS_MONITOR</argument>
        <argument name="summary">_summary_</argument>

        <argument name="FilterAssigned">false</argument>

        <variable name="SitesListFormatted" eval="choose($SitesList!='egi',concat(',',$SitesList,','),'_1_')"/>

        <variable name="statusListFormatted" eval="concat(',',$statusList,',')"/>
        <variable name="profilesListFormatted" eval="concat(',',$profilesList,',')"/>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('DASHBOARD_sites')"/>
        </connector>

        <processors>

            <elements path="e:entries/e:entries">
                <element-create-as-parent out="e:entries" attributes="new_attribute('key','site')">
                    <element in="e:entry"/>
                </element-create-as-parent>
            </elements>

            <elements path="e:entries">
                <element in="e:entries" if="contains($SitesListFormatted,concat(',',@key,',')) or $SitesList='egi'">
                    <element-create>new_element('e:entries',new_attribute('key','alarms'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','tickets'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','notepads'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','avre'))</element-create>
                    <element-create>new_element('e:entries',new_attribute('key','downtimes'))</element-create>
                </element>
                <element-ignore/>
            </elements>

            <elements path="e:entries">
                <set variable="alarms">view('DASHBOARD_alarms_sec_filter',entry('FilterAssigned',$FilterAssigned)|entry('SitesListFormatted',$SitesListFormatted)|entry('statusListFormatted',$statusListFormatted))/e:entries</set>
                <set variable="avRe">view('DASHBOARD_AV_RE',entry('summary',$summary))/e:entries</set>
                <set variable="downtimes">view('OPSCORE_downtime_ongoing')/e:entries</set>
                <set variable="tickets">view('DASHBOARD_TICKETS')/e:entries</set>
                <set variable="notepads">view('DASHBOARD_notepads')/e:entries</set>

                <element in="e:entries">


                    <element in="e:entries" if="@key='alarms'">
                        <element-create>$alarms/e:entries[e:entry[@key='site']/text()=current()/../../@key]</element-create>
                    </element>


                    <element in="e:entries" if="@key='avre'">
                        <element-create>$avRe/e:entries[@key=current()/../../@key]/*</element-create>
                    </element>

                    <element in="e:entries" if="@key='downtimes'">
                        <element-create>$downtimes/e:entry[e:entry[@key='HOSTED_BY']/text()=current()/../../@key]</element-create>
                    </element>

                    <element in="e:entries" if="@key='tickets'">
                        <element-create>$tickets/e:entries[e:entry[@key='GHD_Affected_Site']/text()=current()/../../@key]</element-create>
                    </element>

                    <element in="e:entries" if="@key='notepads'">
                        <element-create>$notepads/e:entries[e:entry[@key='site']/text()=current()/../../@key]</element-create>
                    </element>

                </element>
            </elements>



            <element in="e:entries" if="$summary='_summary_'">

                <element in="e:entries">
                    <element in="e:entries" if="@key='alarms'">
                        <element-create>entry('nb_alarms_ok',count(../e:entries[e:entry[@key='status']/text()=0]))</element-create>
                        <element-create>entry('nb_alarms_warning',count(../e:entries[e:entry[@key='status']/text()=1]))</element-create>
                        <element-create>entry('nb_alarms_critical',count(../e:entries[e:entry[@key='status']/text()=2]))</element-create>
                        <element-create>entry('nb_alarms_unknown',count(../e:entries[e:entry[@key='status']/text()=3]))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="e:entries" if="@key='tickets'">
                        <element-create>entry('nb_tickets',count(../e:entries))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="e:entries" if="@key='notepads'">
                        <element-create>entry('nb_notepads',count(../e:entries))</element-create>
                        <element-ignore/>
                    </element>

                    <element in="e:entries" if="@key='downtimes'">
                        <element-create>entry('nb_downtimes',count(../e:entry))</element-create>
                        <element-ignore/>
                    </element>

                </element>


            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="profiling">
        <argument name="view" path-format="value"/>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('configuration')"/>
        </connector>
        <processors xmlns:app="http://software.in2p3.fr/lavoisier/application.xsd" xmlns:plan="http://software.in2p3.fr/lavoisier/plan.xsd">
            <element-ignore in="app:views">
                <element in="app:view" if="@name=$view">
                    <element in="app:connector">
                        <element-ignore/>
                    </element>
                    <element in="app:serializer">
                        <element-ignore/>
                    </element>
                    <element in="app:validator">
                        <element-ignore/>
                    </element>
                    <element-ignore in="app:processors">
                        <element in="app:processor">
                            <element-ignore/>
                        </element>
                        <element in="plan:e">
                            <element-ignore/>
                        </element>
                        <element in="plan:create-parent">
                            <element-ignore/>
                        </element>
                        <element-ignore/>
                    </element-ignore>
                    <element-ignore/>
                </element>
                <element-ignore/>
            </element-ignore>
            <element in="app:view">
                <element>
                    <attribute-create out="nbsteps">count(../preceding-sibling::*) + 1</attribute-create>
                </element>
            </element>
            <element in="app:view">
                <element>
                    <text-create>view($view, arguments()|entry('nbsteps',../@nbsteps)|entry('_time_','true'))</text-create>
                </element>
            </element>
            <element in="app:view">
                <element in="app:connector"/>
                <element>
                    <text>number(.) - number(../preceding-sibling::*[1]/text())</text>
                </element>
            </element>
        </processors>
    </view>

</views>