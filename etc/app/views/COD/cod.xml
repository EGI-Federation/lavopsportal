<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">
    <!-- 
        Project : lavopsportal 
        File    : cod.xml.xml
        Created by cyril on 2018/06/18 
    -->

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="COD_ticket_alerts">

        <argument name="view">GGUS_ROD</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view($view)"/>
        </connector>

        <processors>
            <!-- arrange tickets tags -->
            <replace match="/e:entries/e:entries/e:entry[@key][text()]" nodes="new_element(@key,text())"/>

            <replace match="/e:entries/e:entries/e:entries/e:entry[@key][text()]" nodes="new_element(@key,text())"/>
            <replace match="/e:entries/e:entries/e:entries/e:entry[@key]" nodes="new_element(@key)"/>

            <rename match="/e:entries/e:entries/e:entries" name="GHD_Soap_Client_Data"/>

            <rename match="/e:entries/e:entries/GHD_Affected_Site" name="Site"/>
            <processor type="InsertProcessor" match="/e:entries/e:entries">
                <parameter name="nodes" eval="new_element('GenerationDate', view('UTC-now')/*/*/text())"/></processor>

            <rename match="/e:entries/e:entries/GHD_Request_ID" name="pk1"/>
            <insert match="/e:entries/e:entries" nodes="new_attribute('pk2', 'ggus_helpdesk_ops')"/>
            <merge match="/e:entries/e:entries/pk1"/>
            <merge match="/e:entries/e:entries"/>

            <!-- arrange root tags -->
            <rename match="/e:entries" name="Issues"/>
            <insert-parent match="/Issues" name="Data"/>
            <insert match="/Data" nodes="choose($view='GGUS_MW',new_attribute('history_table_name', 'CodTicketMWHistory'),new_attribute('history_table_name', 'CodTicketHistory'))"/>
            <insert match="/Data" nodes="choose($view='GGUS_MW',new_attribute('problem_table_name', 'CodTicketMWProblem'),new_attribute('problem_table_name', 'CodTicketProblem'))"/>

            <processor type="InsertProcessor" match="/Data">

                <parameter name="nodes" eval="new_attribute('global_date', view('UTC-now')/*)"/>
            </processor>

            <rename match="/Data/Issues/e:entries" name="Issue"/>
            <rename match="/Data/Issues/Issue/GHD_Create_Date" name="CreateDate"/>

            <remove match="/Data/Issues/Issue/GHD_Soap_Client_Data" depth="1"/>

            <remove match="/Data/Issues/Issue/GHD_Modified_Date"/>
            <remove match="/Data/Issues/Issue/GHD_Status"/>
            <remove match="/Data/Issues/Issue/GHD_Priority"/>
            <remove match="/Data/Issues/Issue/GHD_Last_Modifier"/>
            <remove match="/Data/Issues/Issue/GHD_Problem_Type"/>
            <remove match="/Data/Issues/Issue/GHD_Soap_Client_Data"/>
            <remove match="/Data/Issues/Issue/GHD_Subject"/>

            <!-- raise potential notifications -->

            <insert match="/Data/Issues/Issue/CreateDate[text()]">
                <connector type="XMLConnector">
                    <parameter name="content" eval="view('COD-alert-TicketOneMonth', entry('date',parent_match()/text()) )"/>

                </connector>
            </insert>

            <insert match="/Data/Issues/Issue/EndDate[text()]">
                <connector type="XMLConnector">
                    <parameter name="content" eval="view('COD-alert-TicketExpired', entry('date',parent_match()/text()))"/>
                </connector>
            </insert>

            <insert match="/Data/Issues/Issue[*]" nodes="
            new_element('EndDateStatus',EndDate/e:entries/e:entry/text())  |
            new_element('CreateDateStatus',CreateDate/e:entries/e:entry/text()) |
            new_element('UrlToHistory',concat(
                    property('portal.base_url'),
                    '/rodDashboard/ticket/',@pk1,
                    '/site/', Ngi/text(),
                    '/tab/details/tsid/',concat(Helpdesk/text(), '-', Workflow/text()),
                    '?page=details'))"/>

            <remove match="/Data/Issues/Issue/CreateDate/e:entries"/>
            <remove match="/Data/Issues/Issue/EndDate/e:entries"/>
            <remove match="/Data/Issues/Issue[CreateDateStatus/text()='0.0' and EndDateStatus/text()='0.0' ]"/>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">application/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="COD_MW_ticket_alerts">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('COD_ticket_alerts',entry('view','GGUS_MW'))"/>
        </connector>
    </view>


    <!-- Notification older than 72h -->
    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="COD_nagios_problem">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('COD.db.url')"/>
            <parameter name="username" eval="property('COD.db.username')"/>
            <parameter name="password" eval="property('COD.db.password')"/>
            <parameter name="query">SELECT id as pk1, site as Site , ngi as Ngi, start_date as StartDate,ops_flags as
                Flags from
                rod_nagios_problem where status!='0' and ops_flags &amp; 2 != 2
            </parameter>
        </connector>
        <processors>

            <rename match="/result/row" name="Issue"/>
            <rename match="/result" name="Issues"/>

            <insert-parent match="/Issues" name="Data"/>

            <insert match="/Data" nodes="new_attribute('problem_table_name', 'CodNagiosProblem')"/>
            <insert match="/Data" nodes="new_attribute('history_table_name', 'CodNagiosHistory')"/>

            <insert match="/Data/Issues/Issue[StartDate]" nodes="new_element('GenerationDate', StartDate/text())"/>

            <merge match="/Data/Issues/Issue/StartDate"/>
            <rename match="/Data/Issues/Issue/StartDate" name="Status"/>
            <insert match="/Data/Issues/Issue/Status[@StartDate][* or not(*)]">
                <connector type="XMLConnector">
                    <parameter name="content" eval="view('COD-alert-NagiosExpired', entry('date',parent_match()/@StartDate))"/>
                </connector>
            </insert>

            <processor type="InsertProcessor" match="/Data">

                <parameter name="nodes" eval="new_attribute('global_date', view('UTC-now')/*)"/>
            </processor>

            <merge match="/Data/Issues/Issue/pk1"/>

            <insert match="/Data/Issues/Issue" nodes="new_attribute('pk2', 'alarm_72')"/>
            <merge match="/Data/Issues/Issue"/>
            <remove match="/Data/Issues/Issue/Status/e:entries" depth="2"/>
            <remove match="/Data/Issues/Issue[Status='0.0']"/>
            <insert match="/Data/Issues/Issue" nodes="new_element('DetectionDate')"/>
            <insert match="/Data/Issues/Issue/DetectionDate" nodes="new_text(ancestor::Data/@global_date)"/>
            <remove match="/Data/Issues/Issue/Status/@StartDate"/>

            <insert match="/Data/Issues/Issue[*]" nodes=" new_element('UrlToHistory',concat(
                    property('portal.base_url'),
                    '/rodDashboard/issue/',@pk1,
                    '/related_site/', Site/text(),
                    '/tab/overview/page/issues'))"/>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">application/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="COD_Downtime">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('GOC.get_downtime.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <rename match="/results/DOWNTIME" name="Issue"/>
            <rename match="/results" name="Issues"/>

            <insert-parent match="/Issues" name="Data"/>

            <insert match="/Data" nodes="new_attribute('problem_table_name', 'CodDowntimeProblem')"/>
            <insert match="/Data" nodes="new_attribute('history_table_name', 'CodDowntimeHistory')"/>

            <remove match="/Data/Issues/Issue/@CLASSIFICATION"/>
            <rename match="/Data/Issues/Issue/@ID" name="pk1"/>
            <rename match="/Data/Issues/Issue/@PRIMARY_KEY" name="pk2"/>

            <insert match="/Data/Issues/Issue[*]" nodes="new_element('PRODUCTION',view('OPSCORE_endpoints')/results/e:entries[@key=match()/ENDPOINT/text()]/e:entry[@key='IN_PRODUCTION']/text())"/>

            <remove match="/Data/Issues/Issue[PRODUCTION/text()='N' or PRODUCTION/text()='']"/>
            <remove match="/Data/Issues/Issue[@pk2=following-sibling::Issue/@pk2]"/>
            <processor type="InsertProcessor" match="/Data">

                <parameter name="nodes" eval="new_attribute('global_date', view('UTC-now')/*)"/>
            </processor>

            <insert match="/Data/Issues/Issue[*]" nodes="view('COD_siteList')/results/SITE[SHORT_NAME/text()=match()/HOSTED_BY/text()]/ROC"/>
            <insert match="/Data/Issues/Issue[END_DATE/text() and START_DATE/text()]" nodes="new_element('Duration', round(number(END_DATE/text() - START_DATE/text()) div 86400))"/>
            <remove match="/Data/Issues/Issue[Duration/text() &lt; 30 ]"/>

            <processor type="InsertProcessor" match="/Data/Issues/Issue">
                <parameter name="nodes" eval="new_element('GenerationDate', view('UTC-now')/*/*/text())"/>
            </processor>

            <insert match="/Data/Issues/Issue[ROC]" nodes=" new_element('UrlToHistory',concat(
                    property('portal.base_url'),
                    '/rodDashboard/ngi/', ROC/text(),
                    '/tab/downtimes/filter/operators/page/downtimes'))"/>

        </processors>
        <!--  <cache type="FileCache">
              <trigger type="DeltaTimeTrigger">
                  <parameter name="minutes">4</parameter>
              </trigger>
              <trigger type="ViewNotifiedTrigger"/>
              <trigger type="DependencyRefreshedTrigger">
                  <parameter name="views">
                      <entry>OPSCORE_endpoints</entry>
                  </parameter>
              </trigger>
          </cache>-->
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">application/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="COD_siteList">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('GOG.get_site.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>
        <cache type="FileCache">

            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>


    <view name="COD_XML">



        <connector type="HTTPConnector">
            <parameter name="url" eval="property('COD.portal.metrics')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>


        <serializer type="HTMLSerializer"/>

        <processors>
            <processor match="//*" type="ChangeNamespaceProcessor"></processor>
        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT5M" type="ViewAccessedTrigger"/>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>



    </view>



    <view name="Cod_Metrics_Generation">



        <connector type="HTTPConnector">
            <parameter name="url" eval="property('COD.portal.metrics.generation')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <cache type="FileCache">

            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>

    </view>

    <view name="COD_CleanUP">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('COD.portal.clean.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">20</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>


</views>