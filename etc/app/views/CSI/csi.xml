<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >

<!--
    <view name="CSI_xii_Nagios">
       

        <variable name="base_url" eval="property('CSI.portal.url')"/>
        <variable name="collection">CsiNagiosRecords</variable>


        <connector type="XMLConnector">
            <parameter name="content"   eval="view('templateCrons',entry('base_url',$base_url)|entry('collection',$collection))"/>
        </connector>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
        </cache>

    </view>
-->

    <view authenticators="local"  name="CSI_Imports_Nagios">
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.nagios.import')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

<serializer type="HTMLSerializer"/>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
        </cache>
    </view>


    <view authenticators="local" name="CSITriggerCriticalIssues">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.notifications.critical')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <serializer type="HTMLSerializer"/>

        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">7</parameter>
            </trigger>
        </cache>

    </view>

    <view authenticators="local" name="CSITriggerWarningIssues">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.notifications.warning')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <serializer type="HTMLSerializer"/>
        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="day">monday</parameter>
                <parameter name="hour">7</parameter>
                <parameter name="minute">5</parameter>
            </trigger>
        </cache>

    </view>





    <view authenticators="local" name="CsiNagios">

        <connector type="HTTPConnector">
            <parameter name="url" eval="choose(property('env')!='prod',property('CSI.nagiosBoxUrlLavoisier'),property('CSI.nagiosBoxUrl'))"/>
            <parameter name="certificate" eval="property('certificate.sec.path')"/>
            <parameter name="passphrase" eval="property('certificate.sec.password')"/>
        </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">15</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>

    </view>

    <view name="CsiAlarmsImport" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagiosRecords')"/>
        </connector>

        <processors>
            <element in="Data">
                <attribute-ignore/>
                <element-ignore>
                    <element>
                        <element-ignore if="name()='wn' or name()='cod' or name()='current_state'"/>

                        <element in="service_description" out="service"/>
                        <element in="plugin_output" out="summary"/>
                        <element in="last_hard_state" out="status"/>
                        <element in="GenerationDate" out="start_date"/>
                        <element in="urltohelp" out="url_to_history"/>
                        <element-create>new_element('test_name',../service_description/text())</element-create>

                    </element>
                </element-ignore>
            </element>

            <element in="Data" out="e:entries">

                    <element out="e:entries">
                        <attribute-ignore/>
                        <attribute-create out="key">concat(../@pk1,'___',../@pk2)</attribute-create>
                        <element-ignore>
                            <element-create if="name(..)!='long_plugin_output' and ../text()!=''">entry(name(..),../text())</element-create>
                            <element-create if="name(..)='long_plugin_output' and ../text()!=''">
                               entry('details',concat('<![CDATA[',../text(),']]>'))
                            </element-create>
                            <element-create if="name(..)='long_plugin_output' and ../text()=''">
                                entry('details','no Details')</element-create>
                            <element-create if="../text()=''">entry(name(..),' ')</element-create>
                        </element-ignore>
                    </element>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view authenticators="local" name="CsiNagiosRecords"  xmlns:str="http://exslt.org/strings"  xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagios')"/>
        </connector>
        <processors>

                <processor match="/nagios" type="RenameProcessor"><parameter name="node_name">Data</parameter></processor>
                <processor match="/Data" type="InsertProcessor"><parameter name="nodes" eval="new_attribute('problem_table_name','CsiNagiosProblem')|new_attribute('history_table_name','CsiNagiosHistory')"/></processor>
                <processor match="/Data/servicestatus" type="RenameProcessor"><parameter name="node_name">Issue</parameter></processor>

                <processor match="/Data/Issue[*]" type="SelectGroupByProcessor"><parameter name="group_by" eval="last_hard_state/@value"/></processor>

            <processor match="/Data/e:entry[@key=0]" type="RenameProcessor"><parameter name="node_name">Recoveries</parameter></processor>
            <processor match="/Data/e:entry" type="InsertParentProcessor"><parameter name="node_name">e:Issues</parameter></processor>
            <processor match="/Data/e:Issues/e:entry" type="RemoveProcessor"><parameter name="depth">1</parameter></processor>
            <processor match="//*" type="ChangeNamespaceProcessor"/>

            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('site',substring-after(_SITE_NAME/@value,';'))"/></processor>
            <processor match="/Data/*/Issue/*[@value]" type="InsertProcessor"><parameter name="nodes" eval="new_text(@value)"/></processor>
            <processor match="/Data/*/Issue/_SITE_NAME" type="RemoveProcessor"/>




            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="view('CsiNagiosProbes')/probe_descriptions/services/service[@name=match()/service_description/text()]"/></processor>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('friendly_name',new_text(choose(service/@friendly_name,service/@friendly_name,service_description/text())))"/></processor>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('description',new_text(choose(service/@description,service/@description,'No description available')))"/></processor>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('urltohelp',new_text(choose(service/@url,service/@url,'https://wiki.egi.eu/wiki/EGI_CSIRT:SMG#Monitoring_probe')))"/></processor>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('cod',new_text(choose(service/@cod,service/@cod,'false')))"/></processor>
            <processor match="/Data/*/Issue[not(service)]" type="RemoveProcessor"/>
            <processor match="/Data/*/Issue/service" type="RemoveProcessor"/>
            <processor match="/Data/*/Issue/*/@value" type="RemoveProcessor"/>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('GenerationDate',new_text(substring(str:replace(date:add('1970-01-01T00:00:00Z', date:duration(last_check/text())),'T',' '),1,19)))"/></processor>
            <processor match="/Data/*/Issue[*]" type="InsertProcessor"><parameter name="nodes" eval="new_element('ngi',new_text(view('OPSCORE_prod_entities')/NGIs/NGI[Sites/Site/@name=match()/site/text()]/@name))"/></processor>
            <processor match="/Data/*/Issue/ngi[text()='']" type="ReplaceProcessor"><parameter name="nodes" eval="new_element('ngi',new_text('Unknown'))"/></processor>
            <processor match="/Data" type="InsertProcessor"><parameter name="nodes" eval="new_attribute('global_date',str:replace(substring(date:add(date:date-time(),concat('-PT',substring(date:date-time(),21,2),'H')),1,19),'T',' '))"/></processor>
            <!--
             const DEFAULT_SUPPORT_URL = 'https://wiki.egi.eu/wiki/MW_Nagios_tests';
        const DEFAULT_DESCRIPTION = 'No description available';
        const BASE_SUPPORT_URL    = 'https://bugzilla.redhat.com/show_bug.cgi?id=';
        const DEFAULT_SUPPORT_URL = 'https://wiki.egi.eu/wiki/EGI_CSIRT:SMG#Monitoring_probes';
            -->

            <element in="Data">
                <element>
                    <element in="Issue" if="contains(plugin_output/text(),'Pakiti-Vuln')">
                        <element-create as="first-child">new_element('wn',substring-before(substring-after(../plugin_output/text(),' - '),':'))</element-create>
                    </element>
                    <element in="Issue" if="not(contains(plugin_output/text(),'Pakiti-Vuln'))">
                        <element-create as="first-child">new_element('wn',substring-before(../plugin_output/text(),': '))</element-create>
                    </element>
                </element>
            </element>

            <element in="Data">
                <element>
                    <element in="Issue">
                        <element in="plugin_output">
                            <text-ignore/>
                            <text-create>choose(../../wn/text()!='',concat(../../wn/text(),'****',../text()),../text())</text-create>
                        </element>
                        <element in="long_plugin_output">
                            <text-ignore/>
                            <text-create>choose(../../wn/text()!='',concat(../../wn/text(),'****',../text()),../text())</text-create>
                        </element>
                    </element>
                </element>
            </element>

            <element in="Data">
                <element>
                    <element in="Issue">
                    <attribute-create out="pk1">choose(../service_description/text()!='',../service_description/text(),'__service')</attribute-create>
                    <attribute-create out="pk2">choose(../host_name/text()!='',../host_name/text(),'__hostname')</attribute-create>
                    </element>
                </element>
            </element>
        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>



    </view>



    <view authenticators="local" name="CsiNagiosProbes">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.NagiosProbes')"/>
            <parameter name="certificate" eval="property('certificate.sec.path')"/>
            <parameter name="passphrase" eval="property('certificate.sec.password')"/>
        </connector>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">15</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>


    </view>


    <view authenticators="local" name="CSI_CleanUP">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.clean.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>


    <view  authenticators="local" name="VoSecurityContacts">
        <argument name="serial">83</argument>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('VO.db.url')"/>
            <parameter name="username" eval="property('VO.db.username')"/>
            <parameter name="password" eval="property('VO.db.password')"/>
            <parameter name="query">
                <entry>SELECT security_contact_mailing_list, id, serial , insert_date FROM vo_mailing_list where validated=1 and serial=</entry>
                <entry eval="$serial"/>
                <entry> order by insert_date desc</entry>
                <entry> limit 1;</entry>
            </parameter>
        </connector>
        <processors>
            <element in="result">
                <attribute-create out="vo_security_emails">../row/security_contact_mailing_list/text()</attribute-create>
                <element-ignore/>
            </element>
        </processors>
    </view>
    <view  authenticators="local" name="VoContacts">
        <argument name="serial">4</argument>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('VO.db.url')"/>
            <parameter name="username" eval="property('VO.db.username')"/>
            <parameter name="password" eval="property('VO.db.password')"/>
            <parameter name="query">
                <entry>SELECT vc.email  FROM vo_contact_has_profile as vch , vo_contacts as vc where vch.user_profile_id=1 and vch.vo_contact_id=vc.id and vch.serial=</entry>
                <entry eval="$serial"/>
            </parameter>

        </connector>

        <processors>
            <element in="result">
                <attribute-create out="vo_managers_emails">join(../row/email/text(),',')</attribute-create>
                <element-ignore/>
            </element>
        </processors>
    </view>


    <view  authenticators="local" name="CSI_VOContacts_List"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
       <connector type="XMLConnector">
           <parameter name="content" eval="view('VoList')">
           </parameter>
       </connector>

        <processors>

            <element in="data" out="e:entries">

                <element in="Vo" out="e:entries" if="@status='Production'">
                    <attribute in="name" out="key"/>
                    <attribute-ignore/>

                    <element-create>entry('vo_security_emails',new_text(view('VoSecurityContacts',entry('serial',current()/../@serial))/result/@vo_security_emails))</element-create>
                    <element-create>entry('vo_manager_emails',new_text(view('VoContacts',entry('serial',current()/../@serial))/result/@vo_managers_emails))</element-create>
                    <element-create>entry('serial',../@serial)</element-create>
                </element>
                <element-ignore/>

            </element>

        </processors>




        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="csi_colors">
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="0">#5cb85c</entry>
                <entry key="1">#f29547</entry>
                <entry key="2">#d9534f</entry>
                <entry key="3">#5bc0de</entry>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="csi_status">
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="0">ok</entry>
                <entry key="1">warning</entry>
                <entry key="2">critical</entry>
                <entry key="3">unknown</entry>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewCreatedTrigger"/>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" authenticators="local"  xmlns:str="http://exslt.org/strings"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  name="reportcsiIssues">

        <argument name="status">critical</argument>
        <variable name="statusCode" eval="choose($status='critical',2,1)"/>

        <connector type="SQLConnector">
        <parameter name="driver">com.mysql.jdbc.Driver</parameter>
        <parameter name="url" eval="property('CSI.db.url')"/>
        <parameter name="username" eval="property('CSI.db.username')"/>
        <parameter name="password" eval="property('CSI.db.password')"/>
        <parameter name="query">
            <entry>SELECT * from csi_nagios_problem</entry>
            <entry> where status=</entry>
            <entry eval="$statusCode"/>
        </parameter>
        </connector>

        <processors>
            <element in="result" out="e:entries">
                <attribute-create out="count">count(../row)</attribute-create>
                <attribute-create out="status">$status</attribute-create>
                <element in="row" out="e:entries">
                    <attribute-create out="key">../id/text()</attribute-create>
                    <element in="id" out="e:entry">
                        <attribute-create out="key">'id'</attribute-create>
                    </element>
                    <element in="test_name" out="e:entry">
                        <attribute-create out="key">'test_name'</attribute-create>
                    </element>
                    <element in="host_name" out="e:entry">
                        <attribute-create out="key">'host_name'</attribute-create>
                    </element>
                    <element in="created_at" out="e:entry">
                        <attribute-create out="key">'created_at'</attribute-create>
                    </element>
                    <element in="site" out="e:entry">
                        <attribute-create out="key">'site'</attribute-create>
                    </element>
                    <element in="ngi" out="e:entry">
                        <attribute-create out="key">'ngi'</attribute-create>
                    </element>
                    <element in="id" out="e:entry">
                        <attribute-create out="key">'id'</attribute-create>
                    </element>
                    <element-ignore/>
                </element>

            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  authenticators="local" name="Csi_Issues_Complete">



        <argument name="date"/>
        <argument name="start_date" eval="concat($date,'T00:00:00+01:00')"/>
        <argument name="end_date" eval="date:add($start_date,'P1M')"/>

        <argument name="ngi">_NGI_</argument>



        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>SELECT * from csi_nagios_history_complete</entry>
                <entry> where (month(start_date)=month(</entry>
                <entry eval="quot($start_date)"/>
                <entry>)</entry>
                <entry> and </entry>
                <entry> year(start_date)=year(</entry>
                <entry eval="quot($start_date)"/>
                <entry>)) OR </entry>
                <entry> ( month(end_date)=month(</entry>
                <entry eval="quot($start_date)"/>
                <entry>) </entry>
                <entry> and </entry>
                <entry> year(end_date)=year(</entry>
                <entry eval="quot($start_date)"/>
                <entry>) )</entry>
            </parameter>
        </connector>


        <processors>
            <element in="result" out="e:entries">
                <set variable="csi_colors">view('csi_colors')</set>
                <set variable="csi_status">view('csi_status')</set>
                <element in="row" out="e:entries">
                    <attribute-create out="id">concat(../test_name/text(),'---',../host_name/text())</attribute-create>
                    <element-create>entry('start_date',choose(date:seconds(str:replace(../start_date/text(),' ','T'))-date:seconds($start_date) &lt; 0, $start_date,../start_date/text()))</element-create>
                    <element-create>entry('end_date',choose(date:seconds(str:replace(../end_date/text(),' ','T'))-date:seconds($end_date) &gt; 0, $end_date,../end_date/text()))</element-create>

                    <element-create>entry('exec_start_date',../start_date/text())</element-create>
                    <element-create>entry('exec_end_date',../end_date/text())</element-create>

                    <element-create>entry('duration',number(date:seconds(date:difference(str:replace(../start_date/text(),' ','T'),str:replace(../end_date/text(),' ','T')))) div 86400)</element-create>
                    <element-create>entry('test_name',../test_name/text())</element-create>
                    <element-create>entry('host_name',../host_name/text())</element-create>
                    <element-create>entry('status',new_text($csi_status/e:entries/e:entry[@key=current()/../status/text()]/text()))</element-create>
                    <element-create>entry('color',new_text($csi_colors/e:entries/e:entry[@key=current()/../status/text()]/text()))</element-create>
                    <element-create>entry('site',../site/text())</element-create>
                    <element-create>entry('ngi',../ngi/text())</element-create>

                    <element-ignore/>
                </element>



            </element>

            <element in="e:entries">
                <element in="e:entries">

                    <element in="e:entry" if="@key='start_date' ">
                        <text-ignore/>
                        <text-create>substring(str:replace(../text(),'T',' '),1,19)</text-create>
                    </element>
                    <element in="e:entry" if="@key='end_date'">
                        <text-ignore/>
                        <text-create>substring(str:replace(../text(),'T',' '),1,19)</text-create>
                    </element>

                </element>

            </element>

            <elements path="e:entries">
                <element in="e:entries" if="$ngi='_NGI_' or e:entry[@key='ngi']/text()=$ngi"/>
                <element-ignore/>
            </elements>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>
                    sort_by_string(../e:entries,'@id')
                </element-create>
            </element>

            <element in="e:entries">
                <element in="e:entries" if="following-sibling::e:entries/@id=current()/@id">
                    <element in="e:entry" if="@key='end_date'">
                        <text>../../following-sibling::e:entries/e:entry[@key='start_date']/text()</text>
                    </element>
                </element>
            </element>


        </processors>

        <pre-renderers><namespace prefix="date" uri="http://exslt.org/dates-and-times"/><namespace prefix="str" uri="http://exslt.org/strings"/>
            <row foreach="/e:entries/e:entries">
                <column label="start_date">e:entry[@key='exec_start_date']/text()</column>
                <column label="end_date">e:entry[@key='exec_end_date']/text()</column>
                <column label="test_name">e:entry[@key='test_name']/text()</column>
                <column label="host_name">e:entry[@key='host_name']/text()</column>

                <column label="status">e:entry[@key='status']/text()</column>
                <column label="ngi">e:entry[@key='ngi']/text()</column>
                <column label="site">e:entry[@key='site']/text()</column>
                <column label="duration (d)">e:entry[@key='duration']/text()</column>
            </row>
        </pre-renderers>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>


    </view>



</views>