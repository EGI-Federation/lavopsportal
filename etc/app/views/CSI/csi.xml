<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >

    <view name="CSI_Imports_Nagios">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_NGIs')"/>
        </connector>
        <processors>
            <element in="NGIs">
                <element in="NGI">
                    <attribute-ignore if="name()!='Name'"/>
                    <element-create>view('CSI_Import_Nagios',entry('ngi',../@Name))</element-create>
                </element>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">16</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>

    <view authenticators="local"  name="CSI_Import_Nagios">
        <argument name="ngi"/>
        <variable name="url" eval="concat(property('CSI.nagios.import'),'/',$ngi)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <fallback eval="new_element('exception',new_text(concat('exception for url ',$url)))">
                <exception type="java.io.IOException"/>
                <exception type="java.net.NoRouteToHostException"/>
                <exception type="java.io.FileNotFoundException"/>
                <exception type="java.lang.Exception"/>
                <exception type="java.net.SocketTimeoutException"/>
                <exception type="java.net.UnknownHostException"/>
                <exception type="java.net.SocketException"/>
                <exception type="java.lang.NullPointerException"/>
            </fallback>
        </connector>
    </view>


    <view authenticators="local" name="CSITriggerCriticalIssues">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.notifications.critical')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">400</parameter>
            <parameter name="read-timeout">500</parameter>
        </connector>

        <serializer type="HTMLSerializer"/>

        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">7</parameter>
            </trigger>
        </cache>

    </view>

    <view authenticators="local" name="CSITriggerWarningIssues">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.notifications.warning')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">400</parameter>
            <parameter name="read-timeout">500</parameter>
        </connector>
        <serializer type="HTMLSerializer"/>
        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="day">monday</parameter>
                <parameter name="hour">7</parameter>
                <parameter name="minute">5</parameter>
            </trigger>
        </cache>

    </view>


    <view name="CsiNagiosDB" authenticators="local">
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>SELECT * from csi_nagios_problem</entry>
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

    </view>




    <view authenticators="local" name="CsiNagios"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times">

        <connector type="HTTPConnector">
            <parameter name="url" eval="choose(property('env')='prod',property('CSI.nagiosBoxUrl'),property('CSI.nagiosBoxUrlLavoisier'))"/>
            <parameter name="certificate" eval="property('certificate.sec.path')"/>
            <parameter name="passphrase" eval="property('certificate.sec.password')"/>
        </connector>

        <processors>

            <element in="nagios">
                <element-ignore in="servicestatus" if="not(service_description/text())"></element-ignore>
                <element-ignore in="servicestatus" if="not(last_hard_state/@value)"></element-ignore>
                <element-ignore in="hoststatus"></element-ignore>
            </element>

            <element in="nagios">
                <set variable="CsiNagiosProbes" >view('CsiNagiosProbes')/probe_descriptions/services</set>
                <element-ignore in="servicestatus" if="not($CsiNagiosProbes/service[@name=current()/service_description/text()])"></element-ignore>
            </element>

            <element in="nagios">
                <set variable="OPSCORE_host_service" index="e:entry[@key='hostname']/text()">uniq(view('OPSCORE_host_service')/e:entries/e:entries,"e:entry[@key='hostname']/text()")</set>
                <element in="servicestatus" >
                    <element in="_SITE_NAME"  out="site">
                        <attribute-ignore/>
                        <text-create>substring-after(../@value,"0;")</text-create>
                    </element>
                    <element-create if="not(_SITE_NAME)">new_element('site',new_text(find($OPSCORE_host_service,../host_name/text())/e:entry[@key='site']/text()))</element-create>
                </element>
            </element>

            <element in="nagios">
                <set variable="OPSCORE_sites_info" index="@key">uniq(view('OPSCORE_sites_info')/e:entries/e:entries,"@key")</set>
                <element in="servicestatus" >
                     <element-create>new_element('ngi',new_text(find($OPSCORE_sites_info,../site/text())/e:entry[@key='NGI']/text()))</element-create>
                    <element in="site">
                        <attribute-create out="production">find($OPSCORE_sites_info,../text())/e:entry[@key='PRODUCTION']/text()</attribute-create>
                        <attribute-create out="certified">find($OPSCORE_sites_info,../text())/e:entry[@key='CERTIFIED']/text()</attribute-create>
                    </element>
                </element>
            </element>

            <element in="nagios">
                <element in="servicestatus" if="site/@production=1 and site/@certified=1"/>
                <element-ignore/>

            </element>


            <element in="nagios">
                <element in="servicestatus" if="not(plugin_output)">
                    <element-create>new_element('plugin_output',new_text('No summary available'))</element-create>
                </element>
            </element>

            <element in="nagios">
                <element in="servicestatus" if="not(long_plugin_output)">
                    <element-create>new_element('long_plugin_output',new_text('No details available'))</element-create>
                </element>
            </element>


            <element in="nagios">
                <element in="servicestatus">
                    <element in="last_check">
                        <text-create>../@value</text-create>
                    </element>
                </element>
            </element>

            <element in="nagios">
                <element in="servicestatus">
                    <element in="last_check">
                        <text if=".=0 or .=''">date:seconds()</text>
                    </element>
                </element>
            </element>


        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">15</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view authenticators="local" name="CsiNagiosCritical"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagios')"/>
        </connector>

        <processors>
            <element in="nagios">
               <element-ignore in="servicestatus" if="last_hard_state/@value!=2"></element-ignore>
            </element>


        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="CsiAlarmsImport" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">


        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagiosRecords')"/>
        </connector>

        <processors>
            <element in="Data">
                <attribute-ignore/>
                <element-ignore>
                    <element>
                        <element-ignore if="name()='wn' or name()='cod' or name()='current_state'"/>
                        <element in="service_description" out="service"/>
                        <element in="plugin_output" out="summary"/>
                        <element in="last_hard_state" out="status"/>
                        <element in="GenerationDate" out="start_date"/>
                        <element in="urltohelp" out="url_to_history"/>
                        <element-create>new_element('test_name',../service_description/text())</element-create>
                    </element>
                </element-ignore>
            </element>


            <element in="Data" out="e:entries">
                    <element out="e:entries">
                        <attribute-ignore/>
                        <attribute-create out="key">concat(../@pk1,'___',../@pk2)</attribute-create>
                        <element-ignore>
                            <element-create if="name(..)!='long_plugin_output' and ../text()!=''">entry(name(..),../text())</element-create>
                            <element-create if="name(..)='long_plugin_output' and ../text()!=''">
                               entry('details',concat('<![CDATA[',../text(),']]>'))
                            </element-create>
                            <element-create if="name(..)='long_plugin_output' and ../text()=''">
                                entry('details','no Details')</element-create>
                            <element-create if="../text()=''">entry(name(..),' ')</element-create>
                        </element-ignore>
                    </element>
            </element>



            <element in="e:entries">
                <element out="e:entries">
                    <element-create  if="not(../e:entry[@key='summary'])">entry('summary','summary is not available')</element-create>
                </element>
            </element>

            <element in="e:entries">
                <set variable="nagiosDB" index="id/text()">view('CsiNagiosDB')/result/row</set>

                <element out="e:entries">
                    <set variable="record">find($nagiosDB,@key)</set>
                    <attribute-create out="record">$record/id/text()</attribute-create>
                    <element-create if="$record/id/text()!='' and (not($record/summary/text()=current()/../e:entry[@key='summary']/text()))">entry('type','update record')</element-create>
                    <element-create if="$record/id/text()!='' and ($record/summary/text()=current()/../e:entry[@key='summary']/text())">entry('type','update date')</element-create>
                    <element-create if="$record/id/text()='' or not($record/id/text())">entry('type','insert')</element-create>

                </element>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view authenticators="local" name="CsiNagiosInsert"   xmlns:str="http://exslt.org/strings"  xmlns:date="http://exslt.org/dates-and-times">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagios')"/>
        </connector>

        <processors>
            <element in="nagios">
                <set variable="nagiosDB" index="id/text()">view('CsiNagiosDB')/result/row</set>

                <element in="servicestatus">
                    <set variable="record">find($nagiosDB,concat(service_description/text(),'___',host_name/text()))</set>
                    <attribute-create out="pk1">../service_description/text()</attribute-create>
                    <attribute-create out="pk2">../host_name/text()</attribute-create>
                    <attribute-create out="key">concat(../service_description/text(),'___',../host_name/text())</attribute-create>
                    <attribute-create out="record_id">$record/id/text()</attribute-create>
                </element>
            </element>

            <element in="nagios">
                <element-ignore in="servicestatus" if="@record_id!=''"></element-ignore>
            </element>

            <element in="nagios" out="Data">
                <set variable="CsiNagiosProbes" >view('CsiNagiosProbes')/probe_descriptions/services</set>

                <element in="servicestatus" out="Issue" if="$CsiNagiosProbes/service[@name=current()/service_description/text()]">
                    <element-create>new_element('friendly_name',new_text($CsiNagiosProbes/service[@name=current()/../service_description/text()]/@friendly_name))</element-create>
                    <element-create>new_element('description',new_text($CsiNagiosProbes/service[@name=current()/service_description/text()]/@description))</element-create>
                    <element-create>new_element('urltohelp','https://confluence.egi.eu/display/EGIBG/CSIRT+SMG')</element-create>
                    <element-create>new_element('cod','false')</element-create>
                </element>
                <element-ignore/>
            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view authenticators="local" name="CsiNagiosRecords"   xmlns:str="http://exslt.org/strings"  xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

    <connector type="XMLConnector">
        <parameter name="content" eval="view('CsiNagios')"/>
    </connector>
        <processors>

            <element in="nagios" out="Data">
                <set variable="CsiNagiosProbes" >view('CsiNagiosProbes')/probe_descriptions/services</set>

                        <element in="servicestatus" out="Issue" if="$CsiNagiosProbes/service[@name=current()/service_description/text()]">
                            <element-create>new_element('friendly_name',new_text($CsiNagiosProbes/service[@name=current()/../service_description/text()]/@friendly_name))</element-create>
                            <element-create>new_element('description',new_text($CsiNagiosProbes/service[@name=current()/service_description/text()]/@description))</element-create>
                            <element-create>new_element('urltohelp','https://wiki.egi.eu/wiki/EGI_CSIRT:SMG#Monitoring_probe')</element-create>
                            <element-create>new_element('cod','false')</element-create>
                        </element>
                        <element-ignore/>
            </element>

            <element in="Data">
<!--                <set variable="OPSCORE_host_service">view('OPSCORE_host_service')/e:entries</set>-->
                <attribute-create out="history_table_name">'CsiNagiosHistory'</attribute-create>
                <attribute-create out="problem_table_name">'CsiNagiosProblem'</attribute-create>
                <attribute-create out="global_date">str:replace(substring(date:add(date:date-time(),concat('-PT',substring(date:date-time(),21,2),'H')),1,19),'T',' ')</attribute-create>

               <element in="Issue">

                   <attribute-create out="pk1">../service_description/text()</attribute-create>
                   <attribute-create out="pk2">../host_name/text()</attribute-create>

                   <element in="current_state">
                       <attribute-ignore/>
                       <element-create>new_text(../@value)</element-create>
                   </element>
                   <element in="last_hard_state">
                       <attribute-ignore/>
                       <element-create if="../@value">new_text(../@value)</element-create>
                       <element-create if="not(../@value)">new_text('N/A')</element-create>

                   </element>


                   <element-create if="../last_check/text()!=''">
                       new_element('GenerationDate',new_text(substring(str:replace(date:add('1970-01-01T00:00:00Z', date:duration(../last_check/text())),'T',' '),1,19)))
                   </element-create>
                   <element-create as="first-child">new_element('wn')</element-create>
               </element>
            </element>

            <element in="Data">

                <element in="Issue">
                    <element in="wn">
                        <text-create if="contains(../plugin_output/text(),'Pakiti-Vuln')">
                            substring-before(substring-after(../../plugin_output/text(),' - '),':')
                        </text-create>
                        <text-create if="not(contains(../plugin_output/text(),'Pakiti-Vuln'))">
                            substring-before(../../plugin_output/text(),': ')
                        </text-create>
                    </element>

                </element>
            </element>

            <element in="Data">
                <element-ignore in="Issue"></element-ignore>
                <element-create>sort_by_string(../Issue,'last_hard_state/text()')</element-create>
            </element>

            <element in="Data">
                <element-create-as-parent out="Issues" attributes="new_attribute('status',last_hard_state/text())" group-by="last_hard_state/text()">
                    <element in="Issue"/>
                </element-create-as-parent>
            </element>
            <element in="Data">

                <element in="Issues" if="@status=0" out="Recoveries"/>
            </element>


            <element in="Data">
                <element>
                    <element in="Issue">
                        <element in="plugin_output">
                            <text-ignore/>
                            <text-create>choose(../../wn/text()!='',concat(../../wn/text(),'****',../text()),../text())</text-create>
                        </element>
                        <element in="long_plugin_output">
                            <text-ignore/>
                            <text-create>choose(../../wn/text()!='',concat(../../wn/text(),'****',../text()),../text())</text-create>
                        </element>
                    </element>
                </element>
            </element>
        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view authenticators="local" name="CsiNagiosProbes">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.NagiosProbes')"/>
            <parameter name="certificate" eval="property('certificate.sec.path')"/>
            <parameter name="passphrase" eval="property('certificate.sec.password')"/>
        </connector>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">15</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>


    </view>



    <view authenticators="local" name="CSI_CleanUP">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.portal.clean.url')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">400</parameter>
            <parameter name="read-timeout">500</parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>

    <view  authenticators="local" name="CsiDelete1" xmlns:date="http://exslt.org/dates-and-times">
        <variable name="last_update" eval="substring(date:add(date:date(),'-P8D'),0,11)"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>DELETE from csi_nagios_history where updated_at &lt; </entry>
                <entry eval="quot($last_update)"/>
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
        </cache>
    </view>

    <view  authenticators="local" name="CsiDelete2" xmlns:date="http://exslt.org/dates-and-times">
        <variable name="last_update" eval="substring(date:add(date:date(),'-P3D'),0,11)"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>DELETE from csi_nagios_problem where status='0' and updated_at &lt; </entry>
                <entry eval="quot($last_update)"/>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
        </cache>
    </view>
    <view  authenticators="local" name="CsiDelete3" xmlns:date="http://exslt.org/dates-and-times">
        <variable name="last_update" eval="substring(date:add(date:date(),'-P15D'),0,11)"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>DELETE from csi_nagios_problem where  updated_at &lt; </entry>
                <entry eval="quot($last_update)"/>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
        </cache>

    </view>



    <view  authenticators="local" name="VoSecurityContacts">
        <argument name="serial">83</argument>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('VO.db.url')"/>
            <parameter name="username" eval="property('VO.db.username')"/>
            <parameter name="password" eval="property('VO.db.password')"/>
            <parameter name="query">
                <entry>SELECT security_contact_mailing_list, id, serial , insert_date FROM vo_mailing_list where validated=1 and serial=</entry>
                <entry eval="$serial"/>
                <entry> order by insert_date desc</entry>
                <entry> limit 1;</entry>
            </parameter>
        </connector>
        <processors>
            <element in="result">
                <attribute-create out="vo_security_emails">../row/security_contact_mailing_list/text()</attribute-create>
                <element-ignore/>
            </element>
        </processors>
    </view>
    <view  authenticators="local" name="VoContacts">
        <argument name="serial">4</argument>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('VO.db.url')"/>
            <parameter name="username" eval="property('VO.db.username')"/>
            <parameter name="password" eval="property('VO.db.password')"/>
            <parameter name="query">
                <entry>SELECT vc.email  FROM vo_contact_has_profile as vch , vo_contacts as vc where vch.user_profile_id=1 and vch.vo_contact_id=vc.id and vch.serial=</entry>
                <entry eval="$serial"/>
            </parameter>

        </connector>

        <processors>
            <element in="result">
                <attribute-create out="vo_managers_emails">join(../row/email/text(),',')</attribute-create>
                <element-ignore/>
            </element>
        </processors>
    </view>


    <view  authenticators="local" name="CSI_VOContacts_List"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
       <connector type="XMLConnector">
           <parameter name="content" eval="view('VoList')">
           </parameter>
       </connector>

        <processors>

            <element in="data" out="e:entries">

                <element in="Vo" out="e:entries" if="@status='Production'">
                    <attribute in="name" out="key"/>
                    <attribute-ignore/>

                    <element-create>entry('vo_security_emails',new_text(view('VoSecurityContacts',entry('serial',current()/../@serial))/result/@vo_security_emails))</element-create>
                    <element-create>entry('vo_manager_emails',new_text(view('VoContacts',entry('serial',current()/../@serial))/result/@vo_managers_emails))</element-create>
                    <element-create>entry('serial',../@serial)</element-create>
                </element>
                <element-ignore/>

            </element>

        </processors>




        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="csi_colors">
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="0">#5cb85c</entry>
                <entry key="1">#f29547</entry>
                <entry key="2">#d9534f</entry>
                <entry key="3">#5bc0de</entry>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="csi_status">
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="0">ok</entry>
                <entry key="1">warning</entry>
                <entry key="2">critical</entry>
                <entry key="3">unknown</entry>
            </parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="ViewCreatedTrigger"/>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="listCVE" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
      <connector type="XMLConnector">
          <parameter name="content" eval="view('CVE-Pakiti')"/>
      </connector>

        <processors>
            <element in="CVEs" out="e:entries">
                <element-ignore in="Issue">
                    <element in="cve" out="e:entries">
                        <attribute-create out="site">ancestor::Issue/@site</attribute-create>
                    </element>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'text()')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" group-by="text()">
                    <element in="e:entries"></element>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <attribute in="global_date" out="key"/>
                <element in="e:entries">
                    <attribute-create out="key">../e:entries[1]/text()</attribute-create>
                    <element in="e:entries">
                        <attribute in="site" out="key"/>
                        <text-ignore/>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-ignore in="e:entries" if="@key=preceding-sibling::e:entries/@key"/>
                </element>
            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="CVE-Pakiti"  xmlns:regexp="http://exslt.org/regular-expressions">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('CsiNagiosRecords')"/>
        </connector>

        <processors>
            <element in="Data" out="CVEs">
                <attribute-ignore in="problem_table_name"/>
                <attribute-ignore in="history_table_name"/>

                <element-ignore in="Issues">
                    <element>
                        <attribute-create out="key">concat(../@pk1,'___',../@pk2)</attribute-create>
                        <attribute-create out="site">../site/text()</attribute-create>
                        <attribute-ignore/>
                    </element>
                </element-ignore>
                <element-ignore in="Recoveries"/>
            </element>

            <element in="CVEs">
                <element in="Issue" if="contains(plugin_output/text(),'cve-') or contains(long_plugin_output/text(),'cve-')">
                    <element-create if="contains(../plugin_output/text(),'cve-')">eval("new_element('cve',.)", regexp:match(../plugin_output/text(),'(cve-\d{4}-\d{4})', 'g'))</element-create>
                    <element-create if="contains(../long_plugin_output/text(),'cve-')">eval("new_element('cve',.)", regexp:match(../long_plugin_output/text(),'(cve-\d{4}-\d{4})', 'g'))</element-create>
                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="CSI.Pakiti.API" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd" xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <variable name="today" eval="substring(date:date(),0,11)"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.Pakiti.API')"></parameter>
            <parameter name="certificate" eval="property('certificate.sec.path')"/>
            <parameter name="passphrase" eval="property('certificate.sec.password')"/>
        </connector>
        <serializer type="CSVSerializer">
            <parameter name="header">false</parameter>
        </serializer>

        <processors>
            <element in="t:tables" out="e:entries">
                <attribute-create out="today">$today</attribute-create>
                <element-ignore in="t:table">
                    <element in="t:row" out="e:entries">
                        <element in="t:column" if="@label='1'" out="e:entry">
                            <attribute-create out="key">'tag'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='2'" out="e:entry">
                            <attribute-create out="key">'cve'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='3'" out="e:entry">
                            <attribute-create out="key">'site'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='4'" out="e:entry">
                            <attribute-create out="key">'host'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='5'" out="e:entry">
                            <attribute-create out="key">'os'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='6'" out="e:entry">
                            <attribute-create out="key">'arch'</attribute-create>
                        </element>
                        <element in="t:column" if="@label='7'" out="e:entry">
                            <attribute-create out="key">'last_report'</attribute-create>
                        </element>
                    </element>
                </element-ignore>


            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="not(starts-with(e:entry[@key='last_report']/text(),$today))"/>
            </element>

        </processors>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="goc.test">
        <connector type="HTTPConnector">
            <parameter name="url">https://goc.egi.eu/gocdbpi/private/?method=access_test</parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <serializer type="DeprecatedTextSerializer"></serializer>
    </view>


    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:regexp="http://exslt.org/regular-expressions"  authenticators="local" xmlns:str="http://exslt.org/strings"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  name="CSI_API">

<!--        tag - severity of CVE tagged in pakiti (eg EGI-Critical)-->
<!--        cve - CVE identificator-->
<!--        site - site name-->
<!--        host - host name-->
<!--        os - OS of host-->
<!--        arch - host architecture-->
<!--        last_report - time of last report from host-->
<!--        The default (without any parameter) would be to provide hosts vulnerable to critical issues detected over the past 48 hours (and not fixed in the meantime).-->

<!--        Having parameters allowing to customise the query may be handy:-->

<!--        history: customising the duration for checking the history of reports (default: 48 hours)-->
<!--        severity: configuring the severity of tagged CVE (egi EGI-High or EGI-Critical, default: EGI-Critical)-->
        <argument name="nbHours">48</argument>
        <argument name="severity">critical</argument>
        <argument name="cve">_cve_</argument>
        <argument name="test_name">_test_name_</argument>
        <argument name="site">_site_</argument>
        <argument name="ngi">_ngi_</argument>
        <argument name="format">_format_</argument>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>SELECT * from csi_nagios_problem</entry>
                <entry>where updated_at > now() - interval ? hour</entry>
                <entry > and status in (1,2,3)</entry>
            </parameter>
            <parameter name="parameters">
                <entry eval="$nbHours"/>
            </parameter>
        </connector>

        <processors>
        <element in="result" out="results">


            <element in="row" >
                <attribute-create out="key">../id/text()</attribute-create>
               

                <element in="updated_at" out="last_report" if="../ops_flags/text()=0">                   
                    <text>date:seconds(str:replace(substring(.,0,20),' ','T'))</text>
                </element>

                <element-create if="contains(../summary/text(),'cve-')">eval("new_element('cve',.)", regexp:match(../summary/text(),'(cve-\d{4}-\d{4})', 'g'))</element-create>

                <element-create if="contains(../summary/text(),'Pakiti-Vuln CRITICAL - ')">str:split(substring-after(substring-before(../summary/text(),'****Pakiti-Vuln'),'Pakiti-Vuln CRITICAL - '),', ')</element-create>

            </element>


        </element>

            <element in="results">
                <element in="row">
                    <attribute-ignore in="key"/>
                    <element in="token" if="count(preceding-sibling::token)=0" out="node"/>    
                    <element in="token" if="count(preceding-sibling::token)=1" out="arch"/>
                    <element in="token" if="count(preceding-sibling::token)=2" out="os"/>

                    <element in="summary" if="contains(.,'****')">
                        <text>substring-after(.,'****')</text>
                    </element>

                    <element-ignore if="name()='id' or name()='last_history_id' or name()='created_at' or name()='flags' or name()='ops_flags' or name()='url_to_history' or name()='service' or name()='start_date' or name()='end_date' or name()='details' "/>


                </element>
            </element>


            <element in="results" if="$test_name!='_test_name_'">
                <element-ignore in="row" if="test_name/text()!=$test_name"/>              
            </element>

            <element in="results" if="$cve!='_cve_'">
                <element-ignore in="row" if="not(cve/text()=$cve)"/>
            </element>

           
            <element in="results" if="$site!='_site_'">
                <element-ignore in="row" if="site/text()!=$site"/>
            </element>

            <element in="results" if="$ngi!='_ngi_'">
                <element-ignore in="row" if="ngi/text()!=$ngi"/>
            </element>

            <element in="results" if="$ngi!='_ngi_'">
                <element-ignore in="row" if="ngi/text()!=$ngi"/>
            </element>

            <element in="results" if="$severity!='all'">
                <element-ignore in="row" if="$severity='critical' and status/text()!=2"/>
            </element>

            <element in="results" if="$severity!='all'">
                <element-ignore in="row" if="$severity='warning' and status/text()!=1"/>
            </element>

            <element in="results" if="$severity!='all'">
                <element-ignore in="row" if="$severity='unknown' and status/text()!=3"/>
            </element>



            <element in="results">
                <attribute-create out="count">count(../row)</attribute-create>

                <element in="row" if="contains(summary/text(),': WARNING:')">
                    <element-create>new_element('node',substring-before(../summary/text(),': WARNING:'))</element-create>
                    <element in="summary" if="contains(text(),': WARNING:')">
                        <text>substring-after(.,': ')</text>
                    </element>
                </element>

                <element in="row" if="contains(summary/text(),': ERROR:')">
                    <element-create>new_element('node',substring-before(../summary/text(),': ERROR:'))</element-create>
                    <element in="summary" if="contains(text(),': ERROR:')">
                        <text>substring-after(.,': ')</text>
                    </element>
                </element>
            </element>

            <element in="results" if="$format!='csv'">
                <element in="row">
                    <element-create-as-parent out="cves">
                        <element in="cve"/>
                    </element-create-as-parent>
                </element>

            </element>



        </processors>

        <renderers>
            <renderer type="JSONRenderer">
                <parameter name="texts">
                    <entry>os</entry>
                    <entry>arch</entry>
                    <entry>last_report</entry>
                    <entry>tag</entry>
                    <entry>status</entry>
                    <entry>friendly_name</entry>
                    <entry>test_name</entry>
                    <entry>summary</entry>
                    <entry>site</entry>
                    <entry>ngi</entry>
                    <entry>host_name</entry>
                    <entry>cve</entry>
                </parameter>
                <parameter name="skip">2</parameter>
            </renderer>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" authenticators="local"  xmlns:str="http://exslt.org/strings"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  name="reportcsiIssues">

        <argument name="status">critical</argument>
        <variable name="statusCode" eval="choose($status='critical',2,1)"/>

        <connector type="SQLConnector">
        <parameter name="driver">com.mysql.jdbc.Driver</parameter>
        <parameter name="url" eval="property('CSI.db.url')"/>
        <parameter name="username" eval="property('CSI.db.username')"/>
        <parameter name="password" eval="property('CSI.db.password')"/>
        <parameter name="query">
            <entry>SELECT * from csi_nagios_problem</entry>
            <entry> where status=</entry>
            <entry eval="$statusCode"/>
        </parameter>
        </connector>

        <processors>
            <element in="result" out="e:entries">
                <attribute-create out="count">count(../row)</attribute-create>
                <attribute-create out="status">$status</attribute-create>
                <element in="row" out="e:entries">
                    <attribute-create out="key">../id/text()</attribute-create>
                    <element in="id" out="e:entry">
                        <attribute-create out="key">'id'</attribute-create>
                    </element>
                    <element in="test_name" out="e:entry">
                        <attribute-create out="key">'test_name'</attribute-create>
                    </element>
                    <element in="friendly_name" out="e:entry">
                        <attribute-create out="key">'friendly_name'</attribute-create>
                    </element>
                    <element in="host_name" out="e:entry">
                        <attribute-create out="key">'host_name'</attribute-create>
                    </element>
                    <element in="created_at" out="e:entry">
                        <attribute-create out="key">'created_at'</attribute-create>
                    </element>
                    <element in="site" out="e:entry">
                        <attribute-create out="key">'site'</attribute-create>
                    </element>
                    <element in="ngi" out="e:entry">
                        <attribute-create out="key">'ngi'</attribute-create>
                    </element>
                    <element in="id" out="e:entry">
                        <attribute-create out="key">'id'</attribute-create>
                    </element>
                    <element-ignore/>
                </element>
            </element>




            <element in="e:entries">
                <set variable="OPSCORE_sites_info" index="@key">uniq(view('OPSCORE_sites_info')/e:entries/e:entries,"@key")</set>
                <set variable="OPSCORE_downtime_ongoing">view('OPSCORE_downtime_ongoing')</set>
                <element in="e:entries">
                    <attribute-create out="production">find($OPSCORE_sites_info,../e:entry[@key='site']/text())/e:entry[@key='PRODUCTION']/text()</attribute-create>
                    <attribute-create out="certified">find($OPSCORE_sites_info,../e:entry[@key='site']/text())/e:entry[@key='CERTIFIED']/text()</attribute-create>
                    <attribute-create out="downtime_endpoints">str:concat($OPSCORE_downtime_ongoing/e:entries/e:entry[e:entry[@key='HOSTED_BY']/text()=current()/../e:entry[@key='site']/text()]/e:entries[@key='ENDPOINTS']/e:entry/text())</attribute-create>
                </element>
            </element>


            <element in="e:entries">
                <element in="e:entries" if="@downtime_endpoints!=''">
                    <attribute-ignore in="downtime_endpoints"/>
                    <attribute-create out="downtime">starts-with(../@downtime_endpoints,current()/../e:entry[@key='host_name']/text())</attribute-create>
                </element>
                <element in="e:entries" if="@downtime_endpoints=''">
                    <attribute-ignore in="downtime_endpoints"/>
                    <attribute-create out="downtime">0</attribute-create>
                </element>
            </element>



            <element in="e:entries">
                <element-ignore in="e:entries" if="@production!=1 or @certified!=1 or @downtime='true'"/>
            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  authenticators="local" name="Csi_Issues_Complete">



        <argument name="date"/>
        <argument name="start_date" eval="concat($date,'T00:00:00+01:00')"/>
        <argument name="end_date" eval="date:add($start_date,'P1M')"/>

        <argument name="ngi">_NGI_</argument>



        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('CSI.db.url')"/>
            <parameter name="username" eval="property('CSI.db.username')"/>
            <parameter name="password" eval="property('CSI.db.password')"/>
            <parameter name="query">
                <entry>SELECT * from csi_nagios_history_complete</entry>
                <entry> where (month(start_date)=month(</entry>
                <entry eval="quot($start_date)"/>
                <entry>)</entry>
                <entry> and </entry>
                <entry> year(start_date)=year(</entry>
                <entry eval="quot($start_date)"/>
                <entry>)) OR </entry>
                <entry> ( month(end_date)=month(</entry>
                <entry eval="quot($start_date)"/>
                <entry>) </entry>
                <entry> and </entry>
                <entry> year(end_date)=year(</entry>
                <entry eval="quot($start_date)"/>
                <entry>) )</entry>
            </parameter>
        </connector>


        <processors>
            <element in="result" out="e:entries">
                <set variable="csi_colors">view('csi_colors')</set>
                <set variable="csi_status">view('csi_status')</set>
                <element in="row" out="e:entries">
                    <attribute-create out="id">concat(../test_name/text(),'---',../host_name/text())</attribute-create>
                    <element-create>entry('start_date',choose(date:seconds(str:replace(../start_date/text(),' ','T'))-date:seconds($start_date) &lt; 0, $start_date,../start_date/text()))</element-create>
                    <element-create>entry('end_date',choose(date:seconds(str:replace(../end_date/text(),' ','T'))-date:seconds($end_date) &gt; 0, $end_date,../end_date/text()))</element-create>

                    <element-create>entry('exec_start_date',../start_date/text())</element-create>
                    <element-create>entry('exec_end_date',../end_date/text())</element-create>

                    <element-create>entry('duration',number(date:seconds(date:difference(str:replace(../start_date/text(),' ','T'),str:replace(../end_date/text(),' ','T')))) div 86400)</element-create>
                    <element-create>entry('test_name',../test_name/text())</element-create>
                    <element-create>entry('host_name',../host_name/text())</element-create>
                    <element-create>entry('status',new_text($csi_status/e:entries/e:entry[@key=current()/../status/text()]/text()))</element-create>
                    <element-create>entry('color',new_text($csi_colors/e:entries/e:entry[@key=current()/../status/text()]/text()))</element-create>
                    <element-create>entry('site',../site/text())</element-create>
                    <element-create>entry('ngi',../ngi/text())</element-create>

                    <element-ignore/>
                </element>



            </element>

            <element in="e:entries">
                <element in="e:entries">

                    <element in="e:entry" if="@key='start_date' ">
                        <text-ignore/>
                        <text-create>substring(str:replace(../text(),'T',' '),1,19)</text-create>
                    </element>
                    <element in="e:entry" if="@key='end_date'">
                        <text-ignore/>
                        <text-create>substring(str:replace(../text(),'T',' '),1,19)</text-create>
                    </element>

                </element>

            </element>

            <elements path="e:entries">
                <element in="e:entries" if="$ngi='_NGI_' or e:entry[@key='ngi']/text()=$ngi"/>
                <element-ignore/>
            </elements>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>
                    sort_by_string(../e:entries,'@id')
                </element-create>
            </element>

            <element in="e:entries">
                <element in="e:entries" if="following-sibling::e:entries/@id=current()/@id">
                    <element in="e:entry" if="@key='end_date'">
                        <text>../../following-sibling::e:entries/e:entry[@key='start_date']/text()</text>
                    </element>
                </element>
            </element>


        </processors>

        <pre-renderers><namespace prefix="date" uri="http://exslt.org/dates-and-times"/><namespace prefix="str" uri="http://exslt.org/strings"/>
            <row foreach="/e:entries/e:entries">
                <column label="start_date">e:entry[@key='exec_start_date']/text()</column>
                <column label="end_date">e:entry[@key='exec_end_date']/text()</column>
                <column label="test_name">e:entry[@key='test_name']/text()</column>
                <column label="host_name">e:entry[@key='host_name']/text()</column>

                <column label="status">e:entry[@key='status']/text()</column>
                <column label="ngi">e:entry[@key='ngi']/text()</column>
                <column label="site">e:entry[@key='site']/text()</column>
                <column label="duration (d)">e:entry[@key='duration']/text()</column>
            </row>
        </pre-renderers>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>


    </view>


    <view authenticators="local" name="CSI_CVE_imports">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('CSI.cves.imports')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">400</parameter>
            <parameter name="read-timeout">500</parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>

</views>