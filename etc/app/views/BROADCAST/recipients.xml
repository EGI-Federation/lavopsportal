<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - Generic mailing lists BRANCH-->
   <view name="gmRecipientsView">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">SELECT id, name as label, value as email FROM broadcast_mailing_lists WHERE
                scope='public' ORDER BY label
            </parameter>
        </connector>

        <processors>

            <element in="result" out="Recipients">
                <element in="row" out="Recipient"/>
            </element>




        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

    <view name="nmRecipientsView_egi">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_roc_contacts_egi')"/>
        </connector>
        <processors>


            <element in="results" out="Recipients">
                <element in="NGI" out="Recipient">
                    <attribute-ignore/>
                    <element in="NAME" out="label"/>
                    <element in="EMAIL" out="email"/>
                    <element-create>new_element('id',new_text(../@NAME))</element-create>
                    <element-ignore/>
                </element>
            </element>



            <elements path="Recipients" >
                <element-create>
                    sort_by_string(../Recipient,'id/text()')
                </element-create>
                <element-ignore/>
            </elements>

        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_ngi_contacts</entry>
                </parameter>
            </trigger>
        </cache>


    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - NGI Managers BRANCH-->
    <view name="nmRecipientsView">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_roc_contacts')"/>
        </connector>
        <processors>


            <element in="results" out="Recipients">
                <element in="ROC" out="Recipient">
                    <attribute-ignore/>
                    <element in="ROCNAME" out="label"/>
                    <element in="MAIL_CONTACT" out="email"/>
                    <element-create>new_element('id',new_text(../@ROC_NAME))</element-create>
                    <element-ignore/>
                </element>
            </element>



            <elements path="Recipients" >
                <element-create>
                    sort_by_string(../Recipient,'id/text()')
                </element-create>
                <element-ignore/>
            </elements>

        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_ngi_contacts</entry>
                </parameter>
            </trigger>
        </cache>


    </view>

    <!--Recipients - SOURCE FOR JSTREE VIEW - VO Managers BRANCH-->
    <view name="vmRecipientsViewBase">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                (SELECT v.serial as id, v.name as label, m.admins_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.admins_mailing_list IS NOT NULL
                AND NOT m.admins_mailing_list = ''
                AND m.id = (SELECT MAX(id) from vo_mailing_list m2 where m2.serial=m.serial)
                 )
                UNION
                (SELECT v.serial as id, v.name as label, c.email as email
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND p.profile = 'VO MANAGER'
                AND h.status_id = 2)
                ORDER BY label
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>


    <view name="vmRecipientsView" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('vmRecipientsViewBase')"/>
        </connector>

        <processors>



            <element in="result" out="Recipients">
                <element in="row" out="Recipient">
                    <element in="email" out="EMAIL"><text>concat(.,',')</text></element>
                    <element-ignore in="id"/>
                </element>
            </element>

            <element in="Recipients">
                <element-ignore in="Recipient"/>
                <element-create>sort_by_string(../Recipient,'label/text()')</element-create>
            </element>

            <element in="Recipients">
                <element-create-as-parent out="Recipient" group-by="label/text()">
                    <element in="Recipient"/>
                </element-create-as-parent>
            </element>

            <element in="Recipients">
                <element-ignore in="Recipient">
                    <element in="Recipient" if="count(preceding-sibling::Recipient)=0">
                        <element-create>new_element('email',str:concat(../../Recipient/EMAIL/text()))</element-create>
                        <element-create>new_element('id',str:replace(../label/text(),'.','_'))</element-create>
                        <element-ignore in="EMAIL"/>
                    </element>
                </element-ignore>
            </element>



        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>vmRecipientsViewBase</entry>
                </parameter>
            </trigger>
        </cache>

    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - VO Security BRANCH-->

    <view name="vsecRecipientsViewBase" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                (SELECT v.serial as id, v.name as label, m.security_contact_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.security_contact_mailing_list IS NOT NULL
                AND NOT m.security_contact_mailing_list = '')
                UNION
                (SELECT v.serial as id, v.name as label, c.email as email
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND p.profile = 'VO MANAGER'
                AND h.status_id = 2)
                ORDER BY label
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>

    <view name="vsecRecipientsView" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('vsecRecipientsViewBase')"/>
        </connector>

        <processors>



            <element in="result" out="Recipients">
                <element in="row" out="Recipient">
                    <element in="email" out="EMAIL"><text>concat(.,',')</text></element>
                    <element-ignore in="id"/>
                </element>
            </element>

            <element in="Recipients">
                <element-ignore in="Recipient"/>
                <element-create>sort_by_string(../Recipient,'label/text()')</element-create>
            </element>

            <element in="Recipients">
                <element-create-as-parent out="Recipient" group-by="label/text()">
                    <element in="Recipient"/>
                </element-create-as-parent>
            </element>

            <element in="Recipients">
                <element-ignore in="Recipient">
                    <element in="Recipient" if="count(preceding-sibling::Recipient)=0">
                        <element-create>new_element('email',str:concat(../../Recipient/EMAIL/text()))</element-create>
                        <element-create>new_element('id',str:replace(../label/text(),'.','_'))</element-create>
                        <element-ignore in="EMAIL"/>
                    </element>
                </element-ignore>
            </element>



        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - VO Users BRANCH-->
    <view name="vuRecipientsView" xmlns:str="http://exslt.org/strings">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                SELECT v.serial as id, v.name as label, m.users_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.id=v.mailing_list_id
                AND m.users_mailing_list IS NOT NULL
                AND NOT m.users_mailing_list = ''
                ORDER BY label
            </parameter>
        </connector>
        <processors>



            <elements path="result/row">
                <attribute-create out="id">str:replace(../id/text(),'.','_')</attribute-create>
                    </elements>

            <elements path="result">
                    <element-create-as-parent out="group" group-by="@id">
                        <element in="row">
                            <element in="email">
                                <text>concat(.,',')</text>
                            </element>
                        </element>

                    </element-create-as-parent>
            </elements>

            <element in="result" out="Recipients" >
                <element in="group" out="Recipient">
                    <attribute-create out="label">../row[1]/label</attribute-create>
                    <attribute-create out="id">str:replace(../row[1]/id,'.','_')</attribute-create>
                    <element-ignore in="row">
                        <element-ignore in="email">
                            <text/>
                        </element-ignore>

                    </element-ignore>

                </element>
            </element>

            <elements path="Recipients/Recipient">

                <attribute-ignore/>
                <element-create>new_element('label',new_text(../@label))</element-create>
                <element-create>new_element('id',str:replace(new_text(../@id),'.','_'))</element-create>
                <element-create>new_element('email',../text())</element-create>
                <text-ignore/>

            </elements>



        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>

        </cache>
    </view>

    <!--RECIPIENTS - Site Administrators BRANCH-->
    <view name="saRecipientsView">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>

            <elements path="NGIs/NGI/Sites">
                <element-ignore in="Site"/>
                <element-create>sort_by_string(../Site,'@name')</element-create>
            </elements>

            <element in="NGIs" out="Recipients">
                <element-ignore in="NGI">
                    <element-ignore in="Sites">
                        <element in="Site" out="Recipient" if="@production!=0 and  @certified!=0">
                            <attribute-ignore/>
                            <element-create>new_element('id', string(../@primary_key))</element-create>
                            <element-create>new_element('label', string(../@name))</element-create>
                            <element-create>new_element('email', string(../@contact_email))</element-create>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>
    </view>


    <!--RECIPIENTS - Site Administrators BRANCH-->
    <view name="saRecipientsView_egi">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities_egi')"/>
        </connector>
        <processors>

            <elements path="NGIs/NGI/Sites">
                <element-ignore in="Site"/>
                <element-create>sort_by_string(../Site,'@name')</element-create>
            </elements>

            <element in="NGIs" out="Recipients">
                <element-ignore in="NGI">
                    <element-ignore in="Sites">
                        <element in="Site" out="Recipient" if="@production!=0 and  @certified!=0">
                            <attribute-ignore/>
                            <element-create>new_element('id', string(../@primary_key))</element-create>
                            <element-create>new_element('label', string(../@name))</element-create>
                            <element-create>new_element('email', string(../@contact_email))</element-create>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities_egi</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
        </cache>
    </view>
    <!--RECIPIENTS - Site Administrators BRANCH -->
    <view name="ssecRecipientsView">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>

            <elements path="NGIs/NGI/Sites">
                <element-ignore in="Site"/>
                <element-create>sort_by_string(../Site,'@name')</element-create>
            </elements>

            <element in="NGIs" out="Recipients">
            <element-ignore in="NGI">
                <element-ignore in="Sites">
                    <element in="Site" out="Recipient" if="@production!=0 and  @certified!=0">
                        <attribute-ignore/>
                        <element-create>new_element('id', string(../@primary_key))</element-create>
                        <element-create>new_element('label', string(../@name))</element-create>
                        <element-create>new_element('email', string(../@csirt_email))</element-create>
                    </element>
                </element-ignore>
            </element-ignore>
            </element>


        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>
    </view>


    <view name="ssecRecipientsView_egi">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities_egi')"/>
        </connector>
        <processors>

            <elements path="NGIs/NGI/Sites">
                <element-ignore in="Site"/>
                <element-create>sort_by_string(../Site,'@name')</element-create>
            </elements>

            <element in="NGIs" out="Recipients">
                <element-ignore in="NGI">
                    <element-ignore in="Sites">
                        <element in="Site" out="Recipient" if="@production!=0 and  @certified!=0">
                            <attribute-ignore/>
                            <element-create>new_element('id', string(../@primary_key))</element-create>
                            <element-create>new_element('label', string(../@name))</element-create>
                            <element-create>new_element('email', string(../@csirt_email))</element-create>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>


        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities_egi</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>
    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - Operation Tools BRANCH-->
    <view name="otRecipientsView">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>

            <element in="NGIs" out="Recipients">
                <element in="NGI" if="@name='EGI.eu'">
                    <element-ignore in="Sites">
                        <element in="Site" out="Recipient">
                            <attribute-ignore/>
                            <element-create>new_element('id', string(../@primary_key))</element-create>
                            <element-create>new_element('label', string(../@name))</element-create>
                            <element-create>new_element('email', string(../@contact_email))</element-create>
                        </element>
                    </element-ignore>
                </element>
                <element-ignore/>

            </element>

        <element in="Recipients">
            <element-ignore in="NGI">
                <element/>
            </element-ignore>
        </element>


        </processors>
        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>


    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - User Contacts BRANCH-->
    <view name="ucRecipientsView">

        <argument name="user_id"/>

        <connector type="SQLConnector">

            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
            <entry>SELECT b.id, b.name as label, b.value as email
                FROM broadcast_mailing_lists b
                WHERE b.scope = 'private'
                AND user_id =
            </entry>
            <entry eval="quot($user_id)"/>
            <entry>ORDER BY label</entry>
        </parameter>

        </connector>

        <processors>

            <element in="result" out="Recipients">
                <element in="row" out="Recipient"/>
            </element>


        </processors>

    </view>



    <view name="vsRecipientsView"  xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('VoList')"/>
        </connector>
        <processors>

            <element in="data" out="Recipients">
                <set variable="VAPOR_VoSites">view('VAPOR_VoSites')</set>
                <element in="Vo" out="Recipient">
                    <attribute-ignore/>
                    <element-create>new_element('label',new_text(../@name))</element-create>
                    <element-create>new_element('id',new_text(../@name))</element-create>
                    <element-create>new_element('email',join($VAPOR_VoSites/e:entries/e:entries[e:entry/text()=current()/../@name]/@email,','))</element-create>
                </element>


            </element>




        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>


</views>