<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:str="http://exslt.org/strings" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:sf2="http://symfony.com/schema/dic/services" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" version="11">

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - Generic mailing lists BRANCH-->
   <view name="gmRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Generic Mailing List</description>
        </info>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">SELECT id, name as label, value as email FROM broadcast_mailing_lists WHERE
                scope='public' ORDER BY label
            </parameter>
        </connector>
        <processors>
            <rename match="/result/row" name="Recipient"/>
            <rename match="/result" name="Recipients"/>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>


    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - NGI Managers BRANCH-->
    <view name="nmRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>NGI Managers</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_roc_contacts')"/>
        </connector>
        <processors>
            <remove match="//CONTACT"/>
            <insert match="/results/ROC" nodes="new_element('label', string(@ROC_NAME))"/>

            <rename match="/results" name="Recipients"/>
            <rename match="//ROC" name="Recipient"/>
            <rename match="//ROCNAME" name="id"/>

            <rename match="//MAIL_CONTACT" name="email"/>

            <elements path="Recipients" >
                <element-create>
                    sort_by_string(../Recipient,'id/text()')
                </element-create>
                <element-ignore/>
            </elements>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_ngi_contacts</entry>
                </parameter>
            </trigger>
        </cache>


    </view>

    <!--Recipients - SOURCE FOR JSTREE VIEW - VO Managers BRANCH-->
    <view name="vmRecipientsViewBase">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Managers Base</description>
        </info>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                (SELECT v.serial as id, v.name as label, m.admins_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.admins_mailing_list IS NOT NULL
                AND NOT m.admins_mailing_list = ''
                AND m.id = (SELECT MAX(id) from vo_mailing_list m2 where m2.serial=m.serial)
                 )
                UNION
                (SELECT v.serial as id, v.name as label, c.email as email
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND p.profile = 'VO MANAGER'
                AND h.status_id = 2)
                ORDER BY label
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>


    <view name="vmRecipientsView" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Managers</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('vmRecipientsViewBase')"/>
        </connector>

        <processors>

            <merge match="/result/row/*"/>
            <merge match="/result/row"/>
            <merge match="/result/row"/>
            <merge match="/result/row"/>

            <select match="/result/row">
                <group by="@label" sort="text"/>

            </select>


            <replace match="/result/*/row/@email" nodes="concat(',',.)"/>
            <rename match="/result/e:entry" name="Recipient"/>
            <rename match="/result" name="Recipients"/>
            <insert match="/Recipients/Recipient[*]" nodes="new_element('id', str:replace(string(row[1]/@id),'.','_'))"/>
            <insert match="/Recipients/Recipient[*]" nodes="new_element('label', string(row[1]/@label))"/>
            <insert match="/Recipients/Recipient[*]" nodes="new_element('email', new_attribute('email',str:concat(row/@email))|new_text(str:concat(row/@email)))"/>

            <remove match="/Recipients/Recipient/row"/>



            <!--




            <replace match="/result/*/row/@email" nodes="concat(',',.)"/>

            <rename match="/result/e:entry" name="Recipient"/>
            <rename match="/result" name="Recipients"/>

            <insert match="/Recipients/Recipient" nodes="new_element('id', string(@key))"/>

            <insert match="/Recipients/Recipient[*]" nodes="new_element('label', string(row[1]/@label))"/>

            <insert match="/Recipients/Recipient[*]" nodes="new_element('email', new_attribute('email',str:concat(row/@email)))"/>

            <remove match="/Recipients/Recipient/row"/>

            -->


        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>vmRecipientsViewBase</entry>
                </parameter>
            </trigger>
        </cache>

    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - VO Security BRANCH-->

    <view name="vsecRecipientsViewBase" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Security COntact Base</description>
        </info>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                (SELECT v.serial as id, v.name as label, m.security_contact_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.security_contact_mailing_list IS NOT NULL
                AND NOT m.security_contact_mailing_list = '')
                UNION
                (SELECT v.serial as id, v.name as label, c.email as email
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND p.profile = 'VO MANAGER'
                AND h.status_id = 2)
                ORDER BY label
            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>

    <view name="vsecRecipientsView" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Managers</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('vsecRecipientsViewBase')"/>
        </connector>

        <processors>
            <merge match="/result/row/*"/>
            <merge match="/result/row"/>
            <merge match="/result/row"/>
            <merge match="/result/row"/>

            <select match="/result/row">
                <group by="@id" sort="number"/>

            </select>

            <replace match="/result/*/row/@email" nodes="concat(',',.)"/>

            <rename match="/result/e:entry" name="Recipient"/>
            <rename match="/result" name="Recipients"/>

            <insert match="/Recipients/Recipient" nodes="new_element('id', str:replace(string(@key),'.','_'))"/>

            <insert match="/Recipients/Recipient[*]" nodes="new_element('label', string(row[1]/@label))"/>

            <insert match="/Recipients/Recipient[*]" nodes="new_element('email', new_attribute('email',str:concat(row/@email))|new_text(str:concat(row/@email)))"/>


            <remove match="/Recipients/Recipient/row"/>

            <elements path="Recipients" >
                <element-create>
                    sort_by_string(../Recipient,'label/text()')
                </element-create>
                <element-ignore/>
            </elements>

        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>vmRecipientsViewBase</entry>
                </parameter>
            </trigger>
        </cache>

    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - VO Users BRANCH-->
    <view name="vuRecipientsView" xmlns:str="http://exslt.org/strings">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Users</description>
        </info>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
                SELECT v.serial as id, v.name as label, m.users_mailing_list as email
                FROM vo v, vo_header h, vo_mailing_list m
                WHERE v.header_id = h.id
                AND v.serial = m.serial
                AND h.status_id = 2
                AND m.users_mailing_list IS NOT NULL
                AND NOT m.users_mailing_list = ''
                ORDER BY label
            </parameter>
        </connector>
        <processors>



            <elements path="result/row">
                <attribute-create out="id">str:replace(../id/text(),'.','_')</attribute-create>
                    </elements>

            <elements path="result">
                    <element-create-as-parent out="group" group-by="@id">
                        <element in="row">
                            <element in="email">
                                <text>concat(.,',')</text>
                            </element>
                        </element>

                    </element-create-as-parent>
            </elements>

            <element in="result" out="Recipients" >
                <element in="group" out="Recipient">
                    <attribute-create out="label">../row[1]/label</attribute-create>
                    <attribute-create out="id">str:replace(../row[1]/id,'.','_')</attribute-create>
                    <element-ignore in="row">
                        <element-ignore in="email">
                            <text></text>
                        </element-ignore>

                    </element-ignore>

                </element>
            </element>

            <elements path="Recipients/Recipient">

                <attribute-ignore></attribute-ignore>
                <element-create>new_element('label',new_text(../@label))</element-create>
                <element-create>new_element('id',str:replace(new_text(../@id),'.','_'))</element-create>
                <element-create>new_element('email',../text())</element-create>
                <text-ignore></text-ignore>

            </elements>



        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

    <!--RECIPIENTS - Site Administrators BRANCH-->
    <view name="saRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Site Administrators</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>
            <remove match="//NGI/Sites/Site[@production=0 or @certified=0]"></remove>
            <rename match="/NGIs" name="Recipients"/>
            <remove match="//NGI[count(Sites/Site)=0]"/>
            <remove match="//NGI" depth="1"/>
            <!--<remove nodes="//Id"/>-->
            <remove match="//Sites" depth="1"/>
            <rename match="//Site" name="Recipient"/>
            <insert match="/Recipients/Recipient" nodes="new_element('id', string(@primary_key))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('label', string(@name))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('email', string(@contact_email))"/>
            <remove match="/*/*/@*"/>

        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>

    <!--RECIPIENTS - Site Administrators BRANCH-->
    <view name="ssecRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Site Security Contacts</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>
            <remove match="//NGI/Sites/Site[@production=0 or @certified=0]"></remove>
            <rename match="/NGIs" name="Recipients"/>
            <remove match="//NGI[count(Sites/Site)=0]"/>
            <remove match="//NGI" depth="1"/>
            <!--<remove nodes="//Id"/>-->
            <remove match="//Sites" depth="1"/>
            <rename match="//Site" name="Recipient"/>
            <insert match="/Recipients/Recipient" nodes="new_element('id', string(@primary_key))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('label', string(@name))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('email', string(@csirt_email))"/>
            <remove match="/*/*/@*"/>

        </processors>

        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>


    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - Operation Tools BRANCH-->
    <view name="otRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Operation Tools</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>
            <remove match="//NGI[@name!='EGI.eu']"/>
            <remove match="//NGI" depth="1"/>
            <rename match="/NGIs" name="Recipients"/>

            <remove match="//Sites" depth="1"/>
            <rename match="//Site" name="Recipient"/>
            <insert match="/Recipients/Recipient" nodes="new_element('id', string(@primary_key))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('label', string(@name))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('email',string(@contact_email))"/>
            <remove match="/*/*/@*"/>


        </processors>
        <cache type="FileCache">
            <trigger ignore-during="PT1H" type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


    </view>

    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - User Contacts BRANCH-->
    <view name="ucRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Users Contacts</description>
        </info>
        <argument name="user_id"/>

        <connector type="SQLConnector">

            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('BROADCAST.db.url')"/>
            <parameter name="username" eval="property('BROADCAST.db.username')"/>
            <parameter name="password" eval="property('BROADCAST.db.password')"/>
            <parameter name="query">
            <entry>SELECT b.id, b.name as label, b.value as email
                FROM broadcast_mailing_lists b
                WHERE b.scope = 'private'
                AND user_id =
            </entry>
            <entry eval="quot($user_id)"/>
            <entry>ORDER BY label</entry>
        </parameter>

        </connector><processors>
            <rename match="/result/row" name="Recipient"/>
            <rename match="/result" name="Recipients"/>
        </processors></view>





    <!--LEGACY VIEW FROM LAVOISIER 1-->
    <!--RECIPIENTS - SOURCE FOR JSTREE VIEW - VO Supporting Sites BRANCH-->
    <view name="vsRecipientsView">
        <info>
            <category>BROADCAST Recipients branches</category>
            <description>Vo Supporting Sites</description>
        </info>


        <connector type="HTTPConnector">
            <parameter name="url" eval="property('BROADCAST.portal.voSitesEmails')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>
        <processors>
            <rename match="/VOS/VO" name="Recipient"/>
            <rename match="/VOS" name="Recipients"/>
            <rename match="/*/*/EMAILS" name="email"/>

            <insert match="/Recipients/Recipient" nodes="new_element('id', str:replace(string(@id),'.','_'))"/>
            <insert match="/Recipients/Recipient" nodes="new_element('label', string(@id))"/>

            <remove match="/*/*/@id"/>
            <remove match="/*/*/@name"/>

        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>
</config>