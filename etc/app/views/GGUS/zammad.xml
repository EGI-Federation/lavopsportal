<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">


    <view name="createTickets">

        <argument name="site">AUVERGRID</argument>
        <argument name="ngi">NGI_FRANCE</argument>
        <argument name="subject">ticket6</argument>
        <argument name="message">this is a test , please ignore it</argument>
        <argument name="type">Incident</argument>
        <argument name="area">Operations</argument>
        <argument name="priority">urgent</argument>        
        <argument name="case">sites</argument>
        
        <variable name="token" eval="choose($case='sites',property('zammad.sites.token'),property('zammad.vo.token'))"/>
        <variable name="customer" eval="choose($case='sites',property('zammad.sites.customer'),property('zammad.vo.customer'))"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>
      

        <variable name="data" eval="concat('{ ',
            quot('priority'),':',quot($priority),',',
            quot('type'),':',quot($type),',',
            quot('area'),':',quot($area),',',
            quot('customer'),':',quot($customer),',',
            quot('title') ,':', quot($subject),',',
            quot('group'),':', quot(concat('NGIs::',$ngi)),',',
            quot('wlcg_sites'),':', quot($site),',',
            quot('article'), ': {',
            quot('subject'),':',quot($subject),',',
            quot('body'),':',quot($message),'}}')"/>


        <connector type="HTTPConnector">
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="method">POST</parameter>
            <parameter name="url" eval="concat($base_url,'/api/v1/tickets')"></parameter>
            <parameter name="post" eval="$data"/>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object">
                <element-ignore if="name()!='id'"/>
            </element>
        </processors>
    </view>


    <view name="getGroups">

        <variable name="token" eval="property('zammad.sites.token')"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

        <connector type="HTTPConnector">
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="url" eval="concat($base_url,'/api/v1/groups')"></parameter>


        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
    </view>


    <view name="getUsers">

    <variable name="token" eval="property('zammad.sites.token')"/>
    <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

    <connector type="HTTPConnector">
        <parameter name="method">GET</parameter>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
            <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
        </parameter>
        <parameter name="url" eval="concat($base_url,'/api/v1/users/me')"></parameter>
    </connector>
        <serializer type="JSONStreamSerializer"></serializer>


       <processors>
            <element in="item" out="users">
                <element in="object" out="user">
                    <attribute-create out="id">../id/text()</attribute-create>
                    <attribute-create out="name">concat(../firstname/text(),' ',../lastname/text())</attribute-create>
                    <element-ignore></element-ignore>

                </element>

            </element>

        </processors>
    </view>

    <view name="getTicketHistory" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

    <argument name="ticketId">1393</argument>
    <variable name="token" eval="property('zammad.sites.token')"/>
    <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

    <connector type="HTTPConnector">
        <parameter name="method">GET</parameter>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
            <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
        </parameter>
        <parameter name="url" eval="concat($base_url,'/api/v1/ticket_articles/by_ticket/',$ticketId)"></parameter>
    </connector>
    <serializer type="JSONStreamSerializer"></serializer>
    <processors>

        <element in="item" out="e:entries">
            <element in="object" out="e:entries">
                <element-ignore if="name()='from' or name()='subject' or name()='body' or name()='created_at'">
                    <element-create>entry(name(..),../text())</element-create>
                </element-ignore>
            <element-ignore/>

            </element>

        </element>

    </processors>




    </view>

    <view name="getTickets">
        <argument name="ticketId">_id_</argument>
        <variable name="token" eval="property('zammad.sites.token')"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

        <connector type="HTTPConnector">
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="url" eval="choose($ticketId='_id_',concat($base_url,'/api/v1/tickets/search?query=customer_id:809'),concat($base_url,'/api/v1/ticket_articles/by_ticket/',$ticketId))"></parameter>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
        <processors>

            <element in="item" out="Tickets">


                        <element in="object" out="Ticket">
                            <element if="name()='id' or name()='title' or name()='wlcg_sites' or name()='state_id' or name()='updated_at' or name()='priority_id'"></element>

                            <element-create>new_element('state',new_text(view('zammadProperties')/properties/states/state[@value=current()/../state_id/text()]/text()))</element-create>
                            <element-create>new_element('priority',new_text(view('zammadProperties')/properties/priorities/priority[@value=current()/../priority_id/text()]/text()))</element-create>

                            <element-ignore/>
                        </element>



            </element>

            <element in="Tickets" if="$ticketId='_id_'">
                <element-ignore if="name()!='Ticket'"/>
            </element>
        </processors>
    </view>

    <view name="createToken">

        <variable name="client-pwd">pqzfOv80iPFZkdtIRW9_00xmY0QWKTTkmlS21</variable>
        <variable name="base_url" eval="'https://helpdesk.ggus.eu'"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat($base_url,'/api/v1/user_access_token')"></parameter>
            <parameter name="method">POST</parameter>

            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$client-pwd)"></entry>
            </parameter>
            <parameter name="post" eval="property('zammad.credentials')"/>

        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
    </view>



    <view name="zammadProperties">
        <connector type="FileConnector">
            <parameter name="path">/app/resources/xml/zammad_properties.xml</parameter>
        </connector>
    </view>

</views>