<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">


    <view name="createTickets">

        <argument name="site">AUVERGRID</argument>
        <argument name="ngi">NGI_FRANCE</argument>
        <argument name="subject">ticket6</argument>
        <argument name="message">this is a test , please ignore it</argument>
        <argument name="type">Incident</argument>
        <argument name="area">Operations</argument>
        <argument name="priority">urgent</argument>        
        <argument name="case">sites</argument>
        
        <variable name="token" eval="choose($case='sites',property('zammad.sites.token'),property('zammad.vo.token'))"/>
        <variable name="customer" eval="choose($case='sites',property('zammad.sites.customer'),property('zammad.vo.customer'))"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>
      

        <variable name="data" eval="concat('{ ',
            quot('priority'),':',quot($priority),',',
            quot('type'),':',quot($type),',',
            quot('area'),':',quot($area),',',
            quot('customer'),':',quot($customer),',',
            quot('title') ,':', quot($subject),',',
            quot('group'),':', quot(concat('NGIs::',$ngi)),',',
            quot('wlcg_sites'),':', quot($site),',',
            quot('article'), ': {',
            quot('subject'),':',quot($subject),',',
            quot('body'),':',quot($message),'}}')"/>


        <connector type="HTTPConnector">
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="method">POST</parameter>
            <parameter name="url" eval="concat($base_url,'/api/v1/tickets')"></parameter>
            <parameter name="post" eval="$data"/>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object">
                <element-ignore if="name()!='id'"/>
            </element>
        </processors>
    </view>


    <view name="getGroups">

        <variable name="token" eval="property('zammad.sites.token')"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

        <connector type="HTTPConnector">
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="url" eval="concat($base_url,'/api/v1/groups')"></parameter>


        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
    </view>

    <view name="getTickets">
        <argument name="ticketId">_id_</argument>
        <variable name="token" eval="property('zammad.sites.token')"/>
        <variable name="base_url" eval="property(concat('zammad.url.',property('env')))"/>

        <connector type="HTTPConnector">
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$token)"></entry>
            </parameter>
            <parameter name="url" eval="choose($ticketId='_id_',concat($base_url,'/api/v1/tickets/search?query=customer_id:809'),concat($base_url,'/api/v1/tickets/',$ticketId))"></parameter>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
        <processors>

            <element in="object" out="Tickets">
                <element-ignore in="assets">
                    <element-ignore in="Ticket">
                        <element  out="Ticket">
                            <element if="name()='id' or name()='title' or name()='wlcg_sites' or name()='state_id' or name()='updated_at' or name()='priority_id'"></element>
                            <element-ignore/>
                        </element>
                    </element-ignore>
                </element-ignore>

            </element>
        </processors>
    </view>

    <view name="createToken">

        <variable name="client-pwd">qZUer8Coj1Q758EZwz9rOmO4Cwkgz-36mZ744RQ2T6p6HOWcX6ui-2lRDT9D6_v5</variable>
        <variable name="base_url" eval="'https://helpdesk-dev.ggus.eu'"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat($base_url,'/api/v1/user_access_token')"></parameter>
            <parameter name="method">POST</parameter>

            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Token token=',$client-pwd)"></entry>
            </parameter>
            <parameter name="post" eval="property('zammad.credentials')"/>

        </connector>
        <serializer type="JSONStreamSerializer"></serializer>
    </view>

</views>