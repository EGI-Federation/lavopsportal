<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">



    <view name="GGUS_wsdl">
        <argument name="service_id">GGUS_OPS</argument>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('GGUS.wsdl.baseurl'),$service_id)"/>
        </connector>
    </view>


    <view name="GGUS_OPS_orphan_groups"  xmlns:ns0="urn:GGUS_OPS" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings">

        <argument name="community">ROD</argument>
        <connector type="XMLConnector">
            <parameter name="content"  eval="view('GGUS_OPS_terminal_state')"/>
        </connector>
        <processors>
            <processor type="EncodeProcessor" match="/*"/>

            <!-- revert XML encoding in GHD_Soap_Client_Data node -->
            <!-- 1. push text node for (view) to convert it in valid XML -->

            <elements path="/ns0:OpGetListOpsResponse/ns0:getListValues/ns0:GHD_Soap_Client_Data">
                <text-ignore/>
                <element-create>xml(../text())/e:entries</element-create>
            </elements>



            <element in="ns0:OpGetListOpsResponse" out="e:entries">
                <element-ignore in="ns0:getListValues" if="not(ns0:GHD_Soap_Client_Data/e:entries/e:entry[@key='GroupId']/text()) or ns0:GHD_Soap_Client_Data/e:entries/e:entry[@key='GroupId']/text()='' or ns0:GHD_Soap_Client_Data/e:entries/e:entry[@key='GroupId']/text()='null' or e:entries/e:entry[@key='GroupId']/text()='lost'"/>
                <element-ignore in="ns0:getListValues"   if="ns0:GHD_Soap_Client_Data/e:entries/e:entry[@key='Community']!=$community"/>
                <element-ignore in="ns0:getListValues"   if="ns0:GHD_Status/text()!='verified' and ns0:GHD_Status/text()!='closed'"/>
            </element>

            <element in="e:entries">
                <element in="ns0:getListValues" out="e:entries">
                    <element in="ns0:GHD_Soap_Client_Data" out="e:entries"/>
                    <element-ignore if="not(ns0:GHD_Soap_Client_Data)">
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                    </element-ignore>

                </element>
            </element>


        </processors>

        <pre-renderers>
            <namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
            <title>concat(/e:entries/e:entries[1]/e:entries/e:entry[@key='Community'], ' Tickets : ',
                count(/e:entries/e:entries))
            </title>
            <row foreach="/e:entries/e:entries">
                <column label="id">e:entry[@key='GHD_Request_ID']</column>
                <column label="GGUS status">e:entries/e:entry[@key='GHD_Status']</column>
                <column label="Group ID">e:entries/e:entry[@key='GroupId']</column>
                <column label="GGUS SU">e:entry[@key='GHD_Responsible_Unit']</column>
                <column label="NGI">e:entries/e:entry[@key='Ngi']</column>
                <column label="Site">e:entry[@key='GHD_Affected_Site']</column>
                <column label="Community">e:entries/e:entry[@key='Community']</column>
                <column label="Step">e:entries/e:entry[@key='Step']</column>
                <column label="StepLabel">e:entries/e:entry[@key='StepLabel']</column>
            </row>
        </pre-renderers>

    </view>

    <view name="GGUS_ROD" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Opened', entry('service_id','GGUS_OPS') | entry('community_id','ROD')) "/>
        </connector>


        <processors>

            <elements path="/e:entries/e:entries/e:entries">
                <element-create if="../e:entry[@key='EndDate'][text()]">
                    entry('StatusTicket',
                    view('StatusTicket', entry('date',../e:entry[@key='EndDate']/text())))
                </element-create>
                <element-create if="not(../e:entry[@key='EndDate'][text()])">
                    entry('StatusTicket',99)
                </element-create>
            </elements>

            <elements path="/e:entries/e:entries/e:entries">
                <!-- Ticket Status 3: Expired,  2:Expiring , 1:On Going -->
                <element-create>entry('Status',choose(../e:entry[@key='StatusTicket']/text()&gt;0, choose(../e:entry[@key='StatusTicket']/text()&gt;3,'3','2'),'1'))</element-create>
            </elements>


                <element in="e:entries">
                    <element-ignore in="e:entries" if="e:entries/e:entry[@key='SubCommunity']/text()='Middleware'"/>
                </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entries/e:entry[@key='Community']/text()!='ROD'"/>
            </element>


        </processors>
        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
            <trigger type="ViewAccessedTrigger" ignore-during="PT3M"/>
        </cache>
    </view>

    <view name="GGUS_ROD_Closed" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Closed', entry('service_id','GGUS_OPS') | entry('community_id','ROD')) "/>
        </connector>

        <processors>
            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entries/e:entry[@key='Community']/text()!='ROD'"/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" name="StatusTicket">

        <argument name="date"/>
        <connector type="StringConnector">
            <parameter name="content"
                       eval="view('diffWWE', entry('date_start',date:format-date($date,property('date_format'))) |                        entry('date_end', view('UTC-now', entry('format',property('date_format')))/*/*/text())  |                        entry('granularity','day'))"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>


    </view>


    <view name="GGUS_MW" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Opened', entry('service_id','GGUS_OPS') | entry('community_id','ROD')) "/>
        </connector>
        <processors>


            <elements path="/e:entries/e:entries/e:entries">
                <element-create if="../e:entry[@key='EndDate'][text()]">
                    entry('StatusTicket',
                    view('StatusTicket', entry('date',../e:entry[@key='EndDate']/text())))
                </element-create>
                <element-create if="not(../e:entry[@key='EndDate'][text()])">
                    entry('StatusTicket',99)
                </element-create>
            </elements>

            <elements path="/e:entries/e:entries/e:entries">
                <element-create>entry('Status',choose(../e:entry[@key='StatusTicket']/text()&gt;0, choose(../e:entry[@key='StatusTicket']/text()&gt;3,'3','2'),'1'))</element-create>
            </elements>



            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entries/e:entry[@key='SubCommunity']/text()!='Middleware' or not(e:entries/e:entry[@key='SubCommunity']/text())"/>
            </element>

        </processors>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>


    <view name="GGUS_COD" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Opened', entry('service_id','GGUS_OPS') | entry('community_id','COD')) "/>
        </connector>
        <processors>





            <elements path="/e:entries/e:entries/e:entries">
                <element-create if="../e:entry[@key='EndDate'][text()]">
                    entry('StatusTicket',
                    view('StatusTicket', entry('date',../e:entry[@key='EndDate']/text())))
                </element-create>
                <element-create if="not(../e:entry[@key='EndDate'][text()])">
                    entry('StatusTicket',99)
                </element-create>
            </elements>

            <elements path="/e:entries/e:entries/e:entries">
                <element-create>entry('Status',choose(../e:entry[@key='StatusTicket']/text()&gt;0, choose(../e:entry[@key='StatusTicket']/text()&gt;3,'3','2'),'1'))</element-create>
            </elements>


            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entries/e:entry[@key='Community']/text()!='COD' or not(e:entries/e:entry[@key='Community']/text())"/>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>GGUS_ROD</entry>
                </parameter>
            </trigger>
        </cache>

        <pre-renderers>
            <title>concat(/e:entries/e:entries[1]/e:entries/e:entry[@key='Community'], ' Tickets : ', count(/e:entries/e:entries))</title>
            <row foreach="/e:entries/e:entries">
                <column label="id">e:entry[@key='GHD_Request_ID']</column>
                <column label="GGUS status">e:entries/e:entry[@key='GHD_Status']</column>
                <column label="GGUS SU">e:entry[@key='GHD_Responsible_Unit']</column>
                <column label="Community">e:entries/e:entry[@key='Community']</column>
                <column label="Step">e:entries/e:entry[@key='Step']</column>
                <column label="StepLabel">e:entries/e:entry[@key='StepLabel']</column>
            </row>
        </pre-renderers>

    </view>

    <view name="GGUS_CSI">

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Opened',  entry('service_id','GGUS_OPS') | entry('community_id','CSI')) "/>
        </connector>
        <cache type="FileCache">


            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>



    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="GGUS_Counters">


        <argument name="entity_type" pattern="ngi|site"/>
        <argument name="view_id">GGUS_ROD</argument>

        <argument name="pre_path">/*/*</argument>
        <variable name="ggus_entity" eval="choose($entity_type='ngi','GHD_Responsible_Unit','GHD_Affected_Site')"/>



        <connector type="XMLConnector">
            <parameter name="content" eval="view_path($view_id,$pre_path)"/>
        </connector>

        <processors>

            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entry[@key='GHD_Problem_Type']/text()!='Operations'"/>
            </element>


            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key=$ggus_entity]/text()')</element-create>
            </element>

            <element in="e:entries">
                    <element-create-as-parent out="e:entry" group-by="e:entry[@key=$ggus_entity]/text()">
                        <element in="e:entries"/>
                    </element-create-as-parent>
            </element>

            <element in="e:entries">
                    <element in="e:entry">
                        <attribute-create out="key">../e:entries/e:entry[@key=$ggus_entity][1]/text()</attribute-create>
                        <text-create>count(../e:entries/e:entry[@key='GHD_Request_ID'])</text-create>
                        <element-ignore/>
                    </element>
            </element>

        </processors>

    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="GGUS_Counters_Closed">

        <argument name="entity_type" pattern="ngi|site"/>
        <argument name="view_id">GGUS_ROD</argument>
        <argument name="ggus_entity" eval="choose($entity_type='ngi','GHD_Responsible_Unit','GHD_Affected_Site')"/>
        <argument name="pre_path">/e:entries/e:entries[e:entry[@key='Ngi']]</argument>

        <connector type="XMLConnector">
            <parameter name="content"
                       eval="view('GGUS_Closed', entry('service_id','GGUS_OPS') | entry('community_id','ROD')) "/>
        </connector>


        <processors>

            <elements path="/e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key=$ggus_entity]/text()')</element-create>
            </elements>

            <elements path="/e:entries">
                <element-create-as-parent out="e:entry" group-by="e:entry[@key=$ggus_entity]/text()">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </elements>

            <element in="e:entries">
                <element in="e:entry">
                    <attribute-create out="key">../e:entries/e:entry[@key=$ggus_entity][1]/text()</attribute-create>
                    <text-create>count(../e:entries/e:entry[@key='GHD_Request_ID'])</text-create>
                    <element-ignore/>
                </element>
            </element>

        </processors>

    </view>

    <view xmlns:ns0="urn:GGUS_OPS" xmlns:str="http://exslt.org/strings"
          xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times"
          name="GGUS_Counters_ByStatus">


        <argument name="entity_type" pattern="ngi|site"/>
        <argument name="view_id">GGUS_ROD</argument>
        <argument name="ggus_entity" eval="choose($entity_type='ngi','Ngi','GHD_Affected_Site')"/>
        <argument name="pre_path">/e:entries/e:entries[e:entry[@key='Ngi']='NGI_FRANCE']</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view_path($view_id,$pre_path)"/>
        </connector>

        <processors>

            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entry[@key='GHD_Problem_Type']/text()!='Operations'"/>
            </element>



            <elements path="/e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key=$ggus_entity]/text()')</element-create>
            </elements>


            <elements path="/e:entries">
                <element-create-as-parent out="e:entry" group-by="e:entry[@key=$ggus_entity]/text()">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </elements>


            <element in="e:entries">
                <element in="e:entry">
                    <attribute-create out="key">../e:entries/e:entry[@key=$ggus_entity][1]/text()</attribute-create>
                    <element-create>entry('0',count(../e:entries/e:entry[@key='GHD_Request_ID']))</element-create>
                    <element-create>entry('1',count(../e:entries/e:entries/e:entry[@key='Status'][text()='1']))</element-create>
                    <element-create>entry('2',count(../e:entries/e:entries/e:entry[@key='Status'][text()='2']))</element-create>
                    <element-create>entry('3',count(../e:entries/e:entries/e:entry[@key='Status'][text()='3']))</element-create>
                    <element-ignore/>
                </element>
            </element>




        </processors>
    </view>

    <view xmlns:gg="urn:GGUS_OPS" xmlns:str="http://exslt.org/strings" xmlns:date="http://exslt.org/dates-and-times"
          xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="GGUS_ROD_Opened_24H">



        <connector type="XMLConnector">
            <parameter name="content" eval="view('GGUS_ROD')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <element in="e:entries">

                    <element-create  if="../e:entry[@key='GHD_Create_Date']/text()!='' and ../e:entry[@key='GHD_Create_Date']/text()">
                        entry('DurationDays',
                        date:seconds(date:difference(date:format-date(
                        ../e:entry[@key='GHD_Create_Date']/text()
                        ,property('date_format')),view('UTC-now')/*)
                        ) )
                    </element-create>

                    <element-create  if="not(../e:entry[@key='GHD_Create_Date']/text()) or ../e:entry[@key='GHD_Create_Date']/text()=''">
                        entry('DurationDays',
                        date:seconds(date:difference(date:format-date(
                        view('UTC-now')/*   ,    property('date_format')),view('UTC-now')/*)
                        )  )
                    </element-create>
                </element>
            </element>

            <element in="e:entries">
                    <element-ignore in="e:entries" if="e:entry[@key='DurationDays']/text() &gt; number(84600) or e:entry[@key='DurationDays']/text()='0.0'"/>
            </element>


            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key="GHD_Affected_Site"]/text()')</element-create>
            </element>

            <element in="e:entries">

                <element-create-as-parent out="e:entry" group-by="e:entry[@key='GHD_Affected_Site']/text()">
                    <element in="e:entries"/>
                </element-create-as-parent>

            </element>

            <elements path="e:entries/e:entries">
                <attribute-create out="key">../e:entries/e:entry[@key='GHD_Affected_Site']/text()</attribute-create>
                <element-create as="first-child">entry('countTicketsOpened',count(../e:entries/e:entry[@key='GHD_Request_ID']))</element-create>
                <element-ignore/>
            </elements>




        </processors>
    </view>




    <view xmlns:gg="urn:GGUS_OPS" xmlns:str="http://exslt.org/strings" xmlns:date="http://exslt.org/dates-and-times"
          xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="GGUS_ROD_Closed_24H">



        <connector type="XMLConnector">
            <parameter name="content" eval="view('GGUS_ROD_Closed')"/>
        </connector>

        <processors>


            <element in="e:entries">
                <element in="e:entries">

                    <element-create if="../e:entries/e:entry[@key='CloseDate']/text()!='' and ../e:entries/e:entry[@key='CloseDate']/text()">
                        entry('DurationDays',
                        date:seconds(date:difference(date:format-date(
                        ../e:entries/e:entry[@key='CloseDate']/text()
                        ,property('date_format')),view('UTC-now')/*)
                        ) )
                    </element-create>

                    <element-create if="not(../e:entries/e:entry[@key='CloseDate']/text()) or ../e:entries/e:entry[@key='CloseDate']/text()=''">
                        entry('DurationDays',
                        date:seconds(date:difference(date:format-date(
                        view('UTC-now')/*   ,    property('date_format')),view('UTC-now')/*)
                        )  )
                    </element-create>

                </element>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="e:entry[@key='DurationDays']/text() &gt; number(90000) or e:entry[@key='DurationDays']/text()='0.0' "/>
            </element>


            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key="GHD_Affected_Site"]/text()')</element-create>
            </element>


            <element in="e:entries">
                <element-create-as-parent out="e:entry" group-by="e:entry[@key='GHD_Affected_Site']/text()">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <elements path="e:entries/e:entries">
                <attribute-create out="key">../e:entries/e:entry[@key='GHD_Affected_Site']/text()</attribute-create>
                <element-create as="first-child">entry('countTicketsClosed',count(../e:entries/e:entry[@key='GHD_Request_ID']))</element-create>
                <element-ignore/>
            </elements>



        </processors>
    </view>


</views>