<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >

    <view name="OPSCORE_endpoints">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_service_endpoint')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>

            <!-- filtering -->
            <processor match="/results/SERVICE_ENDPOINT/*[not(self::HOSTNAME | self::GOCDB_PORTAL_URL | self::IN_PRODUCTION | self::NODE_MONITORED | self::SITENAME | self::ROC_NAME | self::SERVICE_TYPE)]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>

            <!-- filtering -->
            <processor match="/results/SERVICE_ENDPOINT[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="new_attribute('service_type', SERVICE_TYPE ) |                            new_attribute('hostname', HOSTNAME) |                            new_attribute('key', concat(HOSTNAME,SERVICE_TYPE)) |                            new_attribute('site', SITENAME) |                            new_attribute('ngi', ROC_NAME)"/></processor>


            <processor match="/results/SERVICE_ENDPOINT/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry(local-name(), .)"/></processor>
            <processor match="/results/SERVICE_ENDPOINT" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <!-- merge downtime info -->
            <processor match="/results/e:entries[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="view('OPSCORE_downtime_ongoing_raw')/results/DOWNTIME[ENDPOINT/text() = match()/@key]/*[not(                     self::HOSTNAME | self::SERVICE_TYPE |                     self::ENDPOINT | self::HOSTED_BY |                     self::INSERT_DATE | self::START_DATE |                     self::FORMATED_START_DATE | self::FORMATED_END_DATE )]"/></processor>

            <processor match="/results/e:entries/*[local-name() != 'entry'][text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry(concat('DOWNTIME_',local-name()),.)"/></processor>

        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_downtime_ongoing_raw</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>

    <view xmlns:cfg="http://software.in2p3.fr/lavoisier/config.xsd"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:ns="uri://" name="OPSCORE_endpoints_post">

        <!-- default argument is path if exists -->
        <argument name="xpath" eval="path(false())" path-format="none"/>



        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_endpoints')"/>
        </connector>
        <processors>
            <!-- apply posted xpath -->
            <processor type="SelectProcessor" match="eval($xpath)" disabled="not($xpath)">
                <namespaces>
                    <entry key="cfg">http://software.in2p3.fr/lavoisier/config.xsd</entry>
                    <entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry>
                    <entry key="ns">uri://</entry>
                </namespaces>
                
                
            </processor>
        </processors>

    </view>

    <view name="OPSCORE_host_service" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

    <connector type="HTTPConnector">
        <parameter name="url" eval="property('OPSCORE.gocdb.get_service_endpoint')"/>
        <parameter name="certificate" eval="property('certificate.path')"/>
        <parameter name="passphrase" eval="property('certificate.password')"/>
    </connector>

        <processors>

            <element in="results" out="e:entries">

                <element in="SERVICE_ENDPOINT" out="e:entries">

                    <element-create>entry('id',../@PRIMARY_KEY)</element-create>
                    <element-create>entry('hostname',../HOSTNAME/text())</element-create>
                    <element-create>entry('service',../SERVICE_TYPE/text())</element-create>
                    <element-create>entry('status',
                        concat(
                        choose(../NODE_MONITORED/text()='Y','1','0'),
                        choose(../IN_PRODUCTION/text()='Y','1','0')))</element-create>
                    <element-create>entry('site',../SITENAME/text())</element-create>
                    <element-create>entry('ngi',../ROC_NAME/text())</element-create>

                    <element-ignore/>
                </element>
                <element-create as="first-child">view('OPSCORE_fake_availability_services')/e:entries/*</element-create>

            </element>



        </processors>


        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_fake_availability_services" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">

                <element in="SITE" out="e:entries">
                    <attribute-ignore if="local-name()!='PRIMARY_KEY'"/>
                    <element-create>entry('id',concat(../@PRIMARY_KEY,'_av'))</element-create>
                    <element-create>entry('hostname',concat(../SHORT_NAME/text(),'_Availability'))</element-create>
                    <element-create>entry('service',concat(../SHORT_NAME/text(),'_Availability'))</element-create>
                    <element-create>entry('status','11')</element-create>
                    <element-create>entry('site',../SHORT_NAME/text())</element-create>
                    <element-create>entry('ngi',../ROC/text())</element-create>
                    <element-ignore/>
                </element>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_host_service_cron">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.update.servicesDB')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="connect-timeout">120</parameter>
            <parameter name="read-timeout">120</parameter>
        </connector>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">2</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

</views>