<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" version="15">

    <view name="metrics_columns">
        <info>
            <category>Metrics</category>
        </info>
        <connector type="FileConnector">
            <parameter name="path">OPSCORE/resources/xml/metrics_columns.xml</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="ViewCreatedTrigger"/>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times" name="OPSCORE_RenderDashboard_raw"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/><namespace prefix="date" uri="http://exslt.org/dates-and-times"/>
        <info>
            <category>Metrics</category>
        </info>

        <argument name="view">ROD_XML</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view($view)"/>
        </connector>

        <processors>
            <processor type="SelectProcessor" match="/html//table"/>
            <insert match="/e:entries/table/tbody/tr/td[*]" nodes="entry(choose(@class,@class,'noclass'),choose(div/text(),div/text(),choose(a/text(),a/text(),'no')))"/>
            <processor type="SelectProcessor" match="/e:entries/table/tbody/tr[td/e:entry]"/>

            <rename match="/e:entries/tr" name="e:entries"/>
            <remove match="/e:entries/e:entries/*[local-name()!='entry']" depth="1"/>
            <remove match="/e:entries/e:entries/*[local-name()!='entry']" depth="1"/>
            <remove match="/e:entries/e:entries/*[local-name()!='entry']" depth="1"/>
            <remove match="/e:entries/e:entries/text()"/>
            <remove match="/e:entries/e:entries/i"/>
            <remove match="/e:entries/e:entries/i"/>
            <remove match="/e:entries/e:entries/e:entry[text()='no']"/>

            <replace match="/e:entries/e:entries/e:entry/@key" nodes="choose(                 view('metrics_columns')/entries/entries[@key=$view]/entry[@key=match()]/text(),                 view('metrics_columns')/entries/entries[@key=$view]/entry[@key=match()]/text(),                 match()                 )">
            </replace>

            <insert match="/e:entries/e:entries[*]" nodes="new_attribute('key',e:entry[@key='site']/text())"/>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times" name="OPSCORE_RenderDashboard"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/><namespace prefix="date" uri="http://exslt.org/dates-and-times"/>
        <info>
            <category>Metrics</category>
        </info>

        <argument name="view">ROD_XML</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_site_list_prod')"/>
        </connector>

        <processors>

            <insert match="/e:entries/e:entries[*]" nodes="view('OPSCORE_RenderDashboard_raw',entry('view',$view))/e:entries/e:entries[@key=match()/@NAME]/*"/>
            <insert match="/e:entries/e:entries" nodes="entry('daydate',substring(date:date(),1,10))"/>
            <insert match="/e:entries/e:entries[*]" nodes="entry('id',concat(e:entry[@key='daydate']/text(),'_',e:entry[@key='site']/text()))"/>
            <insert match="/e:entries/e:entries[*]" nodes="entry('ticketsCreated',e:entry[@key='site']/text())"/>
            <insert match="/e:entries/e:entries[*]" nodes="entry('ticketsClosed',e:entry[@key='site']/text())"/>



            <element in="e:entries">
                <set variable="GGUS_ROD_Opened_24H">view('GGUS_ROD_Opened_24H')</set>
                <set variable="GGUS_ROD_Closed_24H">view('GGUS_ROD_Closed_24H')</set>
                <set variable="Csi_RT_ClosedTicket_List_24h">view('Csi_Metrics_Count',entry('viewRT','Csi_RT_ClosedTicket_List_24h'))</set>
                <set variable="Csi_RT_OpenedTicket_List_24h">view('Csi_Metrics_Count', entry('viewRT','Csi_RT_OpenedTicket_List_24h'))</set>
                <element in="e:entries">



                    <element in="e:entry" if="@key='ticketsCreated' and $view='ROD_XML'">
                        <text>choose(
                            $GGUS_ROD_Opened_24H/e:entries/e:entry[@key=current()/../../@NAME]/e:entry/text(),
                            $GGUS_ROD_Opened_24H/e:entries/e:entry[@key=current()/../../@NAME]/e:entry/text(),
                            0)</text>
                    </element>
                    <element in="e:entry" if="@key='ticketsClosed' and $view='ROD_XML'">
                        <text>choose(
                            $GGUS_ROD_Closed_24H/e:entries/e:entry[@key=current()/../../@NAME]/e:entry/text(),
                            $GGUS_ROD_Closed_24H/e:entries/e:entry[@key=current()/../../@NAME]/e:entry/text(),
                            0)</text>
                    </element>

                    <element in="e:entry" if="@key='ticketsCreated' and $view='CSI_XML'">
                        <text>choose(
                            $Csi_RT_OpenedTicket_List_24h/e:entries/e:entry[@key=current()/../../@NAME]/@nbTickets,
                            $Csi_RT_OpenedTicket_List_24h/e:entries/e:entry[@key=current()/../../@NAME]/@nbTickets,
                            0)</text>
                    </element>
                    <element in="e:entry" if="@key='ticketsClosed' and $view='CSI_XML'">
                        <text>choose(
                            $Csi_RT_ClosedTicket_List_24h/e:entries/e:entry[@key=current()/../../@NAME]/@nbTickets,
                            $Csi_RT_ClosedTicket_List_24h/e:entries/e:entry[@key=current()/../../@NAME]/@nbTickets,
                            0)</text>
                    </element>

                </element>

            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="ListMetrics">
        <info>
            <category>Metrics</category>
        </info>
        <argument name="view">ROD_XML</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('metrics_columns')"/>
        </connector>
        <processors>

            <remove match="/entries/entries[@key!=$view]"/>
            <replace match="/entries/entries/entry/text()" nodes="concat(',sum(',match(),') as  sum_',match() )"/>
            <remove match="/entries/entries" depth="2"/>
        </processors>

    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_Render_Metrics"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Metrics</category>
        </info>


        <argument name="table"/>
        <argument name="entity_type"/>
        <argument name="entity_name"/>
        <argument name="date"/>
        <argument name="view" eval="choose($table='cod_metrics','COD_XML','ROD_XML')"/>


        <argument name="query_start" eval="view('ListMetrics', entry('view',$view))/*"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                <entry eval="choose($entity_name='any', 'SELECT ngi','SELECT site , ngi')"/>

                <entry eval="$query_start"/>
                <entry>FROM</entry>
                <entry eval="$table"/>
                <entry>WHERE</entry>
                <entry eval="choose($entity_name!='any',concat($entity_type,'=',quot($entity_name)),concat($entity_type,'=',$entity_type))"/>
                <entry>AND daydate like</entry>
                <entry eval="quot(concat('%',$date,'%'))"/>
                <entry eval="choose($entity_name='any', 'GROUP by ngi','GROUP by site')"/>

            </parameter>

        </connector>


        <processors>
            <replace match="/result/row/*[text()]" nodes="entry(local-name(match()),match()/text())"/>
            <rename match="/result/row" name="e:entries"/>
            <rename match="/result" name="e:entries"/>

            <elements path="e:entries/e:entries">
                <element-ignore in="e:entry" if="@key='ngi' and preceding-sibling::e:entry[@key='site']"/>
            </elements>
        </processors>
        <pre-renderers row-column="OPSCORE/resources/xsl/metricsrowcol.xsl"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>

        </pre-renderers>

        <renderers>
            <renderer type="ChartRenderer">
                <parameter name="rotation">-45</parameter>
            </renderer>
        </renderers>

    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_Render_Metrics_Chart"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
    <info>
        <category>Metrics</category>
        <accept>chart</accept>
    </info>


    <argument name="table">csi_metrics</argument>
    <argument name="entity_type">ngi</argument>
    <argument name="entity_name">any</argument>
    <argument name="date">2015-04</argument>
    <argument name="view">CSI_XML</argument>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('http://localhost:',property('lavoisier.http.port'),'/lavoisier/OPSCORE_Render_Metrics/?date=',$date,'&amp;table=',$table,'&amp;view=',$view,'&amp;entity_type=',$entity_type,'&amp;entity_name=',$entity_name,'table=',$table,'&amp;accept=chart')"/>
        </connector>



    <serializer type="HTMLSerializer"/>

    <processors>



        <processor match="/html/head/META/meta/script" type="SelectProcessor"/>
        <remove match="/e:entries/script[@src]"/>
        <remove match="/e:entries" depth="1"/>
    </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">chart</parameter></renderer>
        </renderers>


</view>

</config>