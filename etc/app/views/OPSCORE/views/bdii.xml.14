<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" version="14">



    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_bdii_glue2">
        <info>
            <category>BDII</category>
            <description>List of service published into Glue2 Top Bdii</description>
        </info>
        <connector type="LDAPConnector">
            <parameter name="url">ldap://cclcgtopbdii01.in2p3.fr:2170</parameter>
            <parameter name="path">GLUE2GroupID=grid,o=glue</parameter>
            <parameter name="filter">objectclass=*</parameter>
        </connector>

        <processors>

            <remove match="/o/GLUE2GroupID/GLUE2DomainID/GLUE2DomainID" depth="1"/>

            <insert match="/o/GLUE2GroupID/GLUE2DomainID/GLUE2GroupID/GLUE2ServiceID" nodes="new_attribute('site', ancestor::GLUE2DomainID/@id)"/>

            <select match="/o/GLUE2GroupID/GLUE2DomainID/GLUE2GroupID/GLUE2ServiceID[GLUE2EndpointID/GLUE2PolicyID/GLUE2PolicyRule or GLUE2ServiceType]"/>

            <remove match="/e:entries/GLUE2ServiceID/GLUE2EndpointID/GLUE2PolicyID" depth="1"/>
            <remove match="/e:entries/GLUE2ServiceID/GLUE2EndpointID" depth="1"/>

            <remove match="/e:entries/GLUE2ServiceID/*[local-name()!='GLUE2ServiceType' and local-name()!='GLUE2PolicyRule' and local-name()!='GLUE2EntityOtherInfo']"/>

            <remove match="/e:entries/GLUE2ServiceID/GLUE2EntityOtherInfo[not(contains(text(),'InfoProviderHost'))]"/>

            <replace match="/e:entries/GLUE2ServiceID/GLUE2EntityOtherInfo/text()" nodes="substring-after(.,'InfoProviderHost=')"/>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="days">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="P1D" type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <!--<view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_bdii">-->
        <!--<info>-->
            <!--<category>BDII</category>-->
            <!--<description>List of service published into Glue2 Top Bdii</description>-->
        <!--</info>-->
        <!--<connector type="LDAPConnector">-->
            <!--<parameter name="url">ldap://cclcgtopbdii01.in2p3.fr:2170</parameter>-->
            <!--<parameter name="path">GLUE2GroupID=grid,o=glue</parameter>-->
            <!--<parameter name="filter">objectclass=*</parameter>-->
        <!--</connector>-->

        <!--<processors>-->
            <!--<element in="o" out="root">-->
                <!--<element-ignore in="GLUE2GroupID">-->
                    <!--<element in="GLUE2DomainID" out="site"></element>-->
                <!--</element-ignore>-->
                <!--<element-ignore></element-ignore>-->
            <!--</element>-->
        <!--</processors>-->

        <!--<cache type="IndexedFileCache">-->
            <!--<parameter name="index_depth">2</parameter>-->
            <!--<trigger type="ViewCreatedTrigger"></trigger>-->
        <!--</cache>-->

        <!--<renderers>-->
            <!--<renderer type="DefaultRenderer">-->
                <!--<parameter name="contentType">text/xml</parameter>-->
            <!--</renderer>-->
        <!--</renderers>-->
    <!--</view>-->

    <!--<view name="bdii_site">-->
        <!--<info>-->
            <!--<category>BDII</category>-->
            <!--<description>List of service published into Glue2 Top Bdii</description>-->
        <!--</info>-->
        <!--<argument name="site"></argument>-->
        <!--<connector type="XMLConnector">-->
            <!--<parameter name="content" eval="view_path('OPSCORE_bdii',concat('/root/site[@id=',quot($site),']/*'))"></parameter>-->
        <!--</connector>-->
    <!--</view>-->

    <!--<view name="bdii_service">-->
        <!--<info>-->
            <!--<category>BDII</category>-->
            <!--<description>List of service published into Glue2 Top Bdii</description>-->
        <!--</info>-->
        <!--<argument name="service"></argument>-->
        <!--<connector type="XMLConnector">-->
            <!--<parameter name="content" eval="view_path('OPSCORE_bdii',concat('/root/site/GLUE2GroupID/GLUE2ServiceID[@id=',quot($service),']/*'))"></parameter>-->
        <!--</connector>-->
    <!--</view>-->


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="OPSCORE_bdii_sites_vo">
        <info>
            <category>BDII</category>
            <description>List of service and VO published into Glue2 Top Bdii</description>
        </info>
        <argument name="site"/>
        <connector type="XMLConnector">
            <parameter name="content" eval="view_path('OPSCORE_bdii_glue2',concat('/*/GLUE2ServiceID[@site=',quot($site),']'))"/>
        </connector>
        <processors>

            <insert match="/e:entries/GLUE2ServiceID[GLUE2PolicyRule]" nodes="view_path('OPSCORE_bdii_glue2',concat('/*/GLUE2ServiceID[@site=',quot($site),']'))/e:entries/GLUE2ServiceID[@id=match()/@id]/GLUE2ServiceType"/>
            <insert match="/e:entries/GLUE2ServiceID[GLUE2EntityOtherInfo/text()]" nodes="new_attribute('hostname', choose(GLUE2EntityOtherInfo/text(),GLUE2EntityOtherInfo/text(),@id))"/>
            <remove match="/e:entries/GLUE2ServiceID[not(GLUE2PolicyRule)]"/>

            <!--<replace match="/e:entries/GLUE2ServiceID[GLUE2EntityOtherInfo[1][text()!='']]/@hostname"-->
                     <!--nodes="GLUE2EntityOtherInfo[1]/text()"/>-->

            <insert match="/e:entries/GLUE2ServiceID[*]" nodes="new_attribute('service_type', GLUE2ServiceType/text())"/>

            <insert match="/e:entries/GLUE2ServiceID[*]" nodes="new_attribute('NewId', concat(GLUE2ServiceType/text(),@hostname))"/>


            <remove match="/e:entries/GLUE2ServiceID/*[local-name()!='GLUE2PolicyRule']"/>

            <rename match="/e:entries/GLUE2ServiceID/GLUE2PolicyRule[contains(text(),'VO:')]" name="vo"/>
            <rename match="/e:entries/GLUE2ServiceID/GLUE2PolicyRule[contains(text(),'VOMS:')]" name="voms"/>

            <insert-parent match="/e:entries/GLUE2ServiceID/vo" name="vos"/>
            <insert-parent match="/e:entries/GLUE2ServiceID/voms" name="vomses"/>

            <!--<remove match="/e:entries/GLUE2ServiceID/vos/vo" depth="1"/>-->
            <!--<insert match="/e:entries/GLUE2ServiceID[*]" nodes="new_attribute('vos', choose(match()/vos/text(),match()/vos/text(),'NA'))"/>-->


            <insert match="/e:entries/GLUE2ServiceID[*]" nodes="new_attribute('vos', str:concat(match()/vos/vo/text()))"/>
            <remove match="/e:entries/GLUE2ServiceID/vos"/>

            <!--<remove match="/e:entries/GLUE2ServiceID/vomses/voms" depth="1"/>-->
            <insert match="/e:entries/GLUE2ServiceID[*]" nodes="new_attribute('vomses', str:concat(match()/vomses/voms/text()))"/>
            <remove match="/e:entries/GLUE2ServiceID/vomses"/>


            <rename match="/e:entries" name="bdii"/>

            <select match="/bdii/GLUE2ServiceID">
                <group by="@NewId"/>
            </select>



            <insert match="/bdii/e:entry[*]" nodes="new_attribute('hostname', choose(GLUE2ServiceID[1]/@hostname,GLUE2ServiceID[1]/@hostname,GLUE2ServiceID[1]/@id))"/>
            <insert match="/bdii/e:entry[*]" nodes="new_attribute('service_type', choose( GLUE2ServiceID[1]/@service_type,GLUE2ServiceID[1]/@service_type,'NA'))"/>


            <processor type="InsertProcessor" match="/bdii/e:entry[*]"><namespaces><entry key="str">http://exslt.org/strings</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces>
                
                

                
                <parameter name="nodes" eval="new_attribute('vos', str:concat(GLUE2ServiceID/@vos))"/>
            </processor>

            <processor type="InsertProcessor" match="/bdii/e:entry[*]"><namespaces><entry key="str">http://exslt.org/strings</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces>
                
                
                
                <parameter name="nodes" eval="new_attribute('vomses', str:concat(GLUE2ServiceID/@vomses))"/>
            </processor>

            <processor type="ChangeNamespaceProcessor" match="/bdii/e:entry"/>
            <remove match="/bdii/entry/*"/>
        </processors>
    </view>



    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_bdii_indexed">

        <info>
            <category>BDII</category>
            <description>List of service and VO published - cache indexed</description>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>

        <processors>
            <insert match="/NGIs/NGI/Sites/Site[* or not(*)]">
                <connector type="XMLConnector">
                    <parameter name="content" eval="view('OPSCORE_bdii_sites_vo',entry('site',parent_match()/@name))"/>
                </connector>
            </insert>
            <elements path="NGIs/NGI/Sites/Site/bdii/entry">
                <attribute-create out="vo">str:replace(current()/../@vos,'VO:',' ')</attribute-create>
                <attribute-create out="voms">str:replace(current()/../@vomses,'VOMS:',' ')</attribute-create>

            </elements>
        <processor match="/*" type="ChangeNamespaceProcessor"/>
        </processors>

        <cache type="IndexedFileCache">
            <parameter name="index_depth">2</parameter>
            <parameter name="xpath" eval="path(false())"/>
            <trigger type="ViewNotifiedTrigger"/>

            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
        </cache>

        <pre-renderers>

            <row foreach="/e:entries/Site/bdii/entry">
                <column label="ngi">ancestor::Site/@ngi</column>
                <column label="site">ancestor::Site/@name</column>
                <column label="HostName">@hostname</column>
                <column label="ServiceType">@service_type</column>
                <column label="VOs">@vo</column>
                <column label="VOMS">@voms</column>
            </row>
        </pre-renderers>
    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_resource_browser">

        <info>
            <category>BDII</category>
            <description>List of service and VO published - cache indexed - argument</description>
        </info>

        <argument name="entity" path-format="none">vo</argument>
        <argument name="entity_value" path-format="none">biomed</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_bdii_indexed')"/>
        </connector>


        <processors>
            <remove match="/NGIs/NGI[not(Sites/Site/bdii/entry[contains(@vos,concat('VO:',$entity_value)) or contains(@vomses,concat('VOMS:/',$entity_value))])]"/>
            <remove match="/NGIs/NGI/Sites/Site[not(bdii/entry[contains(@vos,concat('VO:',$entity_value)) or contains(@vomses,concat('VOMS:/',$entity_value))])]"/>

        </processors>


    </view>

    <view name="bdii_urls">
        <info>
            <category>cclavoisierfr</category>
            <description>List of Top BDII</description>
        </info>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.bdiilist')" />
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <serializer type="HTMLSerializer"></serializer>

        <processors>

                <processor match="//*" type="ChangeNamespaceProcessor"></processor>

            <select match="/html/body/div/div/table[position()=3]"></select>
            <remove match="/e:entries" depth="1"></remove>

            <remove match="/table/tr/td[position()=3]"></remove>
            <rename match="/table/tr/td[position()=1]" name="Ngi"></rename>
            <rename match="/table/tr/td[position()=1]" name="Bdiis"></rename>
            <insert-parent match="/table/tr/Bdiis/text()" name="hostname"></insert-parent>
            <rename match="/table/tr" name="Record"></rename>
            <remove match="/table/Record[not(Ngi)]"></remove>
            <remove match="/table/Record[not(Bdiis/hostname)]"></remove>
            <rename match="/table" name="BdiiList"></rename>

            <element in="BdiiList">
                <attribute-ignore></attribute-ignore>
                <element in="Record">
                    <element in="Ngi">
                        <attribute-ignore></attribute-ignore>
                        <text-ignore></text-ignore>
                        <text-create>normalize-space(../text())</text-create>
                    </element>
                    <element in="Bdiis">
                        <attribute-ignore></attribute-ignore>

                        <element in="hostname">
                            <text-ignore></text-ignore>
                            <text-create>normalize-space(../text())</text-create>
                        </element>
                    </element>

                </element>

            </element>

           
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">150</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

    </view>

    <view name="InsertBdii">
        <info>
            <category>BDII</category>
            <description>Insert bdii values into oracle</description>
        </info>
        <argument name="ngi"></argument>
        <argument name="site"></argument>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.insertbdii'),'?ngi=',$ngi,'&amp;site=',$site)" />
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="triggerInsertBdii"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <info>
            <category>BDII</category>
            <description>Trigger Inserts : bdii values into oracle</description>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_site_list_prod')"></parameter>
        </connector>

        <processors>
            <element in="e:entries" out="results">
                <element in="e:entries">
                    <attribute-create out="ngi" >../e:entry[@key='ngi']/text()</attribute-create>
                    <attribute-create out="site" >../e:entry[@key='site']/text()</attribute-create>
                    <element-create>view('InsertBdii',entry('ngi',../e:entry[@key='ngi']/text())|entry('site',../e:entry[@key='site']/text()))</element-create>
                    <element-ignore></element-ignore>
                </element>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">3</parameter>
                <parameter name="minute">25</parameter>
            </trigger>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

</config>