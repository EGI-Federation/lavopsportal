<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" version="14">



    <view name="OPSCORE_notify_downtimes">

        <info>
            <category>Downtimes</category>
            <description>notify people with downtime info</description>
        </info>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.notify.downtimes')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="connect-timeout">30</parameter>
            <parameter name="read-timeout">30</parameter>
        </connector>

        <serializer type="JSONSerializer"></serializer>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>



    </view>

    <view name="OPSCORE_downtime_ongoing_raw">
        <info>
            <category>Downtimes</category>
            <description>get_downtime (ongoing) method raw</description>
        </info>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_downtime_ongoing')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_downtime_ongoing">
        <info>
            <category>Downtimes</category>
            <description>get_downtime (ongoing) method sauce entries entry</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_downtime_ongoing_raw')"/>
        </connector>

        <processors>

            <move match="/results/DOWNTIME/@*[local-name()!='PRIMARY_KEY']">
                <to-following-sibling/>
            </move>
            <rename match="/results/DOWNTIME/@*[local-name()='PRIMARY_KEY']" name="key"/>
            <replace match="/results/DOWNTIME/*[text()]" nodes="entry(local-name(), .)"/>
            <rename match="/results/DOWNTIME" name="e:entries"/>
            <rename match="/results" name="e:entries"/>

            <insert
                    match="/e:entries/e:entries[*]"
                    nodes="entry('NGI',choose(
                    view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='HOSTED_BY']/text()]/@key,
                    view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='HOSTED_BY']/text()]/@key,
                    'NA'))">

            </insert>

            <select match="/e:entries/e:entries[*]">
                <group by="@key"/>
            </select>

            <merge match="/e:entries/e:entry"/>
            <remove match="/e:entries/e:entry/e:entries/e:entry[@key!='HOSTNAME' and @key!='SERVICE_TYPE']"/>
            <insert match="/e:entries/e:entry/e:entries[*]" nodes="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'***',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/>
            <insert match="/e:entries/e:entry[*]" nodes="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'***',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/>
            <remove match="/e:entries/e:entry/e:entries" depth="1"/>
            <remove match="/e:entries/e:entry/e:entry[@key='HOSTNAME' or @key='SERVICE_TYPE' or @key='ENDPOINT']"/>
            <insert-parent match="/e:entries/e:entry/e:entry[@key='SERVICE']" name="e:entries"/>

            <insert match="/e:entries/e:entry/e:entries" nodes="new_attribute('key','ENDPOINTS')"/>
            <remove match="/e:entries/e:entry/e:entries/e:entry/@*"/>
            <insert match="/e:entries/e:entry[*]" nodes="entry('CLASSIFICATION',new_text(match()/@CLASSIFICATION))" as="first_child"></insert>


            <elements path="e:entries/e:entry">
                <element-ignore in="AFFECTED_ENDPOINTS"></element-ignore>
                <element-ignore in="e:entries">
                    <element in="e:entry">
                       <attribute-create out="key">'endpoint'</attribute-create>
                    </element>
                </element-ignore>
            </elements>

            <elements path="e:entries/e:entry">
                    <element-create-as-parent out="e:entries" attributes="new_attribute('key','ENDPOINTS')">
                        <element in="e:entry" if="@key='endpoint'">
                        <attribute-ignore in="key"></attribute-ignore>
                        </element>
                    </element-create-as-parent>
             </elements>


            <!--<elements path="e:entries/e:entry">-->
                <!--<element-create>entries('ENDPOINTS',new_text(../text()))</element-create>-->

            <!--</elements>-->
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_downtime_ongoing_raw</entry>
                    <!-- OPSCORE_prod_entities :  because dependency : OPSCORE_entities_map with no cache-->
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
                <parameter name="all">true</parameter>
            </trigger>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_get_downtimes_forDNS">
        <info>
            <category>Downtimes</category>
            <description>get_downtime list for the DNS</description>
        </info>
        <connector type="XMLConnector"><parameter name="content" eval="new_element('results')"/></connector>

        <processors>

            <element in="results">
                <set variable="downtimeslist1" index="concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())">view('OPSCORE_get_downtime_to_broadcast')/results/DOWNTIME</set>
                <set variable="downtimeslist2" >view('OPSCORE_downtime_ongoing_raw')/results/DOWNTIME</set>

                <element-create>$downtimeslist1</element-create>
                <element-create>$downtimeslist2[not(find($downtimeslist1,concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())))]</element-create>
            </element>

            <element in="results">
                <element in="DOWNTIME">
                    <element-create if="not(../SITENAME)">new_element('SITENAME',../HOSTED_BY/text())</element-create>
                </element>
            </element>

        </processors>

    </view>

    <view name="OPSCORE_get_downtime_to_broadcast">
            <info>
                <category>Downtimes</category>
                <description>get_downtime to_broadcast</description>
            </info>
            <connector type="HTTPConnector">
                <parameter name="url" eval="property('OPSCORE.gocdb.get_downtime_to_broadcast')"/>
                <parameter name="certificate" eval="property('certificate.path')"/>
                <parameter name="passphrase" eval="property('certificate.password')"/>
            </connector>


        <processors>
            <element in="results">
                <element-ignore in="DOWNTIME"></element-ignore>
                <element-create>uniq(../DOWNTIME,'concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())')</element-create>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"></trigger>
        </cache>
    </view>



    <view name="OPSCORE_downtime_new" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" >
        <info>
            <category>Downtimes</category>
            <description>get_downtime (ongoing) method sauce entries entry</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_downtimes_forDNS')"/>
        </connector>

        <processors>

            <move match="/results/DOWNTIME/@*[local-name()!='PRIMARY_KEY']">
                <to-following-sibling/>
            </move>
            <rename match="/results/DOWNTIME/@*[local-name()='PRIMARY_KEY']" name="key"/>
            <replace match="/results/DOWNTIME/*[text()]" nodes="entry(local-name(), .)"/>
            <rename match="/results/DOWNTIME" name="e:entries"/>
            <rename match="/results" name="e:entries"/>

            <insert
                    match="/e:entries/e:entries[*]"
                    nodes="entry('NGI',choose(
                    view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='SITENAME']/text()]/@key,
                    view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='SITENAME']/text()]/@key,
                    'NA'))">

            </insert>

            <select match="/e:entries/e:entries[*]">
                <group by="@key"/>
            </select>

            <merge match="/e:entries/e:entry"/>
            <remove match="/e:entries/e:entry/e:entries/e:entry[@key!='HOSTNAME' and @key!='SERVICE_TYPE']"/>
            <insert match="/e:entries/e:entry/e:entries[*]" nodes="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'::',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/>
            <insert match="/e:entries/e:entry[*]" nodes="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'::',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/>
            <remove match="/e:entries/e:entry/e:entries" depth="1"/>
            <remove match="/e:entries/e:entry/e:entry[@key='HOSTNAME' or @key='SERVICE_TYPE' or @key='ENDPOINT']"/>
            <insert-parent match="/e:entries/e:entry/e:entry[@key='SERVICE']" name="e:entries"/>

            <insert match="/e:entries/e:entry/e:entries" nodes="new_attribute('key','ENDPOINTS')"/>
            <remove match="/e:entries/e:entry/e:entries/e:entry/@*"/>
            <insert match="/e:entries/e:entry[*]" nodes="entry('CLASSIFICATION',new_text(match()/@CLASSIFICATION))" as="first_child"></insert>


            <elements path="e:entries/e:entry">
                <element-ignore in="AFFECTED_ENDPOINTS"></element-ignore>
                <element-ignore in="BROADCASTING_START_DOWNTIME"></element-ignore>
                <element-ignore in="e:entries">
                    <element in="e:entry">
                        <attribute-create out="key">'endpoint'</attribute-create>
                    </element>
                </element-ignore>
            </elements>

            <elements path="e:entries/e:entry">

                <element-create-as-parent out="e:entries" attributes="new_attribute('key','ENDPOINTS')">
                    <element in="e:entry" if="@key='endpoint'">
                        <attribute-ignore in="key"></attribute-ignore>
                    </element>
                </element-create-as-parent>


            </elements>

            <element in="e:entries">
                <set variable="VAPOR_Endpoints_Policy">view('VAPOR_Endpoints_Policy')</set>
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                            <element-create>$VAPOR_Endpoints_Policy/e:entries/e:entries[contains(@id,substring-before(current()/../text(),'::'))]/VO</element-create>
                        </element>
                    </element>
                </element>

            </element>



            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                            <text-ignore></text-ignore>
                            <text-create>concat(normalize-space(../text()),",")</text-create>
                            <element-ignore in="VO"></element-ignore>
                            <element-create>uniq(../VO,"text()")</element-create>

                        </element>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                           <element in="VO">
                               <text-ignore></text-ignore>
                               <text-create>concat(normalize-space(../text()),",")</text-create>
                           </element>
                        </element>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element-create>entry('hosts',new_text(str:concat(../e:entry/text())))</element-create>
                        <element-create>entry('vos',new_text(str:concat(../e:entry/VO/text())))</element-create>
                        <element-ignore></element-ignore>
                    </element>
                </element>


            </element>

            <element in="e:entries">


                <element in="e:entry">
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi','ALL')|entry('site','ALL')|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site','ALL')|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site',../e:entry[@key='SITENAME'])|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>

                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site',../e:entry[@key='SITENAME'])|entry('node',../e:entries[@key='ENDPOINTS']/e:entry[@key='hosts']/text())|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>

                </element>

            </element>


            <element in="e:entries">
                    <element in="e:entry" out="e:entries">
                        <element-create-as-parent out="e:entries" attributes="@key">
                            <element in="e:entries" if="@key='targets'"></element>
                        </element-create-as-parent>
                    </element>
            </element>

            <element in="e:entries">
            <element in="e:entries">
                    <element in="e:entries" if="@key='targets'">
                        <element-ignore>
                            <element></element>
                        </element-ignore>
                    </element>
            </element>
            </element>



        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_downtime_count">
        <info>
            <category>Downtimes</category>
        </info>

        <argument name="entity_type" pattern="ngi|site|all"/>
        <argument name="entity_parent">none</argument>
        <argument name="prepath">/*/*</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view_path('OPSCORE_downtime_ongoing',$prepath)"/>
        </connector>

        <processors>

            <insert match="/e:entries/e:entry[*]" nodes="new_attribute('site',e:entry[@key='HOSTED_BY']/text())"/>
            <insert match="/e:entries/e:entry[*]" nodes="new_attribute('ngi',e:entry[@key='NGI']/text())"/>

            <processor type="RemoveProcessor" disabled="$entity_parent = 'none' " match="/e:entries/e:entry[@ngi!=$entity_parent]"/>

            <processor type="SelectGroupByProcessor" disabled="$entity_type = 'ngi' " match="/e:entries/e:entry">
                <parameter name="group_by" eval="@site"/>
            </processor>

            <processor type="SelectGroupByProcessor" disabled="$entity_type = 'site' " match="/e:entries/e:entry">
                <parameter name="group_by" eval="@ngi"/>
            </processor>


            <aggregate match="/e:entries/e:entry" function="count">
                <to-last-child name="count" values="e:entry"/>
            </aggregate>

            <remove match="/e:entries/e:entry/e:entry"/>
            <replace match="/e:entries/e:entry/e:count[text()]" nodes="text()"/>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_DOWNTIME_2_cache">
        <info>
            <category>Downtimes</category>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_2')"></parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_2</entry>
                </parameter>
            </trigger>
        </cache>
    </view>

    <view name="OPSCORE_DOWNTIME_2" xmlns:date="http://exslt.org/dates-and-times" post-processors="downtime">
    <info>
        <category>Downtimes</category>
    </info>


        <variable name="th_month_ago" eval="substring(date:add(date:date(),'-P90D'),0,11)"></variable>
        <variable name="th_month_after" eval="substring(date:add(date:date(),'P90D'),0,11)"></variable>
        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P90D'))"></variable>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P90D'))"></variable>



        <connector type="HTTPConnector">
            <parameter name="url" eval="
                concat(property('OPSCORE.gocdb.get_downtime'),'&amp;windowstart=',$th_month_ago,'&amp;windowend=',$th_month_after)"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>

                    <!-- Trick : for the timeline we check that the start date is not before the reference date
                    and that the end date is not after the reference date . This aim is to show only into the chart the part corresponding
                    to the reference period .
                    -->

                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_end</text-create>
                    </element>


                </element>

            </element>


        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_DOWNTIME_1_cache">
        <info>
            <category>Downtimes</category>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_1')"></parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_1</entry>
                </parameter>
            </trigger>
        </cache>
    </view>

    <view name="OPSCORE_DOWNTIME_1" post-processors="downtime" xmlns:date="http://exslt.org/dates-and-times" >
        <info>
            <category>Downtimes</category>
        </info>


        <variable name="one_month_ago" eval="substring(date:add(date:date(),'-P30D'),0,11)"></variable>
        <variable name="one_month_after" eval="substring(date:add(date:date(),'P30D'),0,11)"></variable>

        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P30D'))"></variable>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P30D'))"></variable>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_downtime'),'&amp;windowstart=',$one_month_ago,'&amp;windowend=',$one_month_after)"></parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>
                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_end</text-create>
                    </element>

                </element>

            </element>



        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_DOWNTIME_3_cache">
        <info>
            <category>Downtimes</category>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_3')"></parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_3</entry>
                </parameter>
            </trigger>
        </cache>
    </view>


    <view name="OPSCORE_DOWNTIME_3" post-processors="downtime" xmlns:date="http://exslt.org/dates-and-times">
        <info>
            <category>Downtimes</category>
        </info>


        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P60D'))"></variable>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P60D'))"></variable>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_downtime'),'&amp;ongoing_only=yes')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',
                        choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),
                        $sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>

                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore></text-ignore>
                        <text-create>$date_limit_end</text-create>
                    </element>

                </element>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>




    <view name="OPSCORE_DOWNTIME_FILTER" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <info>
            <category>Downtimes</category>
        </info>
        <argument name="ngi">_NGI_</argument>
        <argument name="site">_SITE_</argument>
        <argument name="tier">_TIER_</argument>
        <argument name="vo">_VO_</argument>
        <argument name="period">1</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="choose($period=1,
            view('OPSCORE_DOWNTIME_1_cache'),
                choose($period=2,view('OPSCORE_DOWNTIME_2_cache'),view('OPSCORE_DOWNTIME_3_cache')))"></parameter>
        </connector>

        <processors>

            <element in="e:entries">
                <element-ignore in="e:entries" if="$ngi!='_NGI_' and e:entry[@key='NGI']/text()!=$ngi"></element-ignore>
                <element-ignore in="e:entries" if="$site!='_SITE_' and e:entry[@key='SITE']/text()!=$site"></element-ignore>
                <element-ignore in="e:entries" if="$tier!='_TIER_' and e:entry[@key='TIER']/text()!=$tier"></element-ignore>
                <element-ignore in="e:entries" if="$vo!='_VO_' and not(e:entries[@key='vos']/e:entry/text()=$vo)"></element-ignore>
            </element>



        </processors>
        <pre-renderers>
            <row foreach="/e:entries/e:entries">
                <column label="NGI">e:entry[6]/text()</column>
                <column label="SITE">e:entry[7]/text()</column>
                <column label="START">e:entry[4]/text()</column>
                <column label="END">e:entry[5]/text()</column>
                <column label="INSERT">e:entry[9]/text()</column>
                <column label="CLASSIFICATION">e:entry[8]/text()</column>
                <column label="SEVERITY">e:entry[2]/text()</column>
                <column label="GOCDBURL">e:entry[1]/text()</column>
                <column label="DESCRIPTION">e:entry[3]/text()</column>
                <column label="ENDPOINTS">normalize-space(e:entry[10]/text())</column>
            </row>
        </pre-renderers>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_DOWNTIME_SUBSCRIPTION">

        <info>
            <category>Downtimes</category>
        </info>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('ROD.db.url')"/>
            <parameter name="username" eval="property('ROD.db.username')"/>
            <parameter name="password" eval="property('ROD.db.password')"/>
            <parameter name="query">
                SELECT ds.id, dc.value, dc.type, ds.region , ds.site , ds.node , ds.vo , ds.adding , ds.beginning, ds.ending from dt_subscription ds, dt_communication dc where ds.is_active=1 and dc.type IN (0,1) and dc.subscription_id=ds.id

            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">35</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER">

        <info>
            <category>Downtimes</category>
        </info>

        <argument name="ngi"></argument>
        <argument name="site"></argument>
        <argument name="node"></argument>
        <argument name="vo"></argument>


        <connector type="XMLConnector">
         <parameter name="content" eval="view('OPSCORE_DOWNTIME_SUBSCRIPTION')"></parameter>
     </connector>


        <processors>

            <element in="result" out="e:entries">
                <attribute-create out="key">'targets'</attribute-create>
                <element in="row" if="region/text()=$ngi and site/text()=$site and contains($node,node/text()) and  ( vo/text()='ALL')"></element>
                <element in="row" if="region/text()=$ngi and site/text()=$site and contains($node,node/text()) and  ( contains($vo,concat(vo/text(),',')))"></element>

                <element-ignore></element-ignore>

            </element>

            <element in="e:entries">
                <element in="row" out="e:entries">
                    <attribute in="key">'subscription'</attribute>
                   <element-ignore>
                       <element-create>entry(name(..),choose(../text(),../text(),'anonymous@anonymous.fr'))</element-create>
                   </element-ignore>

                </element>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <processors name="downtime" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times"  xmlns:str="http://exslt.org/strings">

        <element in="results">
            <element-ignore in="DOWNTIME"></element-ignore>
            <element-create>sort_by_string(../DOWNTIME,'@PRIMARY_KEY')</element-create>
        </element>

        <element in="results">
            <element-create-as-parent out="entries" group-by="@PRIMARY_KEY" attributes="@*">
                <element in="DOWNTIME"> </element>
            </element-create-as-parent>
        </element>


        <element in="results">
            <element in="entries">
                <element-create as="first-child">entry('GOCDB_PORTAL_URL',str:concat(../DOWNTIME[1]/GOCDB_PORTAL_URL/text()))</element-create>
                <element-create as="first-child">entry('SEVERITY',../DOWNTIME[1]/SEVERITY/text())</element-create>
                <element-create as="first-child">entry('DESCRIPTION',../DOWNTIME[1]/DESCRIPTION/text())</element-create>
                <element-create as="first-child">entry('FORMATED_START_DATE',../DOWNTIME[1]/FORMATED_START_DATE/text())</element-create>
                <element-create as="first-child">entry('FORMATED_END_DATE',../DOWNTIME[1]/FORMATED_END_DATE/text())</element-create>
                <element-create as="first-child">entry('START_DATE',../DOWNTIME[1]/START_DATE/text())</element-create>
                <element-create as="first-child">entry('END_DATE',../DOWNTIME[1]/END_DATE/text())</element-create>
                <element-create as="first-child">entry('NGI',choose(../DOWNTIME[1]/NGI/text(),../DOWNTIME[1]/NGI/text(),'NA'))</element-create>
                <element-create as="first-child">entry('SITE',../DOWNTIME[1]/HOSTED_BY/text())</element-create>
                <element-create as="first-child">entry('TIER',str:concat(../DOWNTIME[1]/TIER/text()))</element-create>
                <element-create as="first-child">entry('CLASSIFICATION',../DOWNTIME[1]/@CLASSIFICATION)</element-create>
                <element-create as="first-child">entry('INSERT_DATE',date:format-date(date:add('1970-01-01T00:00:00',concat('PT',../DOWNTIME[1]/INSERT_DATE/text(),'S')),'yyyy-MM-dd HH:mm'))</element-create>


                <element in="DOWNTIME" >
                    <attribute-ignore></attribute-ignore>
                    <element if="name()='HOSTNAME' or name()='SERVICE_TYPE' or name()='AFFECTED_ENDPOINTS'"></element>
                    <element-ignore></element-ignore>
                </element>


            </element>

        </element>

        <element in="results" out="e:entries">
            <element in="entries" out="e:entries">

                <element-create-as-parent out="e:entries">
                    <element in="DOWNTIME"  out="e:entries">
                        <element-create>
                            new_element('entity',new_attribute('key','entities')|new_text(concat(' ',../HOSTNAME/text(),'-',../SERVICE_TYPE/text(),' ')))
                        </element-create>
                        <element in="HOSTNAME" out="host">
                            <attribute-create out="key">'host'</attribute-create>
                        </element>
                        <element-ignore></element-ignore>
                    </element>
                </element-create-as-parent>
            </element>
        </element>

        <elements path="e:entries/e:entries">
            <element in="e:entries">
                <element-ignore in="e:entries">
                    <element></element>
                </element-ignore>
            </element>
        </elements>

        <elements path="e:entries/e:entries/e:entries">
            <element-ignore></element-ignore>
            <element-create>
                sort_by_string(../*,'name()')
            </element-create>
        </elements>

        <elements path="e:entries/e:entries/e:entries">
            <element-ignore></element-ignore>
            <element-create>
                uniq(../*,'text()')
            </element-create>
        </elements>

        <elements path="e:entries/e:entries/e:entries">
            <element-create-as-parent out="e:entries" attributes="@*">
                <element in="host"></element>
            </element-create-as-parent>

            <element-create-as-parent out="e:entries" attributes="@*">
                <element in="entity" out="e:entry">
                    <attribute-ignore></attribute-ignore>
                </element>
            </element-create-as-parent>
        </elements>

        <elements path="e:entries/e:entries">
            <element-ignore in="e:entries">
                <element in="e:entries"></element>
            </element-ignore>
        </elements>






        <elements path="e:entries/e:entries">
            <element-create>entry('Endpoints',str:concat(../e:entries[@key='entities']/e:entry/text()))</element-create>
        </elements>


        <element in="e:entries">
            <set variable="VAPOR_Endpoints_Policy">view('VAPOR_Endpoints_Policy')/*</set>
            <element in="e:entries">
                <element in="e:entries" if="@key='host'">
                    <element in="host">
                        <element-create>$VAPOR_Endpoints_Policy/e:entries[contains(@id,current()/../text()) and string-length(current()/../text()) &gt; 3 and VO]/VO</element-create>
                    </element>

                </element>
            </element>

        </element>

        <elements path="e:entries/e:entries">
            <element-ignore in="e:entries" if="@key='host'">
                <element-ignore in="host">
                    <element in="VO"></element>
                </element-ignore>
            </element-ignore>
        </elements>
        <elements path="e:entries/e:entries">
            <element-ignore in="VO"></element-ignore>
            <element-create>uniq(../VO,'text()')</element-create>
        </elements>
        <elements path="e:entries/e:entries">
                <element-create-as-parent out="e:entries">
                    <element in="VO" out="e:entry">
                        <attribute-create out="key">'vo'</attribute-create>
                    </element>
                </element-create-as-parent>
            </elements>


        <elements path="e:entries/e:entries">
            <element in="e:entries" if="e:entry[@key='vo']">
                <attribute-create out="key">'vos'</attribute-create>
                <element in="e:entry">
                    <attribute-ignore></attribute-ignore>
                </element>
            </element>
        </elements>
    </processors>



</config>