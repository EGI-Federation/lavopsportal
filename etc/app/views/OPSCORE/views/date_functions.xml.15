<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" version="15">

    <view xmlns:date="http://exslt.org/dates-and-times" name="UTC-now"><namespace prefix="date" uri="http://exslt.org/dates-and-times"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <argument name="format">yyyy-MM-dd HH:mm:ss</argument>
        <connector type="StringConnector">
            <parameter name="content" eval="date:format-date( date:add(date:date-time(),concat('PT',substring(date:date-time(),21, 2) ,'H')), property('date_format'))"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>

    </view>

    <view name="P-extract-mapping">
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="year"/>
                <entry key="month">Y([0-9]+)</entry>
                <entry key="day"/>
                <entry key="hour"/>
                <entry key="min"/>
            </parameter>
        </connector>
    </view>

    <view xmlns:regexp="http://exslt.org/regular-expressions" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="P-extract"><namespace prefix="regexp" uri="http://exslt.org/regular-expressions"/><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <namespace uri="http://software.in2p3.fr/lavoisier/entries.xsd" prefix="e"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <argument name="P-duration"/>
        <argument name="P-separator"/>
        <connector type="StringConnector">
            <parameter name="content" eval="regexp:match($P-duration,     view('P-extract-mapping')/e:entries/e:entry[@key=$P-separator])[2]"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
    </view>

    <!-- @usage :avoisier-standalone-execute.bat date_after_we/2013-08-17T00:00:00 => 2013-08-19T00:00:00 -->
    <view xmlns:date="http://exslt.org/dates-and-times" name="date_after_we"><namespace prefix="date" uri="http://exslt.org/dates-and-times"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <argument name="date"/>
        <argument name="date_format">yyyy-MM-dd'T'HH:mm:ss</argument>
        <connector type="StringConnector">
            <parameter name="content" eval=" choose(date:day-in-week($date)=7,  date:format-date(date:add($date,'P2D'), property('date_format')),                               choose(date:day-in-week($date)=1,  date:format-date(date:add($date,'P1D'),  property('date_format')), $date  ))"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
    </view>

    <!-- @usage: lavoisier-standalone-execute.bat date_before_we/2013-08-17T00:00:00  => 2013-08-15T00:00:00 -->
    <view xmlns:date="http://exslt.org/dates-and-times" name="date_before_we"><namespace prefix="date" uri="http://exslt.org/dates-and-times"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <argument name="date"/>
        <argument name="date_format">yyyy-MM-dd'T'HH:mm:ss</argument>
        <connector type="StringConnector">
            <parameter name="content" eval="choose(date:day-in-week($date)=7,  date:format-date(date:add($date,'-P2D'), property('date_format')), choose(date:day-in-week($date)=1,  date:format-date(date:add($date,'-P1D'), property('date_format')), $date ))"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
    </view>

   
    
    <!-- valid for one week only : NOT GENERIC CASE-->
    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="S-oneweek-diffWWE"><namespace prefix="date" uri="http://exslt.org/dates-and-times"/><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions : Diff. in P format between 2 dates wwe</description>
        </info>
        <argument name="date_start"/>
        <argument name="date_end"/>
        <connector type="StringConnector">
            <parameter name="content" eval="date:seconds(view('date_before_we', entry('date',$date_end))) -  date:seconds(view('date_after_we', entry('date',$date_start)))"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
        <processors>
            <replace match="/e:entries/e:entry[number(text()) &lt; 0]" nodes="'0'"/>
        </processors>
    </view>

    <view name="diffWWE-granularity-mapping">
        <info>
            <category>Hidden</category>
            <description>DATE functions</description>
        </info>
        <connector type="XMLConnector">
            <parameter name="content">
                <entry key="second">1</entry>
                <entry key="minute">60</entry>
                <entry key="hour">3600</entry>
                <entry key="day">86400</entry>
                <entry key="month">2592000</entry>
            </parameter>
        </connector>
    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="diffWWE-second"><namespace prefix="date" uri="http://exslt.org/dates-and-times"/><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions : Diff. in S between 2 dates wwe</description>
        </info>
        <argument name="date_start"/>
        <argument name="date_end"/>
        <connector type="StringConnector">
            <parameter name="content" eval="view('S-oneweek-diffWWE', arguments()) -((view('S-oneweek-diffWWE', arguments()) div 7) + choose(date:day-in-week($date_start) &gt; date:day-in-week($date_end) , 1 , 0)*2*24*3600)"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
    </view>

    <!-- @usage : http://ccleol:8080/lavoisier/diffWWE/2012-10-03T00:00:00/2012-10-09T00:00:00/day -->
    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="diffWWE"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Hidden</category>
            <description>DATE functions : Diff. with given granularity between 2 dates wwe</description>
        </info>
        <argument name="date_start"/>
        <argument name="date_end"/>
        <argument name="granularity"/>
        <connector type="StringConnector">
            <parameter name="content" eval="round(view('diffWWE-second', entry('date_start',$date_start)| entry('date_end',$date_end))div  view('diffWWE-granularity-mapping')/e:entries/e:entry[@key=$granularity]/text())"/>
        </connector>
        <serializer type="EncapsulateSerializer"/>
    </view>
</config>