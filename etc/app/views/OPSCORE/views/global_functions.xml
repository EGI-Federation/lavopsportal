<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" version="16">


    <view name="OPSCORE_lastupdate_table">
        <info>
            <category>OPSCORE</category>
            <description>Retrieve last updated record date into the table</description>
        </info>

        <argument name="table"/>
       <connector type="SQLConnector">
           <parameter name="driver">com.mysql.jdbc.Driver</parameter>
           <parameter name="url" eval="property('OPSCORE.db.url')"/>
           <parameter name="username" eval="property('OPSCORE.db.username')"/>
           <parameter name="password" eval="property('OPSCORE.db.password')"/>

           <parameter name="query">SELECT max(updated_at) FROM
               <entry eval="$table"/>
           </parameter>
       </connector>
    </view>


    <view name="OPSCORE_portal_cron">
        <info>
            <type>cron</type>
            <category>Hidden</category>
            <description>OpsPortal Cron facade</description>
        </info>
        <argument name="url"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>


            <!--optional: timeout (in seconds) for connecting (Integer)-->
            <parameter name="connect-timeout">600</parameter>

            <!--optional: timeout (in seconds) for reading (Integer)-->
            <parameter name="read-timeout">600</parameter>

            <!--optional: If false, the HTTP redirection will be forbidden between different protocols (http / https) (Boolean)-->
            <parameter name="force-redirect">true</parameter>

            <fallback eval="new_element('PORTAL_SCRIPT_NOT_REACHABLE',new_attribute('url', $url))">
                <exception type="java.io.FileNotFoundException"/>
            </fallback>
        </connector>
    </view>


    <view name="OPSCORE_portal_cron_sendMail">
        <info>
            <!--<type>cron</type>-->
            <category>CRON PORTAL</category>
            <description>OpsPortal Cron facade</description>
        </info>
        <argument name="url"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.sendMail.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>


            <!--optional: timeout (in seconds) for connecting (Integer)-->
            <parameter name="connect-timeout">600</parameter>

            <!--optional: timeout (in seconds) for reading (Integer)-->
            <parameter name="read-timeout">600</parameter>

            <!--optional: If false, the HTTP redirection will be forbidden between different protocols (http / https) (Boolean)-->
            <parameter name="force-redirect">true</parameter>


        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <!--<trigger type="ViewCreatedTrigger"/>-->
        </cache>

    </view>

    <view name="OPSCORE_portal_spoolMail">
        <info>
            <!--<type>cron</type>-->
            <category>CRON PORTAL</category>
            <description>OpsPortal Cron facade</description>
        </info>
        <argument name="url"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.sendSpool.url')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>


            <!--optional: timeout (in seconds) for connecting (Integer)-->
            <parameter name="connect-timeout">600</parameter>

            <!--optional: timeout (in seconds) for reading (Integer)-->
            <parameter name="read-timeout">600</parameter>

            <!--optional: If false, the HTTP redirection will be forbidden between different protocols (http / https) (Boolean)-->
            <parameter name="force-redirect">true</parameter>


        </connector>

        <serializer type="EncapsulateSerializer"/>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
            <parameter name="minutes">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <!--<trigger type="ViewCreatedTrigger"/>-->
        </cache>

    </view>


    <view name="OPSCORE_VaporReleases">
        <info>
            <category>Release Note</category>
            <description>get list of issues on gitlab</description>
        </info>

        <argument name="name">_RNAME_</argument>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://gitlab.in2p3.fr/opsportal/app_vapor/issues.atom?private_token=',property('gitlab.token'),'&amp;scope=all&amp;state=opened')"/>
        </connector>

        <processors>
            <processor match="//*" type="ChangeNamespaceProcessor"/>

                <element in="feed" out="e:entries">
                    <attribute-create out="key">'issues'</attribute-create>
                    <element in="entry" out="e:entries" if="milestone/text()=$name or $name='_RNAME_'">
                        <attribute-create out="key">concat('issue_',substring-after(substring(../id/text(),string-length(../id/text())-4),'/'))</attribute-create>

                        <element in="link" out="e:entry">
                            <attribute-create out="key">'link'</attribute-create>
                            <attribute-ignore/>

                            <text-create>../@href</text-create>
                        </element>

                        <element in="title" out="e:entry">
                            <attribute-create out="key">'title'</attribute-create>
                        </element>

                        <element in="description" out="e:entry">
                            <attribute-create out="key">'description'</attribute-create>
                        </element>

                        <element in="author" out="e:entry">
                            <attribute-create out="key">'author'</attribute-create>
                            <text-create>../name/text()</text-create>
                            <element-ignore/>
                        </element>

                        <element in="milestone" out="e:entry">
                            <attribute-create out="key">'release'</attribute-create>
                        </element>

                        <element in="labels" out="e:entries">
                            <attribute-create out="key">'labels'</attribute-create>

                            <element in="label" out="e:entry">
                                <attribute-create out="key">../text()</attribute-create>
                            </element>
                        </element>

                        <element-ignore/>

                    </element>
                    <element-ignore/>
                </element>


        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_VaporReleaseList">

        <info>
            <category>Release Note</category>
            <description>get list of release note on gitlab</description>
        </info>

        <argument name="name">_RNAME_</argument>


        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v3/projects/1274/milestones</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <element-ignore in="array">
                    <element-ignore in="item">
                        <element in="object" out="e:entries">

                            <attribute-create out="key">concat('release',../@id)</attribute-create>
                            <attribute-ignore/>

                            <element-create>entry('id',../@id)</element-create>
                            <element-create>entry('name',../@title)</element-create>
                            <element-create>entry('due_date',../@due_date)</element-create>

                        </element>
                    </element-ignore>
                </element-ignore>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_VaporIssuesList">


        <info>
            <category>Release Note</category>
            <description>get list of issues on gitlab</description>
        </info>

        <argument name="name">_RNAME_</argument>

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v3/projects/1274/issues</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <element-ignore in="array">
                    <element-ignore in="item">
                        <element in="object" out="e:entries" if="milestone/object/@title=$name or $name='_RNAME_'">
                            <attribute-create out="key">concat('issue_',../@id)</attribute-create>
                            <attribute-ignore/>

                            <element-create>entry('id',../@id)</element-create>
                            <element-create>entry('link',../@web_url)</element-create>
                            <element-create>entry('title',../@title)</element-create>
                            <element-create>entry('description',../@description)</element-create>
                            <element-create>entry('author',../author/object/@name)</element-create>
                            <element-create>entry('state',../@state)</element-create>
                            <element-create if="milestone/object/@title">entry('release',../milestone/object/@title)</element-create>




                            <element in="labels" out="e:entries">
                                <attribute-create out="key">'labels'</attribute-create>

                                <element in="item" out="e:entry">
                                    <attribute-create out="key">../text()</attribute-create>
                                </element>
                            </element>
                            <element-ignore/>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>
        </processors>
    </view>

    <!--curl &#45;&#45;header "PRIVATE-TOKEN: BKsU4sDqQPuzLjs38Nzz" https://gitlab.example.com/api/v3/projects/5/milestones-->

    <view xmlns:html="http://www.w3.org/1999/xhtml" name="OPSCORE_listReleases">
        <info>
            <category>Release Note</category>
            <description>get list of release note on forge</description>
        </info>

        <argument name="vapor">false</argument>
        <connector type="HTTPConnector">
            <parameter name="url">https://forge.in2p3.fr/rb/releases/opsportaluser</parameter>
        </connector>
        <serializer type="HTMLSerializer"/>
        <processors>
        
                <processor match="//*" type="ChangeNamespaceProcessor"/>
          
            <processor match="/html/body/div/div/div/div[@id='main']/div[@id='content']/div[@class='model release']" type="SelectProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>

            <processor match="/e:entries/div/h3/a[text()]" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('number', text())"/></processor>
            <processor match="/e:entries/div/p[b/text() = 'Release start date:']/text()" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('start_date', .)"/></processor>
            <processor match="/e:entries/div/p[b/text() = 'Release end date:']/text()" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('end_date', .)"/></processor>
            <processor match="/e:entries/div[@id]" type="InsertProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('id', substring-after(@id, 'release_'))"/></processor>
            <processor match="/e:entries/div/@class" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>
            <processor match="/e:entries/div/h3" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/p" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/b" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/br" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/text()" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/div" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div" type="RenameProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entries[not(e:entry[@key='end_date'])]" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>
            <processor match="/e:entries/e:entries[contains(e:entry[@key='number'],'Next') or contains(e:entry[@key='number'],'next')]" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>


                <element in="e:entries" if="$vapor='true'">
                    <element in="e:entries" if="contains(e:entry[@key='number'],'vapor')"/>
                    <element-ignore/>
                </element>

                <element in="e:entries" if="$vapor='false'">
                    <element-ignore in="e:entries" if="contains(e:entry[@key='number'],'vapor')"/>
                </element>


       </processors>




    </view>

    <view name="OPSCORE_renderReleaseNote">

        <info>
            <category>Release Note</category>
            <description>get a given release on forge</description>
        </info>
        <argument name="base_url" eval="property('OPSCORE.forge.baseurl')"/>
        <argument name="release_id"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat($base_url,$release_id)"/>
            <parameter name="connect-timeout">600</parameter>
            <parameter name="read-timeout">600</parameter>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <serializer type="CSVSerializer"/>
    </view>


    <view name="OPSCORE_ACCPORTAL_VOS">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('VoEntries')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <set variable="listSiteEmail">view('vmRecipientsView')</set>
                <element in="e:entries" if="e:entry[@key='status']='Production'">
                    <element in="e:entry" if="@key='name'"/>
                    <element-ignore/>
                    <element-create>view('OPSCORE_ACCPORTAL_VO',entry('vo',../e:entry[@key='name']/text()))/e:entries/*</element-create>
                    <element-create>entry('email',choose($listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='name']/text()]/email/text(),$listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='name']/text()]/email/text(),'NA'))</element-create>
                </element>
                <element-ignore/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">156</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_ACCPORTAL_SITES">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_SITE')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <set variable="listSiteEmail">view('saRecipientsView')</set>
                <element in="e:entries" if="e:entry[@key='PRODUCTION_INFRASTRUCTURE']='Production' and e:entry[@key='CERTIFICATION_STATUS']='Certified' ">
                    <element-ignore/>
                    <element-create>view('OPSCORE_ACCPORTAL_SITE',entry('site',../e:entry[@key='NAME']/text()))/e:entries/*</element-create>
                    <element-create>entry('email',choose($listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='NAME']/text()]/email/text(),$listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='NAME']/text()]/email/text(),'NA'))</element-create>
                </element>
                <element-ignore/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">126</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="OPSCORE_ACCPORTAL_VO">
        <argument name="vo"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.vo'),$vo)"/>
        </connector>

        <processors>
            <element in="root" out="e:entries">

                <element-ignore>
                    <element-create>entry(name(..),join(../text(),''))</element-create>
                </element-ignore>
            </element>
        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="OPSCORE_ACCPORTAL_SITE">
        <argument name="site"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.site'),$site)"/>
        </connector>

        <processors>
            <element in="root" out="e:entries">
                <element-ignore>
                    <element-create>entry(name(..),join(../text(),''))</element-create>
                </element-ignore>
            </element>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


</config>