<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" version="15">

    <view name="OPSCORE_endpoints"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/><namespace prefix="str" uri="http://exslt.org/strings"/>
        <info>
            <category>Endpoints</category>
            <description>Service endpoints by NGI/Sites</description>
        </info>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_service_endpoint')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>

            <!-- filtering -->
            <remove match="/results/SERVICE_ENDPOINT/*[not(self::HOSTNAME | self::GOCDB_PORTAL_URL | self::IN_PRODUCTION | self::NODE_MONITORED | self::SITENAME | self::ROC_NAME | self::SERVICE_TYPE)]"/>

            <!-- filtering -->
            <insert match="/results/SERVICE_ENDPOINT[*]" nodes="new_attribute('service_type', SERVICE_TYPE ) |                            new_attribute('hostname', HOSTNAME) |                            new_attribute('key', concat(HOSTNAME,SERVICE_TYPE)) |                            new_attribute('site', SITENAME) |                            new_attribute('ngi', ROC_NAME)"/>


            <replace match="/results/SERVICE_ENDPOINT/*[text()]" nodes="entry(local-name(), .)"/>
            <rename match="/results/SERVICE_ENDPOINT" name="e:entries"/>

            <!-- merge downtime info -->
            <insert match="/results/e:entries[*]" nodes="view('OPSCORE_downtime_ongoing_raw')/results/DOWNTIME[ENDPOINT/text() = match()/@key]/*[not(                     self::HOSTNAME | self::SERVICE_TYPE |                     self::ENDPOINT | self::HOSTED_BY |                     self::INSERT_DATE | self::START_DATE |                     self::FORMATED_START_DATE | self::FORMATED_END_DATE )]"/>

            <replace xmlns:str="http://exslt.org/strings" match="/results/e:entries/*[local-name() != 'entry'][text()]" nodes="entry(concat('DOWNTIME_',local-name()),.)"/>

        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_downtime_ongoing_raw</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>

    <view xmlns:cfg="http://software.in2p3.fr/lavoisier/config.xsd" xmlns:_entries_="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:ns="uri://" name="OPSCORE_endpoints_post"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/><namespace prefix="cfg" uri="http://software.in2p3.fr/lavoisier/config.xsd"/><namespace prefix="_entries_" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/><namespace prefix="ns" uri="uri://"/>
        <info>
            <category>Endpoints</category>
            <description>Service endpoints by NGI/Sites</description>
        </info>
        <!-- default argument is path if exists -->
        <argument name="xpath" eval="path(false())" path-format="none"/>



        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_endpoints')"/>
        </connector>
        <processors>
            <!-- apply posted xpath -->
            <processor type="SelectProcessor" match="eval($xpath)" disabled="not($xpath)">
                <namespaces>
                    <entry key="cfg">http://software.in2p3.fr/lavoisier/config.xsd</entry>
                    <entry key="_entries_">http://software.in2p3.fr/lavoisier/entries.xsd</entry>
                    <entry key="ns">uri://</entry>
                </namespaces>
                
                
            </processor>
        </processors>

    </view>

    <view name="OPSCORE_host_service"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
    <info>
        <category>Endpoints</category>
        <description>Service endpoints by NGI/Sites</description>
    </info>
    <connector type="HTTPConnector">
        <parameter name="url" eval="property('OPSCORE.gocdb.get_service_endpoint')"/>
        <parameter name="certificate" eval="property('certificate.path')"/>
        <parameter name="passphrase" eval="property('certificate.password')"/>
    </connector>

        <processors>

            <element in="results" out="e:entries">

                <element in="SERVICE_ENDPOINT" out="e:entries">

                    <element-create>entry('id',../@PRIMARY_KEY)</element-create>
                    <element-create>entry('hostname',../HOSTNAME/text())</element-create>
                    <element-create>entry('service',../SERVICE_TYPE/text())</element-create>
                    <element-create>entry('status',choose(../IN_PRODUCTION/text()='Y','1','0'))</element-create>
                    <element-create>entry('site',../SITENAME/text())</element-create>
                    <element-create>entry('ngi',../ROC_NAME/text())</element-create>

                    <element-ignore/>
                </element>
                <element-create as="first-child">view('OPSCORE_fake_availability_services')/e:entries/*</element-create>

            </element>



        </processors>


        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_fake_availability_services"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Endpoints</category>
            <description>fake availability services for the table host_service</description>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">

                <element in="SITE" out="e:entries">
                    <attribute-ignore if="local-name()!='PRIMARY_KEY'"/>
                    <element-create>entry('id',concat(../@PRIMARY_KEY,'_av'))</element-create>
                    <element-create>entry('hostname',concat(../SHORT_NAME/text(),'_Availability'))</element-create>
                    <element-create>entry('service',concat(../SHORT_NAME/text(),'_Availability'))</element-create>
                    <element-create>entry('status','1')</element-create>
                    <element-create>entry('site',../SHORT_NAME/text())</element-create>
                    <element-create>entry('ngi',../ROC/text())</element-create>
                    <element-ignore/>
                </element>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_host_service_cron"><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
        <info>
            <category>Endpoints</category>
            <description>Update table host_service</description>
        </info>
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.update.servicesDB')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="connect-timeout">120</parameter>
            <parameter name="read-timeout">120</parameter>
        </connector>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">2</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>
    </view>

</config>