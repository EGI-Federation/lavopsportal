<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >



    <view name="OPSCORE_notify_downtimes">


        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.notify.downtimes')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="connect-timeout">30</parameter>
            <parameter name="read-timeout">30</parameter>
        </connector>

        <serializer type="JSONSerializer"/>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,7)"/>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>



    </view>

    <view name="OPSCORE_downtime_ongoing_raw">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_downtime_ongoing')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>
            <element in="results">
                <element in="DOWNTIME">
                    <attribute-create out="UniqueId">concat(../@PRIMARY_KEY,../HOSTNAME/text(),../SERVICE_TYPE/text())</attribute-create>
                </element>
            </element>

            <element in="results">
                <element-ignore in="DOWNTIME"/>
                <element-create>uniq(../DOWNTIME,'@UniqueId')</element-create>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_downtime_ongoing">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_downtime_ongoing_raw')"/>
        </connector>

        <processors>

            <processor match="/results/DOWNTIME/@*[local-name()!='PRIMARY_KEY']" type="MoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="destination_axis">following-sibling</parameter></processor>
            <processor match="/results/DOWNTIME/@*[local-name()='PRIMARY_KEY']" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">key</parameter></processor>
            <processor match="/results/DOWNTIME/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry(local-name(), .)"/></processor>
            <processor match="/results/DOWNTIME" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/results" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entries[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('NGI',choose(                     view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='HOSTED_BY']/text()]/@key,                     view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='HOSTED_BY']/text()]/@key,                     'NA'))"/></processor>

            <processor match="/e:entries/e:entries[*]" type="SelectGroupByProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="group_by" eval="@key"/></processor>

            <processor match="/e:entries/e:entry" type="MergeProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entries/e:entry[@key!='HOSTNAME' and @key!='SERVICE_TYPE']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entries[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'***',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/></processor>
            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'***',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/></processor>
            <processor match="/e:entries/e:entry/e:entries" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/e:entry/e:entry[@key='HOSTNAME' or @key='SERVICE_TYPE' or @key='ENDPOINT']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entry[@key='SERVICE']" type="InsertParentProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entry/e:entries" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('key','ENDPOINTS')"/></processor>
            <processor match="/e:entries/e:entry/e:entries/e:entry/@*" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('CLASSIFICATION',new_text(match()/@CLASSIFICATION))"/><parameter name="destination_as">first_child</parameter></processor>


            <elements path="e:entries/e:entry">
                <element-ignore in="AFFECTED_ENDPOINTS"/>
                <element-ignore in="e:entries">
                    <element in="e:entry">
                       <attribute-create out="key">'endpoint'</attribute-create>
                    </element>
                </element-ignore>
            </elements>

            <elements path="e:entries/e:entry">
                    <element-create-as-parent out="e:entries" attributes="new_attribute('key','ENDPOINTS')">
                        <element in="e:entry" if="@key='endpoint'">
                        <attribute-ignore in="key"/>
                        </element>
                    </element-create-as-parent>
             </elements>


            <!--<elements path="e:entries/e:entry">-->
                <!--<element-create>entries('ENDPOINTS',new_text(../text()))</element-create>-->

            <!--</elements>-->
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_downtime_ongoing_raw</entry>
                    <!-- OPSCORE_prod_entities :  because dependency : OPSCORE_entities_map with no cache-->
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
                <parameter name="all">true</parameter>
            </trigger>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_get_downtimes_forDNS">

        <connector type="XMLConnector"><parameter name="content" eval="new_element('results')"/></connector>

        <processors>

            <element in="results">
                <set variable="downtimeslist1" index="concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())">view('OPSCORE_get_downtime_to_broadcast')/results/DOWNTIME</set>
                <set variable="downtimeslist2" index="concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())">view('OPSCORE_downtime_ongoing_raw')/results/DOWNTIME</set>
                <set variable="downtimeslist3">view('OPSCORE_DOWNTIME_recents')/results/DOWNTIME</set>

                <element-create>$downtimeslist1</element-create>
                <element-create>$downtimeslist2[not(find($downtimeslist1,concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())))]</element-create>
                <element-create>$downtimeslist3[not(find($downtimeslist1,concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text()))) and not(find($downtimeslist2,concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text()))) ]</element-create>
            </element>



            <element in="results">
                <element in="DOWNTIME">
                    <element-create if="not(../SITENAME)">new_element('SITENAME',../HOSTED_BY/text())</element-create>
                </element>
            </element>

        </processors>

    </view>

    <view name="OPSCORE_get_downtime_to_broadcast">

            <connector type="HTTPConnector">
                <parameter name="url" eval="property('OPSCORE.gocdb.get_downtime_to_broadcast')"/>
                <parameter name="certificate" eval="property('certificate.path')"/>
                <parameter name="passphrase" eval="property('certificate.password')"/>
            </connector>


        <processors>
            <element in="results">
                <element-ignore in="DOWNTIME"/>
                <element-create>uniq(../DOWNTIME,'concat(@PRIMARY_KEY,HOSTNAME/text(),SERVICE_TYPE/text())')</element-create>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>



    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="OPSCORE_downtime_new">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_downtimes_forDNS')"/>
        </connector>

        <processors>

            <processor match="/results/DOWNTIME/@*[local-name()!='PRIMARY_KEY']" type="MoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="destination_axis">following-sibling</parameter></processor>
            <processor match="/results/DOWNTIME/@*[local-name()='PRIMARY_KEY']" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="node_name">key</parameter></processor>
            <processor match="/results/DOWNTIME/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry(local-name(), .)"/></processor>
            <processor match="/results/DOWNTIME" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/results" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entries[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry('NGI',choose(                     view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='SITENAME']/text()]/@key,                     view('OPSCORE_entities_map' , entry('entry_key','ngi') | entry('entry_value','name') | entry('entity_type','site'))/e:entries/e:entry[text()= match()/e:entry[@key='SITENAME']/text()]/@key,                     'NA'))"/></processor>

            <processor match="/e:entries/e:entries[*]" type="SelectGroupByProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="group_by" eval="@key"/></processor>

            <processor match="/e:entries/e:entry" type="MergeProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entries/e:entry[@key!='HOSTNAME' and @key!='SERVICE_TYPE']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entries[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'::',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/></processor>
            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry('SERVICE',concat(e:entry[@key='HOSTNAME'],'::',e:entry[@key='SERVICE_TYPE'],'&#13;'))"/></processor>
            <processor match="/e:entries/e:entry/e:entries" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/e:entry/e:entry[@key='HOSTNAME' or @key='SERVICE_TYPE' or @key='ENDPOINT']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entry[@key='SERVICE']" type="InsertParentProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entry/e:entries" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="new_attribute('key','ENDPOINTS')"/></processor>
            <processor match="/e:entries/e:entry/e:entries/e:entry/@*" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>
            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="entry('CLASSIFICATION',new_text(match()/@CLASSIFICATION))"/><parameter name="destination_as">first_child</parameter></processor>


            <elements path="e:entries/e:entry">
                <element-ignore in="AFFECTED_ENDPOINTS"/>
                <element-ignore in="BROADCASTING_START_DOWNTIME"/>
                <element-ignore in="e:entries">
                    <element in="e:entry">
                        <attribute-create out="key">'endpoint'</attribute-create>
                    </element>
                </element-ignore>
            </elements>

            <elements path="e:entries/e:entry">

                <element-create-as-parent out="e:entries" attributes="new_attribute('key','ENDPOINTS')">
                    <element in="e:entry" if="@key='endpoint'">
                        <attribute-ignore in="key"/>
                    </element>
                </element-create-as-parent>


            </elements>

            <element in="e:entries">
                <set variable="VAPOR_Endpoints_Policy">view('VAPOR_Endpoints_Policy')</set>
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                            <element-create>$VAPOR_Endpoints_Policy/e:entries/e:entries[contains(@id,substring-before(current()/../text(),'::'))]/VO</element-create>
                        </element>
                    </element>
                </element>

            </element>



            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                            <text-ignore/>
                            <text-create>concat(normalize-space(../text()),",")</text-create>
                            <element-ignore in="VO"/>
                            <element-create>uniq(../VO,"text()")</element-create>

                        </element>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element in="e:entry">
                           <element in="VO">
                               <text-ignore/>
                               <text-create>concat(normalize-space(../text()),",")</text-create>
                           </element>
                        </element>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entry">
                    <element in="e:entries" if="@key='ENDPOINTS'">
                        <element-create>entry('hosts',new_text(str:concat(../e:entry/text())))</element-create>
                        <element-create>entry('vos',new_text(str:concat(../e:entry/VO/text())))</element-create>
                        <element-ignore/>
                    </element>
                </element>


            </element>

            <element in="e:entries">


                <element in="e:entry">
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi','ALL')|entry('site','ALL')|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site','ALL')|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>
                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site',../e:entry[@key='SITENAME'])|entry('node','ALL')|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>

                    <element-create>
                        view('OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER',entry('ngi',../e:entry[@key='NGI']/text())|entry('site',../e:entry[@key='SITENAME'])|entry('node',../e:entries[@key='ENDPOINTS']/e:entry[@key='hosts']/text())|entry('vo',../e:entries[@key='ENDPOINTS']/e:entry[@key='vos']/text()))
                    </element-create>

                </element>

            </element>


            <element in="e:entries">
                    <element in="e:entry" out="e:entries">
                        <element-create-as-parent out="e:entries" attributes="@key">
                            <element in="e:entries" if="@key='targets'"/>
                        </element-create-as-parent>
                    </element>
            </element>

            <element in="e:entries">
            <element in="e:entries">
                    <element in="e:entries" if="@key='targets'">
                        <element-ignore>
                            <element/>
                        </element-ignore>
                    </element>
            </element>
            </element>



        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>
            </trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,6)"/>
            </trigger>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_downtime_count">


        <argument name="entity_type" pattern="ngi|site|all"/>
        <argument name="entity_parent">none</argument>
        <argument name="prepath">/*/*</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view_path('OPSCORE_downtime_ongoing',$prepath)"/>
        </connector>

        <processors>

            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('site',e:entry[@key='HOSTED_BY']/text())"/></processor>
            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('ngi',e:entry[@key='NGI']/text())"/></processor>

            <processor type="RemoveProcessor" disabled="$entity_parent = 'none' " match="/e:entries/e:entry[@ngi!=$entity_parent]"/>

            <processor type="SelectGroupByProcessor" disabled="$entity_type = 'ngi' " match="/e:entries/e:entry">
                <parameter name="group_by" eval="@site"/>
            </processor>

            <processor type="SelectGroupByProcessor" disabled="$entity_type = 'site' " match="/e:entries/e:entry">
                <parameter name="group_by" eval="@ngi"/>
            </processor>


            <processor match="/e:entries/e:entry" type="AppendAggregateProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="function">count</parameter><parameter name="node_name">count</parameter><parameter name="node_values" eval="e:entry"/></processor>

            <processor match="/e:entries/e:entry/e:entry" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:count[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="text()"/></processor>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_DOWNTIME_2_cache">


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_2')"/>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_2</entry>
                </parameter>
            </trigger>
        </cache>
    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_DOWNTIME_2" post-processors="downtime">



        <variable name="th_month_ago" eval="substring(date:add(date:date(),'-P90D'),0,11)"/>
        <variable name="th_month_after" eval="substring(date:add(date:date(),'P90D'),0,11)"/>
        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P90D'))"/>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P90D'))"/>



        <connector type="HTTPConnector">
            <parameter name="url" eval="                 concat(property('OPSCORE.gocdb.get_downtime'),'&amp;windowstart=',$th_month_ago,'&amp;windowend=',$th_month_after)"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>

                    <!-- Trick : for the timeline we check that the start date is not before the reference date
                    and that the end date is not after the reference date . This aim is to show only into the chart the part corresponding
                    to the reference period .
                    -->

                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore/>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore/>
                        <text-create>$date_limit_end</text-create>
                    </element>


                </element>

            </element>


        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',13,7)"/>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_DOWNTIME_1_cache" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_1')"/>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_1</entry>
                </parameter>
            </trigger>
        </cache>
    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="OPSCORE_DOWNTIME_recents" post-processors="downtime">



    <variable name="one_month_ago" eval="substring(date:add(date:date(),'-P30D'),0,11)"/>
    <variable name="one_day_after" eval="substring(date:add(date:date(),'P1D'),0,11)"/>



    <connector type="HTTPConnector">
        <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_downtime'),'&amp;windowstart=',$one_month_ago,'&amp;windowend=',$one_day_after)"/>
        <parameter name="certificate" eval="property('certificate.path')"/>
        <parameter name="passphrase" eval="property('certificate.password')"/>
    </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="OPSCORE_DOWNTIME_1" post-processors="downtime">



        <variable name="one_month_ago" eval="substring(date:add(date:date(),'-P30D'),0,11)"/>
        <variable name="one_month_after" eval="substring(date:add(date:date(),'P30D'),0,11)"/>

        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P30D'))"/>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P30D'))"/>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_downtime'),'&amp;windowstart=',$one_month_ago,'&amp;windowend=',$one_month_after)"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>
                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore/>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore/>
                        <text-create>$date_limit_end</text-create>
                    </element>

                </element>

            </element>



        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_DOWNTIME_3_cache" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings">


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DOWNTIME_3')"/>
        </connector>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_DOWNTIME_3</entry>
                </parameter>
            </trigger>
        </cache>
    </view>





    <view xmlns:date="http://exslt.org/dates-and-times" xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_DOWNTIME_3" post-processors="downtime">


        <variable name="date_limit_start" eval="date:seconds(date:add(date:date(),'-P60D'))"/>
        <variable name="date_limit_end" eval="date:seconds(date:add(date:date(),'P60D'))"/>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_downtime'),'&amp;ongoing_only=yes')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results">
                <set variable="sitelist">view('OPSCORE_get_site')</set>
                <element in="DOWNTIME">
                    <element-create>new_element('NGI',$sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/ROC/text())</element-create>
                    <element-create>new_element('TIER',
                        choose($sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),
                        $sitelist/results/SITE[@NAME=current()/../HOSTED_BY/text()]/TIER/text(),'NA'))</element-create>

                    <element in="START_DATE" if="text()&lt;$date_limit_start">
                        <text-ignore/>
                        <text-create>$date_limit_start</text-create>
                    </element>
                    <element in="END_DATE" if="text()&gt;$date_limit_end">
                        <text-ignore/>
                        <text-create>$date_limit_end</text-create>
                    </element>

                </element>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>




    <view xmlns:str="http://exslt.org/strings" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_DOWNTIME_FILTER">

        <argument name="ngi">_NGI_</argument>
        <argument name="site">_SITE_</argument>
        <argument name="tier">_TIER_</argument>
        <argument name="vo">_VO_</argument>
        <argument name="period">1</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="choose($period=1,             view('OPSCORE_DOWNTIME_1_cache'),                 choose($period=2,view('OPSCORE_DOWNTIME_2_cache'),view('OPSCORE_DOWNTIME_3_cache')))"/>
        </connector>

        <processors>

            <element in="e:entries">
                <element-ignore in="e:entries" if="$ngi!='_NGI_' and e:entry[@key='NGI']/text()!=$ngi"/>
                <element-ignore in="e:entries" if="$site!='_SITE_' and e:entry[@key='SITE']/text()!=$site"/>
                <element-ignore in="e:entries" if="$tier!='_TIER_' and e:entry[@key='TIER']/text()!=$tier"/>
                <element-ignore in="e:entries" if="$vo!='_VO_' and not(e:entries[@key='vos']/e:entry/text()=$vo)"/>
            </element>



        </processors>
        <pre-renderers><namespace prefix="str" uri="http://exslt.org/strings"/><namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
            <row foreach="/e:entries/e:entries">
                <column label="NGI">e:entry[6]/text()</column>
                <column label="SITE">e:entry[7]/text()</column>
                <column label="START">e:entry[4]/text()</column>
                <column label="END">e:entry[5]/text()</column>
                <column label="INSERT">e:entry[9]/text()</column>
                <column label="CLASSIFICATION">e:entry[8]/text()</column>
                <column label="SEVERITY">e:entry[2]/text()</column>
                <column label="GOCDBURL">e:entry[1]/text()</column>
                <column label="DESCRIPTION">e:entry[3]/text()</column>
                <column label="ENDPOINTS">normalize-space(e:entry[10]/text())</column>
            </row>
        </pre-renderers>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_DOWNTIME_SUBSCRIPTION">


        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('ROD.db.url')"/>
            <parameter name="username" eval="property('ROD.db.username')"/>
            <parameter name="password" eval="property('ROD.db.password')"/>
            <parameter name="query">
                SELECT ds.id, dc.value, dc.type, ds.region , ds.site , ds.node , ds.vo , ds.adding , ds.beginning, ds.ending from dt_subscription ds, dt_communication dc where ds.is_active=1 and dc.type IN (0,1) and dc.subscription_id=ds.id

            </parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">35</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_DOWNTIME_SUBSCRIPTION_FILTER" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="ngi"/>
        <argument name="site"/>
        <argument name="node"/>
        <argument name="vo"/>


        <connector type="XMLConnector">
         <parameter name="content" eval="view('OPSCORE_DOWNTIME_SUBSCRIPTION')"/>
     </connector>


        <processors>

            <element in="result" out="e:entries">
                <attribute-create out="key">'targets'</attribute-create>
                <element in="row" if="region/text()=$ngi and site/text()=$site and contains($node,node/text()) and  ( vo/text()='ALL')"/>
                <element in="row" if="region/text()=$ngi and site/text()=$site and contains($node,node/text()) and  ( contains($vo,concat(vo/text(),',')))"/>

                <element-ignore/>

            </element>

            <element in="e:entries">
                <element in="row" out="e:entries">
                    <attribute in="key">'subscription'</attribute>
                   <element-ignore>
                       <element-create>entry(name(..),choose(../text(),../text(),'anonymous@anonymous.fr'))</element-create>
                   </element-ignore>

                </element>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>




</views>