<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >

    <view name="metrics_columns">

        <connector type="FileConnector">
            <parameter name="path">/app/resources/xml/metrics_columns.xml</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="ViewCreatedTrigger"/>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>


    <view name="ListMetrics">

        <argument name="view">ROD_XML</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('metrics_columns')"/>
        </connector>
        <processors>

            <processor match="/entries/entries[@key!=$view]" type="RemoveProcessor"/>
            <processor match="/entries/entries/entry/text()" type="ReplaceProcessor"><parameter name="nodes" eval="concat(',sum(',match(),') as  sum_',match() )"/></processor>
            <processor match="/entries/entries" type="RemoveProcessor"><parameter name="depth">2</parameter></processor>
        </processors>

    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_Render_Metrics">



        <argument name="table"/>
        <argument name="entity_type"/>
        <argument name="entity_name"/>
        <argument name="date"/>
        <argument name="view" eval="choose($table='cod_metrics','COD_XML','ROD_XML')"/>


        <argument name="query_start" eval="view('ListMetrics', entry('view',$view))/*"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                <entry eval="choose($entity_name='any', 'SELECT ngi','SELECT site , ngi')"/>

                <entry eval="$query_start"/>
                <entry>FROM</entry>
                <entry eval="$table"/>
                <entry>WHERE</entry>
                <entry eval="choose($entity_name!='any',concat($entity_type,'=',quot($entity_name)),concat($entity_type,'=',$entity_type))"/>
                <entry>AND daydate like</entry>
                <entry eval="quot(concat('%',$date,'%'))"/>
                <entry eval="choose($entity_name='any', 'GROUP by ngi','GROUP by site')"/>

            </parameter>

        </connector>


        <processors>
            <processor match="/result/row/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry(local-name(match()),match()/text())"/></processor>
            <processor match="/result/row" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/result" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <elements path="e:entries/e:entries">
                <element-ignore in="e:entry" if="@key='ngi' and preceding-sibling::e:entry[@key='site']"/>
            </elements>
        </processors>

        <pre-renderers row-column="/app/resources/xsl/metricsrowcol.xsl">
            <namespace prefix="e" uri="http://software.in2p3.fr/lavoisier/entries.xsd"/>
            <row foreach="/*">
                <column label="bidon">test</column>
            </row>

        </pre-renderers>

        <renderers>
            <renderer type="ChartRenderer">
                <parameter name="rotation">-45</parameter>
            </renderer>
        </renderers>

    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_Render_Metrics_Chart">



    <argument name="table">csi_metrics</argument>
    <argument name="entity_type">ngi</argument>
    <argument name="entity_name">any</argument>
    <argument name="date">2015-04</argument>
    <argument name="view">CSI_XML</argument>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('http://localhost:',property('lavoisier.http.port'),'/lavoisier/OPSCORE_Render_Metrics/?date=',$date,'&amp;table=',$table,'&amp;view=',$view,'&amp;entity_type=',$entity_type,'&amp;entity_name=',$entity_name,'table=',$table,'&amp;accept=chart')"/>
        </connector>



    <serializer type="HTMLSerializer"/>

    <processors>



        <processor match="/html/head/META/meta/script" type="SelectProcessor"/>
        <processor match="/e:entries/script[@src]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
        <processor match="/e:entries" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="depth">1</parameter></processor>
    </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">chart</parameter></renderer>
        </renderers>


</view>

</views>