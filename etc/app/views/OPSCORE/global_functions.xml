<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >


    <view name="OPSCORE_lastupdate_table">


        <argument name="table"/>
       <connector type="SQLConnector">
           <parameter name="driver">com.mysql.jdbc.Driver</parameter>
           <parameter name="url" eval="property('OPSCORE.db.url')"/>
           <parameter name="username" eval="property('OPSCORE.db.username')"/>
           <parameter name="password" eval="property('OPSCORE.db.password')"/>

           <parameter name="query">SELECT max(updated_at) FROM
               <entry eval="$table"/>
           </parameter>
       </connector>
    </view>





    <view name="OPSCORE_desc_tables">

        <argument name="table"/>
        <argument name="schema"/>
        <argument name="url"/>
        <argument name="login"/>
        <argument name="pwd"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="$url"/>
            <parameter name="username" eval="$login"/>
            <parameter name="password" eval="$pwd"/>

            <parameter name="query">SELECT COLUMN_NAME AS `Field`, COLUMN_TYPE AS `Type`, IS_NULLABLE AS `Nullable`,
                COLUMN_KEY AS `Key`
                FROM information_schema.COLUMNS
                WHERE TABLE_SCHEMA = <entry eval="quot($schema)"/><entry> AND TABLE_NAME = </entry><entry eval="quot($table)"/></parameter>
        </connector>

        <processors>
            <element in="result">
                <element in="row">
                    <attribute-create out="schema">$schema</attribute-create>
                    <attribute-create out="id">../Field/text()</attribute-create>
                    <attribute-create out="compar">join(../*/text(),'-')</attribute-create>
                </element>
            </element>
        </processors>

    </view>



    <view name="OPSCORE_desc_tables_comparison">

        <argument name="table"/>
        <argument name="schema1"/>
        <argument name="schema2"/>
        <argument name="url1"/>
        <argument name="url2"/>
        <argument name="login1"/>
        <argument name="login2"/>
        <argument name="pwd1"/>
        <argument name="pwd2"/>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_desc_tables',entry('table',$table)|entry('schema',$schema1)|entry('url',$url1)|entry('login',$login1)|entry('pwd',$pwd1))"/>
        </connector>

        <processors>
            <element in="result">
                <element-create>view('OPSCORE_desc_tables',entry('table',$table)|entry('schema',$schema2)|entry('url',$url2)|entry('login',$login2)|entry('pwd',$pwd2))/result/*</element-create>
            </element>



            <element in="result">
                <element-ignore/>
                <element-create>sort_by_string(../row,'@id')</element-create>
            </element>
            <element in="result">
                <element-create-as-parent out="field" group-by="@id" attributes="@id">
                    <element in="row"/>
                </element-create-as-parent>
            </element>

            <element in="result">
                <element-ignore in="field" if="row[1]/@compar=row[2]/@compar"/>
            </element>
        </processors>
    </view>

    <view name="missingTables">

        <argument name="schema1"/>
        <argument name="schema2"/>
        <argument name="url1"/>
        <argument name="url2"/>
        <argument name="login1"/>
        <argument name="login2"/>
        <argument name="pwd1"/>
        <argument name="pwd2"/>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_tables',entry('schema',$schema1)|entry('url',$url1)|entry('login',$login1)|entry('pwd',$pwd1))"/>
        </connector>

        <processors>

            <element in="result" out="missingTables">
                <set variable="listschema2">view('OPSCORE_tables',entry('schema',$schema2)|entry('url',$url2)|entry('login',$login2)|entry('pwd',$pwd2))</set>
                <attribute-create out="schema">$schema1</attribute-create>
                <element-ignore in="row" if="TABLE_NAME/text()=$listschema2/result/row/TABLE_NAME/text()"/>
            </element>
        </processors>


    </view>

    <view name="OPSCORE_tables">

        <argument name="schema"/>
        <argument name="url"/>
        <argument name="login"/>
        <argument name="pwd"/>

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="$url"/>
            <parameter name="username" eval="$login"/>
            <parameter name="password" eval="$pwd"/>

            <parameter name="query">SELECT TABLE_NAME
                FROM information_schema.TABLES
                WHERE TABLE_SCHEMA = <entry eval="quot($schema)"/></parameter>
        </connector>
    </view>




    <view name="OPSCORE_DB_comparison_OpsPortal">
        <argument name="schema1" eval="property('schema.prod.db')"/>
        <argument name="schema2" eval="property('schema.test.db')"/>
        <argument name="url1" eval="property('url.prod.db')"/>
        <argument name="url2" eval="property('url.test.db')"/>
        <argument name="login1" eval="property('login.prod.db')"/>
        <argument name="login2" eval="property('login.test.db')"/>
        <argument name="pwd1" eval="property('pwd.prod.db')"/>
        <argument name="pwd2" eval="property('pwd.test.db')"/>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_DB_comparison',arguments())"/>
        </connector>


        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template" >app/html/db.html</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_DB_comparison">

        <argument name="schema1"/>
        <argument name="schema2"/>
        <argument name="url1"/>
        <argument name="url2"/>
        <argument name="login1"/>
        <argument name="login2"/>
        <argument name="pwd1"/>
        <argument name="pwd2"/>

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>
        <processors>
            <element in="root">
                <element-create>view('missingTables', arguments())</element-create>
                <element-create>view('missingTables', entry('schema1',$schema2)|entry('url1',$url2)|entry('login1',$login2)|entry('pwd1',$pwd2)| entry('schema2',$schema1)|entry('url2',$url1)|entry('login2',$login1)|entry('pwd2',$pwd1))</element-create>

                <element-create>view('OPSCORE_tables',entry('schema',$schema1)|entry('url',$url1)|entry('login',$login1)|entry('pwd',$pwd1))</element-create>
            </element>


            <element in="root">
                <elements-ignore path="result/row">
                    <element in="TABLE_NAME" out="table">
                        <attribute-create out="id">../text()</attribute-create>
                        <element-create>view('OPSCORE_desc_tables_comparison',entry('table',../text())|entry('schema1',$schema1)|entry('url1',$url1)|entry('login1',$login1)|entry('pwd1',$pwd1)| entry('schema2',$schema2)|entry('url2',$url2)|entry('login2',$login2)|entry('pwd2',$pwd2))</element-create>
                        <text-ignore/>
                    </element>

                </elements-ignore>

            </element>

            <element in="root">
                <element-ignore in="table" if="count(result/*)=0"/>
            </element>
        </processors>



        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template" >app/html/db.html</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_portal_cron">

        <argument name="url"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>


            <!--optional: timeout (in seconds) for connecting (Integer)-->
            <parameter name="connect-timeout">600</parameter>

            <!--optional: timeout (in seconds) for reading (Integer)-->
            <parameter name="read-timeout">600</parameter>

            <!--optional: If false, the HTTP redirection will be forbidden between different protocols (http / https) (Boolean)-->
            <parameter name="force-redirect">true</parameter>

            <fallback eval="new_element('PORTAL_SCRIPT_NOT_REACHABLE',new_attribute('url', $url))">
                <exception type="java.io.FileNotFoundException"/>
            </fallback>
        </connector>
    </view>

    <view authenticators="local" name="CheckPortal">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('portal.check')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">400</parameter>
            <parameter name="read-timeout">500</parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">8</parameter>
                <parameter name="minute">30</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>
    </view>

    <view name="OPSCORE_VaporReleases" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <argument name="name">_RNAME_</argument>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://gitlab.in2p3.fr/opsportal/app_vapor/issues.atom?private_token=',property('gitlab.token'),'&amp;scope=all&amp;state=opened')"/>
        </connector>

        <processors>
            <processor match="//*" type="ChangeNamespaceProcessor"/>

                <element in="feed" out="e:entries">
                    <attribute-create out="key">'issues'</attribute-create>
                    <element in="entry" out="e:entries" if="milestone/text()=$name or $name='_RNAME_'">
                        <attribute-create out="key">concat('issue_',substring-after(substring(../id/text(),string-length(../id/text())-4),'/'))</attribute-create>

                        <element in="link" out="e:entry">
                            <attribute-create out="key">'link'</attribute-create>
                            <attribute-ignore/>

                            <text-create>../@href</text-create>
                        </element>

                        <element in="title" out="e:entry">
                            <attribute-create out="key">'title'</attribute-create>
                        </element>

                        <element in="description" out="e:entry">
                            <attribute-create out="key">'description'</attribute-create>
                        </element>

                        <element in="author" out="e:entry">
                            <attribute-create out="key">'author'</attribute-create>
                            <text-create>../name/text()</text-create>
                            <element-ignore/>
                        </element>

                        <element in="milestone" out="e:entry">
                            <attribute-create out="key">'release'</attribute-create>
                        </element>

                        <element in="labels" out="e:entries">
                            <attribute-create out="key">'labels'</attribute-create>

                            <element in="label" out="e:entry">
                                <attribute-create out="key">../text()</attribute-create>
                            </element>
                        </element>

                        <element-ignore/>

                    </element>
                    <element-ignore/>
                </element>


        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_PORTAL_Releases"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/1357/issues?scope=all</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="milestone" if="not(../milestone/id/text())">0</attribute-create>
                    <attribute-create out="milestone" if="../milestone/id/text()">number(../milestone/id/text())</attribute-create>
                    <element in="id"/>
                    <element in="title"/>
                    <element in="description"/>
                    <element in="state"/>
                    <element in="closed_at"/>
                    <element in="milestone"/>
                    <element in="web_url"/>
                    <element-ignore/>

                </element>

            </element>



            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_number(../e:entries,'@milestone')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" attributes="@milestone" group-by="@milestone">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                    <element in="e:entries">
                        <attribute in="milestone" out="key"/>
                        <element-create as="first-child">../e:entries[1]/milestone/*</element-create>
                        <element in="e:entries">
                            <attribute-create out="key">../id/text()</attribute-create>
                            <attribute-ignore/>
                            <element-ignore in="milestone"/>
                        </element>
                    </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entries">
                        <element-ignore>
                            <element-create if="../text()">entry(local-name(..),../text())</element-create>
                            <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                        </element-ignore>
                    </element>
                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                        <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                    </element-ignore>
                </element>
            </element>

        </processors>

    </view>

    <view name="OPSCORE_OspPortal_Releases" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="label">_label_</argument>

        <connector type="HTTPConnector">
            <parameter name="url" eval="choose($label='_label_','https://gitlab.in2p3.fr/api/v4/projects/1357/issues?scope=all',concat('https://gitlab.in2p3.fr/api/v4/projects/1357/issues?scope=all&amp;milestone=',$label))"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONStreamSerializer"/>
        <processors>



            <element in="item" out="tables">



                        <element in="object" out="row">

                            <attribute-ignore/>


                            <element-create>new_element('column',new_attribute('label','1')|new_text(../web_url/text()))</element-create>
                            <element-create>new_element('column',new_attribute('label','2')|new_text(../title/text()))</element-create>
                            <!--<element-create>entry('description',../@description)</element-create>-->
                            <!--<element-create>entry('author',../author/object/@name)</element-create>-->
                            <element-create>new_element('column',new_attribute('label','5')|new_text(../state/text()))</element-create>
                            <element-create if="../task_completion_status/count!=0">new_element('column',new_attribute('label','3')|new_text(floor(../task_completion_status/completed_count div ../task_completion_status/count *100)))</element-create>
                            <element-create if="../task_completion_status/count=0 and ../state/text()!='closed'">new_element('column',new_attribute('label','3')|new_text(10))</element-create>
                            <element-create if="../task_completion_status/count=0 and ../state/text()='closed'">new_element('column',new_attribute('label','3')|new_text(100))</element-create>

                            <element-ignore in="labels">
                                <element-create> new_element('column',new_attribute('label','4')| new_text(join(../item,' ')))</element-create>
                            </element-ignore>
                            <element-ignore/>
                        </element>


            </element>

            <element in="tables">
                <element-create-as-parent out="table">
                    <element in="row"/>
                </element-create-as-parent>
            </element>
        </processors>
    </view>

    <view name="OPSCORE_VaporReleaseList" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="name">_RNAME_</argument>

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/1274/milestones?scope=all</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <element-ignore in="array">
                    <element-ignore in="item">
                        <element in="object" out="e:entries">

                            <attribute-create out="key">concat('release',../@id)</attribute-create>
                            <attribute-ignore/>

                            <element-create>entry('id',../@id)</element-create>
                            <element-create>entry('name',../@title)</element-create>
                            <element-create>entry('due_date',../@due_date)</element-create>

                        </element>
                    </element-ignore>
                </element-ignore>
            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="OPSCORE_VaporIssuesList" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <argument name="name">_RNAME_</argument>

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/1274/issues?scope=all</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <element-ignore in="array">
                    <element-ignore in="item">
                        <element in="object" out="e:entries" if="milestone/object/@title=$name or $name='_RNAME_'">
                            <attribute-create out="key">concat('issue_',../@id)</attribute-create>
                            <attribute-ignore/>

                            <element-create>entry('id',../@id)</element-create>
                            <element-create>entry('link',../@web_url)</element-create>
                            <element-create>entry('title',../@title)</element-create>
                            <element-create>entry('description',../@description)</element-create>
                            <element-create>entry('author',../author/object/@name)</element-create>
                            <element-create>entry('state',../@state)</element-create>
                            <element-create if="milestone/object/@title">entry('release',../milestone/object/@title)</element-create>




                            <element in="labels" out="e:entries">
                                <attribute-create out="key">'labels'</attribute-create>

                                <element in="item" out="e:entry">
                                    <attribute-create out="key">../text()</attribute-create>
                                </element>
                            </element>
                            <element-ignore/>
                        </element>
                    </element-ignore>
                </element-ignore>
            </element>
        </processors>
    </view>

    <!--curl &#45;&#45;header "PRIVATE-TOKEN: BKsU4sDqQPuzLjs38Nzz" https://gitlab.example.com/api/v3/projects/5/milestones-->

    <view xmlns:html="http://www.w3.org/1999/xhtml" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd"  name="OPSCORE_listReleases">

        <argument name="vapor">_vapor_</argument>
        <connector type="HTTPConnector">
            <parameter name="url">https://forge.in2p3.fr/rb/releases/opsportaluser</parameter>
        </connector>
        <serializer type="HTMLSerializer"/>
        <processors>
        
                <processor match="//*" type="ChangeNamespaceProcessor"/>
          
            <processor match="/html/body/div/div/div/div[@id='main']/div[@id='content']/div[@class='model release']" type="SelectProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>

            <processor match="/e:entries/div/h3/a[text()]" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('number', text())"/></processor>
            <processor match="/e:entries/div/p[b/text() = 'Release start date:']/text()" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('start_date', .)"/></processor>
            <processor match="/e:entries/div/p[b/text() = 'Release end date:']/text()" type="ReplaceProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('end_date', .)"/></processor>
            <processor match="/e:entries/div[@id]" type="InsertProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="nodes" eval="entry('id', substring-after(@id, 'release_'))"/></processor>
            <processor match="/e:entries/div/@class" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>
            <processor match="/e:entries/div/h3" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/p" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/b" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/br" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/text()" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div/div" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/div" type="RenameProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entries[not(e:entry[@key='end_date'])]" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>
            <processor match="/e:entries/e:entries[contains(e:entry[@key='number'],'Next') or contains(e:entry[@key='number'],'next')]" type="RemoveProcessor"><namespaces><entry key="html">http://www.w3.org/1999/xhtml</entry></namespaces></processor>

            <element in="e:entries">
                <element-create>view('OpsPortal_Milestones')/e:entries/*</element-create>
            </element>

                <element in="e:entries" if="$vapor!='_vapor_'">
                    <element in="e:entries" if="contains(lower-case(e:entry[@key='number']),'vapor')"/>
                    <element-ignore/>
                </element>

                <element in="e:entries" if="$vapor='_vapor_'">
                    <element-ignore in="e:entries" if="contains(lower-case(e:entry[@key='number']),'vapor')"/>
                </element>

       </processors>

    </view>

    <view name="OPSCORE_PORTAL_EOSC_Releases"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/11614/issues?scope=all&amp;per_page=100</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab-eosc.token'))"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="milestone" if="not(../milestone/id/text())">0</attribute-create>
                    <attribute-create out="milestone" if="../milestone/id/text()">number(../milestone/id/text())</attribute-create>
                    <element in="id"/>
                    <element in="title"/>
                    <element in="description"/>
                    <element in="state"/>
                    <element in="closed_at"/>
                    <element in="milestone"/>
                    <element in="web_url"/>
                    <element-create>new_element('labels',join(../labels/item/text(),','))</element-create>
                    <element-ignore/>

                </element>

            </element>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_number(../e:entries,'@milestone')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" attributes="@milestone" group-by="@milestone">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute in="milestone" out="key"/>
                    <element-create as="first-child">../e:entries[1]/milestone/*</element-create>
                    <element in="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <attribute-ignore/>
                        <element-ignore in="milestone"/>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entries">
                        <element-create>entry('type','items')</element-create>
                        <element-ignore>
                            <element-create if="../text()">entry(local-name(..),../text())</element-create>
                            <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                        </element-ignore>
                    </element>
                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                        <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                    </element-ignore>
                </element>
            </element>

        </processors>

    </view>

    <view name="OPSCORE_PORTAL_EGI_Releases"  xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">


        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/1357/issues?scope=all&amp;per_page=100</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="milestone" if="not(../milestone/id/text())">0</attribute-create>
                    <attribute-create out="milestone" if="../milestone/id/text()">number(../milestone/id/text())</attribute-create>
                    <element in="id"/>
                    <element in="title"/>
                    <element in="description"/>
                    <element in="state"/>
                    <element in="closed_at"/>
                    <element in="milestone"/>
                    <element in="web_url"/>
                    <element-create>new_element('labels',join(../labels/item/text(),','))</element-create>
                    <element-ignore/>

                </element>

            </element>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_number(../e:entries,'@milestone')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" attributes="@milestone" group-by="@milestone">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute in="milestone" out="key"/>
                    <element-create as="first-child">../e:entries[1]/milestone/*</element-create>
                    <element in="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <attribute-ignore/>
                        <element-ignore in="milestone"/>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entries">
                        <element-create>entry('type','items')</element-create>
                        <element-ignore>
                            <element-create if="../text()">entry(local-name(..),../text())</element-create>
                            <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                        </element-ignore>
                    </element>
                    <element-ignore>
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                        <element-create if="not(../text())">entry(local-name(..),'')</element-create>
                    </element-ignore>
                </element>
            </element>

        </processors>

    </view>




    <view name="OpsPortal_Milestones" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="HTTPConnector">
            <parameter name="url">https://gitlab.in2p3.fr/api/v4/projects/1357/milestones?scope=all</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header" eval="concat('PRIVATE-TOKEN: ',property('gitlab.token'))"/>
        </connector>

        <serializer type="JSONSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <elements-ignore path="array/item">

                    <element in="object" if="@state='active'" out="e:entries">
                        <attribute in="id" out="key"/>
                        <attribute-ignore/>

                        <element-create>entry('id',../@title)</element-create>
                        <element-create>entry('number',../@title)</element-create>
                        <element-create>entry('start_date',../@start_date)</element-create>
                        <element-create>entry('end_date',../@due_date)</element-create>

                    </element>
                </elements-ignore>

            </element>

        </processors>

    </view>


    <view name="OPSCORE_renderReleaseNote_Raw" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">


        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.forge.baseurl')"/>
            <parameter name="connect-timeout">600</parameter>
            <parameter name="read-timeout">600</parameter>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <serializer type="CSVSerializer"/>

        <processors>
            <elements path="t:tables/t:table/t:row">
                <element-ignore in="t:column" if="@label='6'"/>
            </elements>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">25</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>

    <view name="OPSCORE_renderReleaseNote" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">

        <argument name="release_id"/>

      <connector type="XMLConnector">
          <parameter name="content" eval="view('OPSCORE_renderReleaseNote_Raw')"/>
      </connector>

        <processors>
            <elements path="t:tables/t:table">
                <element-ignore in="t:row" if="t:column[@label='5']/text()!=$release_id or t:column[@label='5']/text()='' or not(t:column[@label='5']/text())"/>
            </elements>
        </processors>

    </view>




    <view name="accounting-portal.cloud.all" xmlns:date="http://exslt.org/dates-and-times">

        <variable name="start_month" eval="date:month-in-year(date:add(date:date(),'-P14M'))"/>
        <variable name="start_year" eval="date:year(date:add(date:date(),'-P14M'))"/>
        <variable name="end_month" eval="date:month-in-year(date:date())"/>
        <variable name="end_year" eval="date:year(date:date())"/>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.baseurl'),'cloud/sum_elap_processors/SITE/DATE/',$start_year,'/',$start_month,'/',$end_year,'/',$end_month,'/egi/onlyinfrajobs/JSON')"/>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="item" out="results">
                <element in="object" out="site" if="id/text()!='Total' and id/text()!='Percent' and id/text()!='xlegend' and id/text()!='ylegend' and id/text()!='var'">
                    <attribute-create out="name">../id/text()</attribute-create>
                    <element out="date" if="starts-with(name(),'_')">
                        <attribute-create out="month">substring-after(name(..),'_')</attribute-create>
                        <attribute-create out="type">'full'</attribute-create>
                    </element>
                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>
        </processors>

    </view>

    <view name="accounting-portal.cloud.excluded" xmlns:date="http://exslt.org/dates-and-times">

        <variable name="start_month" eval="date:month-in-year(date:add(date:date(),'-P14M'))"/>
        <variable name="start_year" eval="date:year(date:add(date:date(),'-P14M'))"/>
        <variable name="end_month" eval="date:month-in-year(date:date())"/>
        <variable name="end_year" eval="date:year(date:date())"/>


        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.baseurl'),'cloud/sum_elap_processors/SITE/DATE/',$start_year,'/',$start_month,'/',$end_year,'/',$end_month,'/custom-dteam,fedcloud.egi.eu,ops/onlyinfrajobs/JSON')"/>
        </connector>
        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="item" out="results">
                <element in="object" out="site" if="id/text()!='Total' and id/text()!='Percent' and id/text()!='xlegend' and id/text()!='ylegend' and id/text()!='var'">
                    <attribute-create out="name">../id/text()</attribute-create>
                    <element out="date" if="starts-with(name(),'_')">
                        <attribute-create out="month">substring-after(name(..),'_')</attribute-create>
                        <attribute-create out="type">'excluded'</attribute-create>
                    </element>
                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>

            <element in="results">
                <element in="site">
                    <element in="date" if="text()='null'"><text>0</text></element>
                </element>
            </element>
        </processors>

    </view>

    <view name="accounting-portal.cloud.computed" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('accounting-portal.cloud.all')"></parameter>
        </connector>

        <processors>
            <element in="results">
                <element-create>view('accounting-portal.cloud.excluded')/results/*</element-create>
            </element>

            <element in="results">

                <element-ignore in="site"/>
                <element-create>sort_by_string(../site,'@name')</element-create>
            </element>

            <element in="results">
                <element-create-as-parent out="site" group-by="@name" attributes="@name">
                    <element-ignore in="site">
                        <element/>
                    </element-ignore>
                </element-create-as-parent>
            </element>

            <element in="results">
                <element in="site">

                    <element-ignore in="date"/>
                    <element-create>sort_by_string(../date,'@month')</element-create>
                </element>
            </element>


            <element in="results">
                <element in="site">
                    <element-create-as-parent out="result" group-by="@month" attributes="@month">
                        <element in="date"/>
                    </element-create-as-parent>
                </element>
            </element>

            <element in="results">
                <element in="site">
                    <element in="result">
                        <attribute-create out="diff">../date[@type='full'] - ../date[@type='excluded']</attribute-create>
                        <element-ignore/>
                    </element>
                </element>
            </element>

            <element in="results" out="e:entries">
                <attribute in="name" out="key"/>
                <element in="site" out="e:entries">
                    <element in="result" out="e:entry">
                        <attribute in="month" out="key"/>
                        <attribute-ignore/>
                        <text-create>../@diff</text-create>
                    </element>
                </element>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">12</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="cloud_reports" xmlns:date="http://exslt.org/dates-and-times" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <variable name="end_date" eval="substring(date:date(),0,11)"/>
        <variable name="start_date" eval="substring(date:add(date:date(),'-P15M'),0,11)"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://argo.egi.eu/lavoisier/cloud_reports?start_date=',$start_date,'&amp;end_date=',$end_date)"></parameter>
        </connector>

    <processors>

        <element in="root">
            <set variable="status" index="@key">view('OPSCORE_SITE_Fedcloud')/e:entries/e:entries</set>
            <set variable="accounting">view('accounting-portal.cloud.computed')/e:entries</set>
            <element in="group">
                <attribute-create out="status">find($status,../@name)/e:entry[@key='CERTIFICATION_STATUS']/text()</attribute-create>

                <attribute-ignore in="type"/>
                <attribute-ignore in="filters"/>
                <element in="results" if="count(preceding-sibling::results)>=2">
                    <attribute-create out="month1">../preceding-sibling::results[1]/@timestamp</attribute-create>
                    <attribute-create out="month2">../preceding-sibling::results[2]/@timestamp</attribute-create>
                    <attribute-create out="month1_av">../preceding-sibling::results[1]/@availability</attribute-create>
                    <attribute-create out="month2_av">../preceding-sibling::results[2]/@availability</attribute-create>
                    <attribute-create out="month1_re">../preceding-sibling::results[1]/@reliability</attribute-create>
                    <attribute-create out="month2_re">../preceding-sibling::results[2]/@reliability</attribute-create>
                    <attribute-create out="accounting">$accounting/e:entries[@name=current()/../ancestor::group/@name]/e:entry[@key=current()/../@timestamp]/text()</attribute-create>
                    <attribute-ignore in="unknown"/>
                    <attribute-ignore in="uptime"/>
                    <attribute-ignore in="downtime"/>
                </element>
                <element-ignore/>
            </element>
            <element-ignore/>
        </element>
        <element in="root">
            <element in="group">
                <element in="results">
                  <attribute-create out="month1_acc">../preceding-sibling::results[1]/@accounting</attribute-create>
                    <attribute-create out="month2_acc">../preceding-sibling::results[2]/@accounting</attribute-create>

                </element>
            </element>
        </element>
    </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">20</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <!-- VIEWS used to generate accouting reports : it seems not used anymore -->
    <!--
    <view name="OPSCORE_ACCPORTAL_VOS" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="XMLConnector">
            <parameter name="content" eval="view('VoEntries')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <set variable="listSiteEmail">view('vmRecipientsView')</set>
                <element in="e:entries" if="e:entry[@key='status']='Production'">
                    <element in="e:entry" if="@key='name'"/>
                    <element-ignore/>
                    <element-create>view('OPSCORE_ACCPORTAL_VO',entry('vo',../e:entry[@key='name']/text()))/e:entries/*</element-create>
                    <element-create>entry('email',choose($listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='name']/text()]/email/text(),$listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='name']/text()]/email/text(),'NA'))</element-create>
                </element>
                <element-ignore/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">156</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_ACCPORTAL_SITES" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_SITE')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <set variable="listSiteEmail">view('saRecipientsView')</set>
                <element in="e:entries" if="e:entry[@key='PRODUCTION_INFRASTRUCTURE']='Production' and e:entry[@key='CERTIFICATION_STATUS']='Certified' ">
                    <element-ignore/>
                    <element-create>view('OPSCORE_ACCPORTAL_SITE',entry('site',../e:entry[@key='NAME']/text()))/e:entries/*</element-create>
                    <element-create>entry('email',choose($listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='NAME']/text()]/email/text(),$listSiteEmail/Recipients/Recipient[label/text()=current()/../e:entry[@key='NAME']/text()]/email/text(),'NA'))</element-create>
                </element>
                <element-ignore/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">126</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="OPSCORE_ACCPORTAL_VO" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <argument name="vo"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.vo'),$vo)"/>
        </connector>

        <processors>
            <element in="root" out="e:entries">

                <element-ignore>
                    <element-create>entry(name(..),join(../text(),''))</element-create>
                </element-ignore>
            </element>
        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="OPSCORE_ACCPORTAL_SITE" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <argument name="site"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('accportal.site'),$site)"/>
        </connector>

        <processors>
            <element in="root" out="e:entries">
                <element-ignore>
                    <element-create>entry(name(..),join(../text(),''))</element-create>
                </element-ignore>
            </element>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

-->
    <view name="check-status">
        <argument name="threshold_warning">4</argument>
        <argument name="threshold_critical">8</argument>
        
        <connector type="XMLConnector">
            <parameter name="content" eval="view('status')"/>
        </connector>
        
        <processors>

            <element in="jmx" out="check-status">
                <element in="domain" out="views">
                    <attribute-ignore/>
                    <element-create>new_element('nb_views',count(../group/mbean))</element-create>
                    <element-create>new_element('nb_views_critical',count(../group/mbean[@status='FAILED']))</element-create>
                    <element-create>new_element('global_status',
                        choose(count(../group/mbean[@status='FAILED']) &gt;= $threshold_critical ,
                        'critical',
                        choose(count(../group/mbean[@status='FAILED']) &lt;= $threshold_warning ,'ok','warning')))</element-create>
                    <element-ignore/>
                </element>
                
            </element>
            
        </processors>

    </view>


</views>