<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >




    <view name="OPSCORE_AR_SITES" xmlns:date="http://exslt.org/dates-and-times">
        <variable name="start_time" eval="concat(substring(date:add(date:date-time(),'-P30D'), 0,11),'T00:00:00Z')"/>
        <variable name="end_time" eval="concat(substring(date:add(date:date-time(),'-P1D'), 0,11),'T00:00:00Z')"/>


        <connector type="HTTPConnector">
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="url">https://argo.egi.eu/lavoisier/reportOpsPortal?accept=xml</parameter>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <element in="root">
                <attribute-create out="base_url">'https://argo.egi.eu/egi/report-ar-group-details/Critical/SITES/'</attribute-create>


                <element-ignore in="group">
                    <element in="group" out="Site">
                        <attribute-create out="NGI">../ancestor::group/@name</attribute-create>
                        <attribute in="name" out="site"/>
                        <element in="results" out="Availability"/>
                    </element>
                </element-ignore>
            </element>

            <element in="root">
                <element-create-as-parent out="Profile">
                    <element in="Site"/>
                </element-create-as-parent>
            </element>

            <elements path="/root/Profile">
                <element in="Site">
                    <attribute-create out="Availability_average">sum(../Availability[@availability!='-1']/@availability) div  count(../Availability[@availability!='-1'])</attribute-create>
                    <attribute-create out="Reliability_average">sum(../Availability[@reliability!='-1']/@reliability) div  count(../Availability[@reliability!='-1'])</attribute-create>
                    <attribute-create out="Unknown_average">100 * sum(../Availability[@unknown!='-1']/@unknown) div  count(../Availability[@unknown!='-1'])</attribute-create>
                </element>
            </elements>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">6</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">xml</parameter>
            </renderer>
        </renderers>

        </view>



</views>