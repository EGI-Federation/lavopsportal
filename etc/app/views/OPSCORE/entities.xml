<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"  >



    <view name="OPSCORE_get_site">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_sites')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_get_site_Fedcloud">
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_sites'),'&amp;scope=FedCloud')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_sites_info" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('OPSCORE.gocdb.get_sites'),'&amp;scope=Local,EGI&amp;scope_match=any')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">

                <element in="SITE" out="e:entries" if="CERTIFICATION_STATUS/text()!='Closed'">
                    <attribute-create out="ngi">../ROC/text()</attribute-create>
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore/>

                    <element-create>entry('PRIMARY_KEY',../PRIMARY_KEY/text())</element-create>
                    <element-create>entry('NAME',../SHORT_NAME/text())</element-create>
                    <element-create>entry('NGI',../ROC/text())</element-create>
                    <element-create>entry('COUNTRY',../COUNTRY_CODE/text())</element-create>
                    <element-create if="../PRODUCTION_INFRASTRUCTURE/text()='Production'">entry('PRODUCTION',1)</element-create>
                    <element-create if="../PRODUCTION_INFRASTRUCTURE/text()!='Production'">entry('PRODUCTION',0)</element-create>
                    <element-create if="../CERTIFICATION_STATUS/text()='Certified'">entry('CERTIFIED',1)</element-create>
                    <element-create if="../CERTIFICATION_STATUS/text()!='Certified'">entry('CERTIFIED',0)</element-create>

                    <element-create if="../SCOPES/SCOPE='Local'">entry('LOCAL',1)</element-create>
                    <element-create if="not(../SCOPES/SCOPE='Local')">entry('LOCAL',0)</element-create>



                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_SITE" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">
                <set variable="ngi">view('OPSCORE_NGI')/*</set>
                <element in="SITE" out="e:entries" if="CERTIFICATION_STATUS/text()!='Closed'">
                    <attribute-create out="ngi">../ROC/text()</attribute-create>
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore/>

                    <element-create>entry('PRIMARY_KEY',../PRIMARY_KEY/text())</element-create>
                    <element-create>entry('NAME',../SHORT_NAME/text())</element-create>
                    <element-create>entry('NGI',../ROC/text())</element-create>

                    <element-create>entry('COUNTRY',../COUNTRY_CODE/text())</element-create>
                    <element-create>entry('PRODUCTION_INFRASTRUCTURE',../PRODUCTION_INFRASTRUCTURE/text())</element-create>
                    <element-create>entry('CERTIFICATION_STATUS',../CERTIFICATION_STATUS/text())</element-create>
                    <element-create>entry('CONTACT_EMAIL',choose(../CONTACT_EMAIL/text(),../CONTACT_EMAIL/text(),'NA'))</element-create>

                    <element-create>entry('NGI_EMAIL',choose($ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='EMAIL']/text(),$ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='EMAIL']/text(),'na'))</element-create>
                    <element-create>entry('ROD_EMAIL',choose($ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='ROD_EMAIL']/text(),$ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='ROD_EMAIL']/text(),'na'))</element-create>
                    <element-create>entry('NGI_SEC_EMAIL',choose($ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='SECURITY_EMAIL']/text(),$ngi/e:entries[@key=current()/../ROC/text()]/e:entry[@key='SECURITY_EMAIL']/text(),'na'))</element-create>



                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>
            

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_SITE_Fedcloud" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site_Fedcloud')"/>
        </connector>

        <processors>
            <element in="results" out="e:entries">
                <element in="SITE" out="e:entries">
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore/>

                    <element-create>entry('PRIMARY_KEY',../PRIMARY_KEY/text())</element-create>
                    <element-create>entry('NAME',../SHORT_NAME/text())</element-create>
                    <element-create>entry('NGI',../ROC/text())</element-create>
                    <element-create>entry('COUNTRY',../COUNTRY_CODE/text())</element-create>
                    <element-create>entry('PRODUCTION_INFRASTRUCTURE',../PRODUCTION_INFRASTRUCTURE/text())</element-create>
                    <element-create>entry('CERTIFICATION_STATUS',../CERTIFICATION_STATUS/text())</element-create>
                    <element-create>entry('CONTACT_EMAIL',choose(../CONTACT_EMAIL/text(),../CONTACT_EMAIL/text(),'NA'))</element-create>
                    <element-ignore/>
                </element>

            </element>
        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="OPSCORE_SITE_CANDIDATE" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_sites_candidate')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>


        <processors>
            <element in="results" out="e:entries">
                <element in="SITE" out="e:entries">
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore/>
                    <element-create>entry('PRIMARY_KEY',../@PRIMARY_KEY)</element-create>
                    <element-create>entry('NAME',../@NAME)</element-create>
                    <element-create>entry('NGI',../@ROC)</element-create>
                    <element-create>entry('COUNTRY',../@COUNTRY_CODE)</element-create>
                    <element-ignore/>
                </element>

            </element>
        </processors>


        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_site_T1">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <element in="results">
                <element in="SITE" if="TIER/text()=1"/>
                <element-ignore/>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>


    </view>

    <view name="roc-site_INDEX" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_prod_sites')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

    <processors>
        <processor match="/results/SITE/*[name()!='ROC' and name()!='CONTACT_EMAIL']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
        <processor match="/results/SITE[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('Email',choose(match()/CONTACT_EMAIL/text(),match()/CONTACT_EMAIL/text(),'NA') ) "/></processor>

        <processor match="/results/SITE" type="SelectGroupByProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="group_by" eval="ROC/text()"/><parameter name="sort_type">text</parameter></processor>
        <processor match="/results" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">Rocs</parameter></processor>
        <processor match="/Rocs/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_element('Id',new_text(match()/@key))"/><parameter name="destination_as">first_child</parameter></processor>
        <processor match="/Rocs/e:entry" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">Roc</parameter></processor>
        <processor match="/Rocs/Roc/SITE" type="InsertParentProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">Sites</parameter></processor>
        <processor match="/Rocs/Roc/Sites" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('PARSING_CHILDREN_MODE','FORCE_INDEX')"/></processor>
        <processor match="/Rocs/Roc/Sites/SITE" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">SiteName</parameter></processor>
        <processor match="/Rocs/Roc/Sites/SiteName/@ID" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
        <processor match="/Rocs/Roc/@key" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">id</parameter></processor>
        <processor match="/Rocs/Roc/Sites/SiteName/@PRIMARY_KEY" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">GocId</parameter></processor>
        <processor match="/Rocs/Roc/Sites/SiteName" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_text(@NAME)"/></processor>
        <processor match="/Rocs/Roc/Sites/SiteName/@NAME" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
    </processors>



        <!--<cache type="FileCache">-->
            <!--<trigger type="DeltaTimeTrigger">-->
                <!--<parameter name="hours">2</parameter>-->
            <!--</trigger>-->
            <!--<trigger type="ViewNotifiedTrigger"/>-->
            <!--<trigger ignore-during="PT2H" type="ViewCreatedTrigger"/>-->
        <!--</cache>-->
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_site_list_prod" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_get_site')"/>
        </connector>

        <processors>
            <processor match="/results/SITE[PRODUCTION_INFRASTRUCTURE='Production'][CERTIFICATION_STATUS='Certified']" type="SelectProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/SITE/*[local-name()!='ROC' and local-name()!='SHORT_NAME']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/SITE/@*[local-name()!='NAME']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/SITE" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/e:entries/e:entries/SHORT_NAME[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('site',text())"/></processor>
            <processor match="/e:entries/e:entries/ROC[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('ngi',text())"/></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_get_site</entry>
                </parameter>
            </trigger>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>




    <view name="OPSCORE_update_siteDB" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.update.siteDB')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="force-redirect">true</parameter>
            <parameter name="connect-timeout">120</parameter>
            <parameter name="read-timeout">120</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">6</parameter>
            </trigger>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>


    </view>



    <view name="OPSCORE_prod_entities_0" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="disable-default-XPath" path-format="value">true</argument>
        <connector type="XMLConnector">
                    <parameter name="content" eval="view('OPSCORE_get_roc_contacts')"/>
        </connector>
        <processors>
                    <processor match="/results/ROC[@ROC_NAME = parent_match()/@Name]/MAIL_CONTACT" type="SelectProcessor"><parameter name="single_node">true</parameter></processor>
                </processors>
    </view>

    <view name="OPSCORE_prod_entities" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">



        <connector type="HTTPConnector">
            <!--<parameter name="url" eval="property('OPSCORE.gocdb.get_prod_sites')"/>-->
            <parameter name="url" eval="property('OPSCORE.gocdb.get_sites')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>

        <processors>

            <!-- preparing structure -->
            <processor match="/results/SITE/*[not(name()='ROC' or name()='CONTACT_EMAIL' or name()='CSIRT_EMAIL' or name()='PRODUCTION_INFRASTRUCTURE' or name()='CERTIFICATION_STATUS')]" type="RemoveProcessor"/>
            <processor match="/results/SITE/*" type="MergeProcessor"/>
            <processor match="/results/SITE" type="MultiMergeProcessor"><parameter name="count">5</parameter></processor>
            <processor match="/results/SITE" type="SelectGroupByProcessor"><parameter name="group_by" eval="@ROC"/><parameter name="sort_type">text</parameter></processor>
            <processor match="/results/e:entry" type="RenameProcessor"><parameter name="node_name">NGI</parameter></processor>
            <processor match="/results/NGI/@key" type="RenameProcessor"><parameter name="node_name">name</parameter></processor>
            <processor match="/results" type="RenameProcessor"><parameter name="node_name">NGIs</parameter></processor>
            <processor match="/NGIs/NGI" type="InsertProcessor"><parameter name="destination_as">first_child</parameter><parameter name="nodes" eval="new_element('tmp')"/></processor>
            <processor match="/NGIs/NGI/tmp" type="InsertProcessor"><parameter name="nodes" eval="new_attribute('name', ancestor::NGI/@name)"/></processor>

            <!-- joining NGI data -->
            <processor match="/NGIs/NGI/tmp[* or not(*)]" type="InsertProcessor"><parameter name="nodes" eval="view('OPSCORE_NGIs')/NGIs/NGI[@Name = match()/@name]"/></processor>
            <processor match="/NGIs/NGI/tmp/NGI[* or not(*)]" type="InsertProcessor"><parameter name="nodes" eval="view_path_post('OPSCORE_prod_entities_0', choose(path(false()), path(false()), ''), match(), arguments())"/></processor>
            <processor match="/NGIs/NGI/tmp/NGI/MAIL_CONTACT" type="RenameProcessor"><parameter name="node_name">contact_email</parameter></processor>
            <processor match="/NGIs/NGI/tmp/NGI/contact_email" type="MergeProcessor"/>

            <processor match="/NGIs/NGI/tmp/NGI" type="MergeProcessor"/>

            <processor match="/NGIs/NGI/tmp" type="RemoveProcessor"><parameter name="depth">1</parameter></processor>
            <processor match="/NGIs/NGI" type="MergeProcessor"/>
            <processor match="/NGIs/NGI/@GgusSU" type="RenameProcessor"><parameter name="node_name">ggus_su</parameter></processor>
            <processor match="/NGIs/NGI/@RodMail" type="RenameProcessor"><parameter name="node_name">rod_email</parameter></processor>


            <processor match="/NGIs/NGI" type="InsertProcessor"><parameter name="destination_as">last_child</parameter><parameter name="nodes" eval="new_element('Sites')"/></processor>
            <processor match="/NGIs/NGI/SITE" type="MoveProcessor"><parameter name="destination_axis">following-sibling</parameter><parameter name="destination_name">Sites</parameter></processor>
            <processor match="/NGIs/NGI/Sites/SITE" type="RenameProcessor"><parameter name="node_name">Site</parameter></processor>
            <processor match="/NGIs/NGI/@Name" type="RemoveProcessor"/>

            <processor match="/NGIs/NGI/Sites/Site/@ROC" type="RenameProcessor"><parameter name="node_name">ngi</parameter></processor>
            <processor match="/NGIs/NGI/Sites/Site/@PRIMARY_KEY" type="RenameProcessor"><parameter name="node_name">primary_key</parameter></processor>
            <processor match="/NGIs/NGI/Sites/Site/@NAME" type="RenameProcessor"><parameter name="node_name">name</parameter></processor>
            <processor match="/NGIs/NGI/Sites/Site/@CONTACT_EMAIL" type="RenameProcessor"><parameter name="node_name">contact_email</parameter></processor>
            <processor match="/NGIs/NGI/Sites/Site/@CSIRT_EMAIL" type="RenameProcessor"><parameter name="node_name">csirt_email</parameter></processor>
            <processor match="/NGIs/NGI/Sites/Site/@ID" type="RenameProcessor"><parameter name="node_name">id</parameter></processor>

            <processor match="/NGIs/NGI/Sites/Site/@PRODUCTION_INFRASTRUCTURE" type="ReplaceProcessor"><parameter name="nodes" eval="new_attribute('production',choose(match()='Production',1,0))"/></processor>
            <processor match="/NGIs/NGI/Sites/Site/@CERTIFICATION_STATUS" type="ReplaceProcessor"><parameter name="nodes" eval="new_attribute('certified',choose(match()='Certified',1,0))"/></processor>


        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_users</entry>
                    <entry>OPSCORE_downtime_ongoing_raw</entry>
                </parameter>
                <parameter name="all">true</parameter>
            </trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">18</parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_prod_entities_certified" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>
        <processors>

            <processor match="/NGIs/NGI/Sites/Site[@production=0 or @certified=0]" type="RemoveProcessor">
                <namespaces>
                    <entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry>
                </namespaces>
            </processor>

            <elements path="NGIs/NGI/Sites">
                <element-ignore in="Site"/>
                <element-create>sort_by_string(../Site,'@name')</element-create>
            </elements>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_prod_entities</entry>
                </parameter>

            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_entities_map" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="entry_key" path-format="none"/>
        <argument name="entry_value" path-format="none"/>
        <argument name="entity_type" path-format="none" pattern="ngi|site"/>
        <argument name="xpath" path-format="none" eval="choose($entity_type = 'site','/NGIs/NGI/Sites/Site', '/NGIs/NGI')"/>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_prod_entities')"/>
        </connector>

        <processors>
            <processor type="RenameProcessor" match="eval(concat(choose($entity_type = 'site','/NGIs/NGI/Sites/Site', '/NGIs/NGI'),'/@',$entry_value))">
                <parameter name="node_name">entry_value</parameter>
            </processor>
            <processor type="RenameProcessor" match="eval(concat(choose($entity_type = 'site','/NGIs/NGI/Sites/Site', '/NGIs/NGI'),'/@',$entry_key))">
                <parameter name="node_name">entry_key</parameter>
            </processor>
            <processor type="ReplaceProcessor" match="eval(concat(choose($entity_type = 'site','/NGIs/NGI/Sites/Site', '/NGIs/NGI'),'[@entry_key]'))">
                <parameter name="nodes" eval="entry(@entry_key , choose(@entry_value, @entry_value, ''))"/>
            </processor>
            <processor match="//*[not(self::e:entry | self::NGIs)]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/NGIs" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor type="SelectProcessor" match="eval(path())" disabled="not(boolean(path(false())))">
                <namespaces>
                    <entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry>
                </namespaces>

            </processor>

            <element in="e:entries">
                <element in="e:entry" if="@key='EGI.eu'">
                    <attribute-ignore in="key"/>
                    <attribute-create out="key">'EGI Operations'</attribute-create>
                </element>
            </element>

        </processors>
    </view>




    <view name="OPSCORE_get_site_av_re" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.get_sites_av_re')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="force-redirect">true</parameter>
            <parameter name="connect-timeout">60</parameter>
            <parameter name="read-timeout">60</parameter>
        </connector>

        <processors>

            <processor match="/root/site/@name" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">key</parameter></processor>
            <processor match="/root/site/@*[local-name()!='key']" type="MoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="destination_axis">following-sibling</parameter></processor>
            <processor match="/root/site" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/root" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/e:entries/e:entries" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('availability', @availability)"/></processor>
            <processor match="/e:entries/e:entries" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('reliability', @reliability)"/></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT4H" type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_NGIs">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_ngis')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <processor match="/results" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">NGIs</parameter></processor>
            <processor match="/NGIs/NGI/*[local-name()!='GGUS_SU' and local-name()!='ROD_EMAIL' and local-name()!='SECURITY_EMAIL']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/NGIs/NGI/*" type="MergeProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/NGIs/NGI" type="MultiMergeProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="count">3</parameter></processor>
            <!-- match original ngi_info flat file case -->
            <processor match="/NGIs/NGI/@ROD_EMAIL" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">RodMail</parameter></processor>
            <processor match="/NGIs/NGI/@SECURITY_EMAIL" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">SecurityMail</parameter></processor>
            <processor match="/NGIs/NGI/@GGUS_SU" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">GgusSU</parameter></processor>
            <processor match="/NGIs/NGI/@NAME" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">Name</parameter></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">8</parameter>
            </trigger>
        </cache>

    </view>

    <view name="OPSCORE_NGI" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_ngis')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <element in="results" out="e:entries">
                <element in="NGI" out="e:entries">
                    <attribute-create out="key">../@NAME</attribute-create>
                    <attribute-ignore in="NAME"/>

                    <element-create>entry('PRIMARY_KEY',../PRIMARY_KEY/text())</element-create>
                    <element-create>entry('NAME',../NAME/text())</element-create>
                    <element-create>entry('EMAIL',choose(../EMAIL/text(),../EMAIL/text(),'NA'))</element-create>
                    <element-create>entry('ROD_EMAIL',choose(../ROD_EMAIL/text(),../ROD_EMAIL/text(),'NA'))</element-create>
                    <element-create>entry('SECURITY_EMAIL',choose(../SECURITY_EMAIL/text(),../SECURITY_EMAIL/text(),'NA'))</element-create>
                    <element-ignore/>
                </element>
            </element>
        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_osg_sites" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.osg.sites')"/>
        </connector>

        <processors>
            <element in="RSVStatusMap" out="Sites">
                <element-ignore in="Sites">
                    <element in="Site">
                        <attribute-create out="name">../Name/text()</attribute-create>
                        <attribute-create out="Id">../ID/text()</attribute-create>
                        <attribute-create out="Status">Production</attribute-create>
                        <element-ignore/>
                    </element>
                </element-ignore>
            </element>

        </processors>


    </view>

    <view name="OPSCORE_ENDPOINTS_Indexed" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_endpoints')"/>
        </connector>
        <processors>

            <element in="results" out="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'@ngi')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" group-by="@ngi" attributes="@*">
                    <element in="e:entries">
                        <attribute-ignore in="key"/>
                    </element>
                </element-create-as-parent>
            </element>



            <element in="e:entries">
                <element in="e:entries">
                    <attribute-ignore/>
                    <attribute-create out="key">../@ngi</attribute-create>
                    <element-ignore in="e:entries"/>
                    <element-create>sort_by_string(../e:entries,'@site')</element-create>
                </element>
            </element>

            <element in="e:entries">
            <element in="e:entries">

                <element-create-as-parent out="e:entries" group-by="@site" attributes="@site">
                    <element in="e:entries">

                    </element>
                </element-create-as-parent>
            </element>
            </element>
            <element in="e:entries">
                <element in="e:entries">
                        <element in="e:entries">
                            <attribute in="site" out="key"/>
                            <element in="e:entries">
                                <attribute-ignore/>
                                <attribute-create out="key">../@hostname</attribute-create>
                            </element>
                        </element>

                </element>
            </element>




        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


</views>