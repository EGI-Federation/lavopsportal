<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd">



<view name="OPSCORE_superUser" authenticators="local">
    <connector type="FileConnector">
        <parameter name="path">/app/resources/xml/superUser.xml</parameter>
    </connector>

</view>

    <view name="OPSCORE_users" authenticators="local">

        <connector type="XSLTConnector">
            <!-- required: The XSLT stylesheet (Xml) -->
            <parameter name="stylesheet" eval="document('/app/resources/xsl/egi_users.xsl')"/>

            <parameter name="documents">
                <entry key="get_user" eval="view('OPSCORE_users_goc')"/>
                <entry key="csi_csirt-team" eval="view('OPSCORE_users_csi')"/>
            </parameter>
        </connector>

        <processors>
            <element in="root">
                <element in="EGEE_USER">
                    <element-create>view('OPSCORE_superUser')</element-create>
                </element>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_users_agg_emails" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_users_goc')"/>
        </connector>

        <processors>

            <element in="results">
                <element-create as="last-child">view('OPSCORE_users_cic')</element-create>
                <element-create as="last-child">view('OPSCORE_users_cic_serial')</element-create>
                <element-create as="last-child">view('OPSCORE_users_csi')</element-create>

            </element>

            <element in="results" out="e:entries">

                <element in="EGEE_USER" out="e:entries">

                    <element-create>entry('NAME',new_text(concat(../FORENAME/text(),' ',../SURNAME/text())))</element-create>
                    <element-create>entry('EMAIL',new_text(../EMAIL/text()))</element-create>
                    <element-create>entry('CERTDN',new_text(../CERTDN/text()))</element-create>
                    <element-ignore if="name()!='USER_ROLE'"/>

                    <element-ignore in="USER_ROLE">
                        <element-create>entry('ROLES',concat(../USER_ROLE/text(),'::',../ENTITY_TYPE/text(),'::',../ON_ENTITY/text()))</element-create>
                    </element-ignore>
                </element>

                <element-ignore in="result">
                    <element in="row" out="e:entries">
                        <element-create>entry('ROLES',concat(../e:entry[@key="USER_ROLE"]/text(),'::',../e:entry[@key="ENTITY_TYPE"]/text(),'::',../e:entry[@key="ON_ENTITY"]/text()))</element-create>
                        <element-ignore if="@key='USER_ROLE' or @key='ENTITY_TYPE' or @key='ON_ENTITY'"/>
                        <element in="e:entry" if="@key='CN'">
                            <attribute-ignore in="key"/>
                            <attribute-create out="key">'NAME'</attribute-create>
                        </element>
                    </element>
                </element-ignore>

                <element-ignore in="CSIRTTeam" >
                    <element-ignore in="Users">
                        <element in="EGEE_USER" out="e:entries">

                            <element-create>entry('PRIMARY_KEY',new_text(../@PRIMARY_KEY))</element-create>
                            <element-create>entry('NAME',new_text(concat(../FORENAME/text(),../SURNAME/text())))</element-create>
                            <element-create>entry('EMAIL',new_text(../EMAIL/text()))</element-create>
                            <element-create>entry('CERTDN',new_text(../CERTDN/text()))</element-create>
                            <element-ignore if="name()!='USER_ROLE'"/>
                            <element-ignore in="USER_ROLE">
                                <element-create>entry('ROLES',concat('EGI CSIRT Officer::',../ENTITY_TYPE/text(),'::',../ON_ENTITY/text()))</element-create>
                            </element-ignore>
                        </element>


                    </element-ignore>
                    <element-ignore/>
                </element-ignore>

            </element>


            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="key">../e:entry[@key="EMAIL"]/text()</attribute-create>
                </element>
            </element>

<!--            <element in="e:entries">-->
<!--                <element-create as="first-child">choose(view("OPSCORE_fake_users")/e:entries/*,view("OPSCORE_fake_users")/e:entries/*,entries())</element-create>-->
<!--            </element>-->

            <element in="e:entries">
                <element-ignore in="e:entries" if="@key='' or @key='-' or @key='--'"/>
            </element>


            <element in="e:entries">
                <element-ignore/>
                <element-create>sort_by_string(../e:entries,'@key')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" group-by="@key" attributes="@key">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-ignore in="e:entries">
                        <element/>
                    </element-ignore>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-ignore in="e:entry" if="@key!='ROLES'"/>
                    <element-create>entry('NAME',choose(../e:entry[@key='NAME'][1]/text(),../e:entry[@key='NAME'][1]/text(),'NA'))</element-create>
                    <element-create>entry('EMAIL',choose(../e:entry[@key='EMAIL'][1]/text(),../e:entry[@key='EMAIL'][1]/text(),'NA'))</element-create>
                    <element-create>entry('CERTDN',choose(../e:entry[@key='CERTDN'][1]/text(),../e:entry[@key='CERTDN'][1]/text(),'NA'))</element-create>
                </element>
            </element>



            <element in="e:entries">
                <element in="e:entries">
                    <element-create-as-parent out="e:entries">
                        <element in="e:entry" if="@key='ROLES'"/>
                    </element-create-as-parent>
                </element>
            </element>


            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entries">
                        <attribute-create out="key">'ROLES'</attribute-create>
                        <element in="e:entry">
                            <attribute-ignore/>
                        </element>
                    </element>
                </element>
            </element>


            <elements path="e:entries/e:entries">
                <element in="e:entries" if="@key='ROLES'">
                    <element-ignore in="e:entry"/>
                    <element-create>uniq(../e:entry,'text()')</element-create>
                </element>

            </elements>

        </processors>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">21</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_users_agg" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_users_goc')"/>
        </connector>

        <processors>

            <element in="results">
                <element-create as="last-child">view('OPSCORE_users_cic')</element-create>
                <element-create as="last-child">view('OPSCORE_users_cic_serial')</element-create>
                <element-create as="last-child">view('OPSCORE_users_csi')</element-create>

            </element>

            <element in="results" out="e:entries">

                <element in="EGEE_USER" out="e:entries">

                    <element-create>entry('NAME',new_text(concat(../FORENAME/text(),' ',../SURNAME/text())))</element-create>
                    <element-create>entry('EMAIL',new_text(../EMAIL/text()))</element-create>
                    <element-create>entry('CERTDN',new_text(../CERTDN/text()))</element-create>
                    <element-ignore if="name()!='USER_ROLE'"/>

                    <element-ignore in="USER_ROLE">
                        <element-create>entry('ROLES',concat(../USER_ROLE/text(),'::',../ENTITY_TYPE/text(),'::',../ON_ENTITY/text()))</element-create>
                    </element-ignore>
                </element>

                <element-ignore in="result">
                    <element in="row" out="e:entries">
                        <element-create>entry('ROLES',concat(../e:entry[@key="USER_ROLE"]/text(),'::',../e:entry[@key="ENTITY_TYPE"]/text(),'::',../e:entry[@key="ON_ENTITY"]/text()))</element-create>
                        <element-ignore if="@key='USER_ROLE' or @key='ENTITY_TYPE' or @key='ON_ENTITY'"/>
                        <element in="e:entry" if="@key='CN'">
                           <attribute-ignore in="key"/>
                            <attribute-create out="key">'NAME'</attribute-create>
                        </element>
                    </element>
                </element-ignore>

                <element-ignore in="CSIRTTeam" >
                    <element-ignore in="Users">
                        <element in="EGEE_USER" out="e:entries">

                            <element-create>entry('PRIMARY_KEY',new_text(../@PRIMARY_KEY))</element-create>
                            <element-create>entry('NAME',new_text(concat(../FORENAME/text(),../SURNAME/text())))</element-create>
                            <element-create>entry('EMAIL',new_text(../EMAIL/text()))</element-create>
                            <element-create>entry('CERTDN',new_text(../CERTDN/text()))</element-create>
                            <element-ignore if="name()!='USER_ROLE'"/>
                            <element-ignore in="USER_ROLE">
                                <element-create>entry('ROLES',concat('EGI CSIRT Officer::',../ENTITY_TYPE/text(),'::',../ON_ENTITY/text()))</element-create>
                            </element-ignore>
                        </element>


                    </element-ignore>
                    <element-ignore/>
                </element-ignore>

            </element>


            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="key">../e:entry[@key="CERTDN"]/text()</attribute-create>
                </element>
            </element>

            <element in="e:entries">
                <element-create as="first-child">choose(view("OPSCORE_fake_users")/e:entries/*,view("OPSCORE_fake_users")/e:entries/*,entries())</element-create>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="@key='' or @key='-' or @key='--'"/>
            </element>


            <element in="e:entries">
                <element-ignore/>
                <element-create>sort_by_string(../e:entries,'@key')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" group-by="@key" attributes="@key">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-ignore in="e:entries">
                        <element/>
                    </element-ignore>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <element-ignore in="e:entry" if="@key!='ROLES'"/>
                    <element-create>entry('NAME',choose(../e:entry[@key='NAME'][1]/text(),../e:entry[@key='NAME'][1]/text(),'NA'))</element-create>
                    <element-create>entry('EMAIL',choose(../e:entry[@key='EMAIL'][1]/text(),../e:entry[@key='EMAIL'][1]/text(),'NA'))</element-create>
                    <element-create>entry('CERTDN',choose(../e:entry[@key='CERTDN'][1]/text(),../e:entry[@key='CERTDN'][1]/text(),'NA'))</element-create>
                </element>
            </element>



            <element in="e:entries">
                <element in="e:entries">
                   <element-create-as-parent out="e:entries">
                       <element in="e:entry" if="@key='ROLES'"/>
                   </element-create-as-parent>
                </element>
            </element>


            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entries">
                        <attribute-create out="key">'ROLES'</attribute-create>
                        <element in="e:entry">
                            <attribute-ignore/>
                        </element>
                    </element>
                </element>
            </element>


            <elements path="e:entries/e:entries">
                <element in="e:entries" if="@key='ROLES'">
                    <element-ignore in="e:entry"/>
                    <element-create>uniq(../e:entry,'text()')</element-create>
                </element>

            </elements>

        </processors>



        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">31</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_fake_users"  authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <argument name="envnt" eval="property('env')"/>

        <connector type="FileConnector">
            <parameter name="path">/app/resources/xml/fake_users.xml</parameter>
        </connector>

        <processors>
            <element in="e:entries">
                <element if="starts-with($envnt,'test')"/>
                <element if="$envnt='prod' and not(contains(@key,'test'))"/>
                <element-ignore/>
            </element>
        </processors>



    </view>


    <view name="OPSCORE_user" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >


        <argument name="DN">_DN_</argument>
        <argument name="email">_email_</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="choose($DN!='_DN_',view('OPSCORE_users_agg'),view('OPSCORE_users_agg_emails'))"/>
        </connector>

        <processors>
            <element in="e:entries" if="$DN!='_DN_'">
               <element in="e:entries" if="e:entry[@key='CERTDN']/text()=$DN"/>
                <element-ignore/>
            </element>

            <element in="e:entries" if="$email!='_email_'">
                <element in="e:entries" if="e:entry[@key='EMAIL']/text()=$email"/>
                <element-ignore/>
            </element>


      </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>



    <view name="OPSCORE_users_csi" authenticators="local">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.users.csi')"/>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="force-redirect">true</parameter>
            <parameter name="connect-timeout">30</parameter>
            <parameter name="read-timeout">30</parameter>
        </connector>


        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT3H" type="ViewCreatedTrigger"/>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="OPSCORE_users_goc">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_user')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <elements path="/results/EGEE_USER">
                <element in="USER_ROLE">
                    <element-ignore in="PRIMARY_KEY"/>
                </element>
                <element in="CERTDN" if="contains(text(),'@egi.eu') and not(contains(text(),'/DC='))">
                    <text>concat('/O=AAI/CN=',../../FORENAME/text(),' ',../../SURNAME/text(),'/Id=',.)</text>
                </element>
            </elements>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT3H" type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_users_cic_serial" authenticators="local">


        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                SELECT v.serial as ON_ENTITY, password( concat(c.first_name,' ' ,c.last_name) ) as PRIMARY_KEY,
                concat(c.first_name,' ' ,c.last_name) as CN , c.email as EMAIL , c.DN as CERTDN , p.profile as USER_ROLE
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND h.status_id IN (1,2,8)
            </parameter>
        </connector>

        <processors>
            <processor match="/result/row/*[text()]" type="ReplaceProcessor"><parameter name="nodes" eval="entry(local-name(),text())"/></processor>
            <processor match="/result/row" type="InsertProcessor"><parameter name="nodes" eval="entry('ENTITY_TYPE','voSerial')"/></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_users_cic" authenticators="local">

        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                SELECT v.name as ON_ENTITY, password( concat(c.first_name,' ' ,c.last_name) ) as PRIMARY_KEY,
                concat(c.first_name,' ' ,c.last_name) as CN , c.email as EMAIL , c.DN as CERTDN , p.profile as USER_ROLE
                FROM vo v, vo_header h, vo_contacts c, vo_contact_has_profile cp, vo_user_profile p
                WHERE v.header_id = h.id
                AND v.serial = cp.serial
                AND cp.contact_id = c.id
                AND cp.user_profile_id = p.id
                AND h.status_id IN (1,2,8)
            </parameter>
        </connector>

        <processors>
            <processor match="/result/row/*[text()]" type="ReplaceProcessor"><parameter name="nodes" eval="entry(local-name(),text())"/></processor>
            <processor match="/result/row" type="InsertProcessor"><parameter name="nodes" eval="entry('ENTITY_TYPE','vo')"/></processor>
            <processor match="/result" type="InsertProcessor"><parameter name="nodes" eval="view('OPSCORE_users_grid_body')/result/row"/><parameter name="destination_as">first_child</parameter></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_users_grid_body</entry>
                </parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="OPSCORE_users_grid_body" authenticators="local">


        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                SELECT password( concat(c.first_name,' ' ,c.last_name) ) as PRIMARY_KEY, concat(c.first_name,' '
                ,c.last_name) as CN , c.email as EMAIL , c.DN as CERTDN
                FROM vo_contacts c
                WHERE c.grid_body='1'
            </parameter>
        </connector>

        <processors>
            <processor match="/result/row/*[text()]" type="ReplaceProcessor"><parameter name="nodes" eval="entry(local-name(),text())"/></processor>
            <processor match="/result/row" type="InsertProcessor"><parameter name="nodes" eval="entry('ENTITY_TYPE','project')"/></processor>
            <processor match="/result/row" type="InsertProcessor"><parameter name="nodes" eval="entry('ON_ENTITY','EGI')"/></processor>
            <processor match="/result/row" type="InsertProcessor"><parameter name="nodes" eval="entry('USER_ROLE','GRID BODY')"/></processor>
        </processors>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">1</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT1H" type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_vo_users_raw" authenticators="local">

        <variable name="duree" eval="choose(property('env')='test',5555,5)"/>
        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
                SELECT USERVO , DN as CERTDN , CA, VO , EMAIL , LAST_UPDATE , FIRST_UPDATE
                FROM vo_users
                WHERE
                DATEDIFF(NOW(),LAST_UPDATE)&lt; <entry eval="$duree"/>
            </parameter>

        </connector>

        <processors>

            <element in="result">
                <set variable="vomsMembers2">view('VomsMembers_v2')/vos</set>
                <element in="row">
                    <element-create if="$vomsMembers2/vo[@name=current()/../VO/text()]/user[certificates/object/subjectString/text()=current()/../CERTDN/text()]/fqans/item">$vomsMembers2/vo[@name=current()/../VO/text()]/user[certificates/object/subjectString/text()=current()/../CERTDN/text()]/fqans</element-create>
                </element>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
         <trigger type="DeltaTimeTrigger">
             <parameter name="hours">3</parameter>
             <parameter name="minutes">6</parameter>
         </trigger>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_vo_users_history" authenticators="local">


        <connector type="SQLConnector">
            <parameter name="driver">com.mysql.jdbc.Driver</parameter>
            <parameter name="url" eval="property('OPSCORE.db.url')"/>
            <parameter name="username" eval="property('OPSCORE.db.username')"/>
            <parameter name="password" eval="property('OPSCORE.db.password')"/>
            <parameter name="query">
               SELECT vo , u_month , u_year , nbtotal , nbremoved , nbadded
                FROM vo_users_history
            </parameter>



        </connector>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
                <parameter name="minutes">25</parameter>
            </trigger>

        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="OPSCORE_vo_users_robots" authenticators="local">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_vo_users_raw')"/>
        </connector>
        <processors>
            <processor match="/result/row[not(contains(CERTDN,'Robot:'))]" type="RemoveProcessor"/>
        </processors>

        <cache type="FileCache">
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>OPSCORE_vo_users_raw</entry>
                </parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="OPSCORE_users_roles" authenticators="local">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('OPSCORE_users')"/>
        </connector>

        <processors>

            <processor match="/root/EGEE_USER/USER_ROLE[ENTITY_TYPE = 'group' and ON_ENTITY='EGI']/ENTITY_TYPE/text()" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_text('project')"/></processor>
            <processor match="/root/EGEE_USER/USER_ROLE[ENTITY_TYPE = 'group']/ENTITY_TYPE/text()" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_text('ngi')"/></processor>
            <processor match="/root/EGEE_USER/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry(local-name(),text()) "/></processor>
            <processor match="/root/EGEE_USER/*/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry(local-name(),text()) "/></processor>

            <processor match="/root/EGEE_USER" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry('PRIMARY_KEY',@PRIMARY_KEY)"/><parameter name="destination_as">first_child</parameter></processor>

            <processor match="/root/EGEE_USER/USER_ROLE" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/root/EGEE_USER" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <processor match="/root" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>


            <processor match="/e:entries" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="view('OPSCORE_users_cic')"/><parameter name="destination_as">first_child</parameter></processor>
            <processor match="/e:entries/result" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="depth">1</parameter></processor>

            <processor match="/e:entries/row" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>

            <processor match="/e:entries/e:entries[*]" type="SelectGroupByProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="group_by" eval="e:entry[@key='CERTDN']/text()"/></processor>

            <processor match="/e:entries/e:entry[*]" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="new_attribute('PRIMARY_KEY',choose(e:entries/@PRIMARY_KEY, e:entries/@PRIMARY_KEY,choose(e:entries/e:entry[@key='PRIMARY_KEY']/text(),e:entries/e:entry[@key='PRIMARY_KEY']/text(), 'N.A.'))) |          new_attribute('EMAIL',choose(e:entries/e:entry[@key='EMAIL']/text(),e:entries/e:entry[@key='EMAIL']/text(),'ERROR')) | new_attribute('CN',choose(e:entries/e:entry[@key='CN']/text(),e:entries/e:entry[@key='CN']/text(),'ERROR'))"/></processor>


            <processor match="/e:entries/e:entry/e:entries[@PRIMARY_KEY]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="depth">1</parameter></processor>
            <processor match="/e:entries/e:entry/e:entry" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry/e:entries/e:entry[@key!='USER_ROLE' and  @key!='ON_ENTITY' and  @key!='ENTITY_TYPE' ]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>
            <processor match="/e:entries/e:entry[count(e:entries)=0]" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces></processor>

            <processor match="/*/*" type="SelectWindowProcessor">
                <parameter name="length">3</parameter>
            </processor>



            <processor match="/e:entries/e:entry" type="InsertProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="destination_as">first_child</parameter><parameter name="nodes" eval="new_element('e:entries', new_attribute('key', 'user') | eval('entry(local-name(), .)', @*) )"/></processor>
            <!-- check if lines are conssistent -->
            <processor match="/e:entries/e:entry/*[text()]" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="nodes" eval="entry(local-name(),text()) "/></processor>
            <processor match="/e:entries/e:entry/e:entry" type="InsertParentProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
            <!--<insert match="/e:entries/e:entry/e:entries[not(e:entry/@key='USER_ROLE')]" nodes="new_attribute('key','user')"/>-->
            <processor match="/e:entries/e:entry" type="RenameProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry></namespaces><parameter name="node_name">e:entries</parameter></processor>
        </processors>

       <!-- <cache type="FileCache">
            <trigger ignore-during="PT3H" type="DependencyRefreshedTrigger"><parameter name="views">
                    <entry>OPSCORE_users</entry>
                    <entry>OPSCORE_users_cic</entry>
                </parameter><parameter name="all">true</parameter></trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>-->

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="OPSCORE_get_roc_contacts" authenticators="local">

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('OPSCORE.gocdb.get_roc_contacts')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">3</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger ignore-during="PT3H" type="ViewCreatedTrigger"/>
        </cache>
    </view>


    <view name="UsersListforAPI" authenticators="local" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <connector type="XMLConnector">
            <parameter name="content" eval="view('VomsMembers_v2')"></parameter>
        </connector>

        <processors>
            <element in="vos">
                <element in="vo">
                    <attribute-create out="group_mgmt">'VOMS'</attribute-create>
                    <element-create-as-parent out="users">
                        <element in="user">
                            <element in="id"/>
                            <element in="emailAddress" out="email"/>
                            <element in="creationTime"/>
                            <element in="endTime"/>
                            <element-create>new_element('name',concat(../name/text(),' ',../surname/text()))</element-create>
                            <element-create if="../suspended/text() and ../suspended/text()='false' and ../aupAcceptanceRecords/object/valid/text()='true'">new_element('status','ACTIVE')</element-create>
                            <element-create if="../suspended/text() and not(../suspended/text()='false' and ../aupAcceptanceRecords/object/valid/text()='true')">new_element('status','SUSPENDED')</element-create>

                            <element in="certificates">
                                <element-ignore in="object">
                                    <element in="issuerString"/>
                                    <element in="subjectString"/>
                                    <element in="suspensionReason" if="../suspended/text()='true'"/>
                                </element-ignore>

                            </element>
                            <element in="fqans"/>

                            <element-ignore/>
                        </element>
                    </element-create-as-parent>
                </element>
            </element>

            <element in="vos">
                <element-create>view('CoManageVOs')/vos/*</element-create>
            </element>


            <element in="vos">
                <element in="vo" if="@group_mgmt='COMANAGE'">
                    <attribute-ignore in="coid"/>
                    <attribute-ignore in="description"/>
                            <element-create-as-parent out="users">
                                <element in="user">
                                    <attribute-ignore/>
                                    <element in="CN" out="name"></element>
                                    <element in="DN" out="id"></element>
                                    <element in="mail" out="email"></element>
                                    <element-ignore/>
                                    <element-create>new_element('status',new_text(../@status))</element-create>
                                </element>
                            </element-create-as-parent>
                </element>
            </element>

            <element in="vos">
                <element-create>view('VoPerunList')/vos/*</element-create>
            </element>

            <element in="vos">
                <element-create>view('VoPerunList')/vos/*</element-create>
            </element>

            <element in="vos">
                <element in="vo">
                    <element in="e:entries" out="exception" if="e:entry[@key='ERROR']/text()">
                        <element in="e:entry" if="@key='ERROR'" out="details"/>
                        <element-ignore/>
                        <text-create>'Impossible to reach VOMS server'</text-create>
                    </element>
                </element>
            </element>

            <element in="vos">
                <element in="vo">
                    <attribute-create out="count" if="not(../@count)">count(../users/user)</attribute-create>
                    <attribute in="count" if=".=''">0</attribute>
                </element>
            </element>


        </processors>


        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">2</parameter>
                <parameter name="minutes">12</parameter>
            </trigger>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>



</views>