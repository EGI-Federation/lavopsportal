<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="voms_vo">

        <connector type="XMLConnector"><parameter name="content" eval="view('vo-voms_INDEX')"/></connector>
        <processors>
            <processor match="/data/Vo/VoVomsServer/VoVomsServer/memberslisturl/text()" type="ReplaceProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces><parameter name="nodes" eval="str:replace(.,'/services/VOMSAdmin?method=listMembers','/apiv2/user-stats.action')"/></processor>
            <processor match="/data/Vo/@*" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>
            <processor match="/data/Vo/*[local-name()!='VoVomsServer' and local-name()!='name']" type="RemoveProcessor"><namespaces><entry key="e">http://software.in2p3.fr/lavoisier/entries.xsd</entry><entry key="str">http://exslt.org/strings</entry></namespaces></processor>



                 <element in="data">
                     <element in="Vo">
                         <element in="VoVomsServer">
                             <attribute-create out="registry" if="contains(../VoVomsServer/hostname,'perun')">'perun'</attribute-create>
                             <attribute-create out="registry" if="contains(../VoVomsServer/hostname,'aai.egi.eu')">'CoManage'</attribute-create>
                             <attribute-create out="registry" if="not(contains(../VoVomsServer/hostname,'perun')) and not(contains(../VoVomsServer/hostname,'aai.egi.eu'))">'VOMS'</attribute-create>

                         </element>
                     </element>
                 </element>
        </processors>



        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
        </cache>
    </view>

    <view name="Voms_Users_Connector">



        <argument name="voms_url"/>
        <argument name="vo"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$voms_url"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>

            <parameter name="connect-timeout">45</parameter>
            <parameter name="read-timeout">35</parameter>

            <parameter name="header">
                <entry key="Content-type">text/xml</entry>
                <entry key="X-VOMS-CSRF-GUARD">;</entry>
            </parameter>

            <fallback>
                <exception type="java.io.IOException"/>
                <exception type="java.net.NoRouteToHostException"/>
                <exception type="java.io.FileNotFoundException"/>
                <exception type="java.lang.Exception"/>
                <exception type="java.net.SocketTimeoutException"/>
                <exception type="java.net.UnknownHostException"/>
                <exception type="java.net.SocketException"/>
                <exception type="java.lang.NullPointerException"/>
            </fallback>
        </connector>
        <serializer type="EncapsulateSerializer"/>
        <processors>
            <processor match="//*" type="ChangeNamespaceProcessor"/>
            <processor match="/" type="InsertProcessor"><parameter name="nodes" eval="new_attribute('vo',$vo)"/></processor>
        </processors>

    </view>


    <view name="voms_users">



        <connector type="XMLConnector">
            <parameter name="content" eval="view('voms_vo')"/>
        </connector>

        <processors>
            <processor match="/data/Vo[VoVomsServer/VoVomsServer/memberslisturl and VoVomsServer/VoVomsServer/memberslisturl/text()!='']" type="InsertProcessor"><parameter name="nodes" eval="view('Voms_Users_Connector',entry('voms_url',match()/VoVomsServer/VoVomsServer/memberslisturl/text())|entry('vo',match()/name/text()))"/></processor>
        </processors>

        <cache type="IndexedFileCache">

            <parameter name="index_depth">1</parameter>
            <parameter name="xpath" eval="path(false())"/>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>voms_vo</entry>
                </parameter>
            </trigger>

        </cache>

        <pre-renderers>
            <title>"VOMS NEW API"</title>
            <row foreach="/data/Vo/object">
                <column label="vo">@vo</column>
                <column label="Users Nb" unit="nb">@usersCount</column>
                <column label="expired Users Nb" unit="nb">@expiredUsersCount</column>
                <column label="suspended Users Nb" unit="nb">@suspendedUsersCount</column>
            </row>
        </pre-renderers>

    </view>


</views>