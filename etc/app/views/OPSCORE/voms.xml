<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:str="http://exslt.org/strings" name="voms_vo">

        <connector type="XMLConnector"><parameter name="content" eval="view('vo-voms_INDEX')"/></connector>
        <processors>
            <element in="data">
                <element in="Vo">
                    <attribute-ignore/>
                        <element in="VoVomsServer">
                            <element in="VoVomsServer">
                                <element-create>new_element('memberslisturl_v2', new_text(str:replace(current()/../memberslisturl/text(),'/services/VOMSAdmin?method=listMembers','/apiv2/user-stats.action')))</element-create>
                            </element>
                        </element>
                        <element in="name"/>
                        <element-ignore/>
                </element>
            </element>

                 <element in="data">
                     <element in="Vo">
                         <element in="VoVomsServer">
                             <attribute-create out="registry" if="contains(../VoVomsServer/hostname,'perun')">'perun'</attribute-create>
                             <attribute-create out="registry" if="contains(../VoVomsServer/hostname,'aai.egi.eu')">'CoManage'</attribute-create>
                             <attribute-create out="registry" if="not(contains(../VoVomsServer/hostname,'perun')) and not(contains(../VoVomsServer/hostname,'aai.egi.eu'))">'VOMS'</attribute-create>

                         </element>
                     </element>
                 </element>
        </processors>



        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
        </cache>
    </view>

    <view name="VomsMembers_v2">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('voms_vo')"/>
        </connector>

        <processors>
            <element in="data" out="vos">
                <element in="Vo" out="vo">
                    <attribute-create out="name">../name/text()</attribute-create>
                    <attribute-create out="url">concat('https://',../VoVomsServer/VoVomsServer/hostname/text(),':',../VoVomsServer/VoVomsServer/@https_port,'/voms/',../name/text(),'/apiv2/users')</attribute-create>
                    <element-ignore/>
                </element>
            </element>

            <elements path="vos/vo">
                <element-create>view('Voms_Users_Connector_2',entry('voms_url',../@url)|entry('vo',../@name))</element-create>
            </elements>

            <elements path="vos/vo">
                <attribute-create out="count">../object/count/text()</attribute-create>

                <element-ignore in="result">
                    <element in="object" out="user"/>
                </element-ignore>

            </elements>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">8</parameter>
            </trigger>
        </cache>
    </view>

    <view name="VoUsers_v2">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('VomsMembers_v2')"/>
        </connector>

        <processors>
            <element in="vos">
                <element in="vo">
                    <element-ignore/>
                </element>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>VomsMembers_v2</entry>
                </parameter>
            </trigger>
        </cache>

    </view>

    <view name="Voms_Users_Connector">



        <argument name="voms_url"/>
        <argument name="vo"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$voms_url"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>

            <parameter name="connect-timeout">45</parameter>
            <parameter name="read-timeout">35</parameter>

            <parameter name="header">
                <entry key="Content-type">text/xml</entry>
                <entry key="X-VOMS-CSRF-GUARD">;</entry>
            </parameter>

            <fallback>
                <exception type="java.io.IOException"/>
                <exception type="java.net.NoRouteToHostException"/>
                <exception type="java.io.FileNotFoundException"/>
                <exception type="java.lang.Exception"/>
                <exception type="java.net.SocketTimeoutException"/>
                <exception type="java.net.UnknownHostException"/>
                <exception type="java.net.SocketException"/>
                <exception type="java.lang.NullPointerException"/>
            </fallback>
        </connector>
        <serializer type="EncapsulateSerializer"/>
        <processors>
            <processor match="//*" type="ChangeNamespaceProcessor"/>
            <processor match="/" type="InsertProcessor"><parameter name="nodes" eval="new_attribute('vo',$vo)"/></processor>
        </processors>

    </view>

    <view name="Voms_Users_Connector_2">

        <argument name="voms_url"/>
        <argument name="vo"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$voms_url"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>

            <parameter name="connect-timeout">45</parameter>
            <parameter name="read-timeout">35</parameter>

            <parameter name="header">
                <entry key="Content-type">text/json</entry>
                <entry key="X-VOMS-CSRF-GUARD">;</entry>
            </parameter>

            <fallback>
                <exception type="java.io.IOException"/>
                <exception type="java.net.NoRouteToHostException"/>
                <exception type="java.io.FileNotFoundException"/>
                <exception type="java.lang.Exception"/>
                <exception type="java.net.SocketTimeoutException"/>
                <exception type="java.net.UnknownHostException"/>
                <exception type="java.net.SocketException"/>
                <exception type="java.lang.NullPointerException"/>
            </fallback>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>


    <view name="voms_users">


        <connector type="XMLConnector">
            <parameter name="content" eval="view('voms_vo')"/>
        </connector>

        <processors>
            <processor match="/data/Vo[VoVomsServer/VoVomsServer/memberslisturl_v2 and VoVomsServer/VoVomsServer/memberslisturl_v2/text()!='']" type="InsertProcessor">
                <parameter name="nodes" eval="view('Voms_Users_Connector',entry('voms_url',match()/VoVomsServer/VoVomsServer/memberslisturl_v2/text())|entry('vo',match()/name/text()))"/>
            </processor>
        </processors>

        <cache type="IndexedFileCache">

            <parameter name="index_depth">1</parameter>
            <parameter name="xpath" eval="path(false())"/>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DependencyRefreshedTrigger">
                <parameter name="views">
                    <entry>voms_vo</entry>
                </parameter>
            </trigger>

        </cache>

        <pre-renderers>
            <title>"VOMS NEW API"</title>
            <row foreach="/data/Vo/object">
                <column label="vo">@vo</column>
                <column label="Users Nb" unit="nb">@usersCount</column>
                <column label="expired Users Nb" unit="nb">@expiredUsersCount</column>
                <column label="suspended Users Nb" unit="nb">@suspendedUsersCount</column>
            </row>
        </pre-renderers>

    </view>


</views>