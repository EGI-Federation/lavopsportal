<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : lavopsportal 
        File    : accounting-metrics.xml
        Created by cyril on 2022/02/17 
    -->

<!--    https://accounting.devel.argo.grnet.gr/swagger-ui/-->


    <view name="getAccessToken" authenticators="admin">
        <variable name="client-id" eval="property('acc-client-id')"></variable>
        <variable name="acc-refresh_token" eval="property('acc-refresh_token')"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('acc-client-id'),':',property('acc-client-pwd'),'@',property('acc-url'))"/>
            <parameter name="header">
                <entry key="Content-Type">application/x-www-form-urlencoded</entry>

            </parameter>
            <parameter name="post" eval="concat('client_id=',$client-id,'&amp;grant_type=refresh_token&amp;refresh_token=',$acc-refresh_token,'&amp;scope=openid%20email%20profile%20voperson_id%20eduperson_entitlement')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="seconds">120</parameter>
            </trigger>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="listPermissions">
<!--        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>-->
        <variable name="access_token">eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ2LUQwenB3YTF5MlhjYlVmQTNXVWdrOUFXSUJUREVyYllXOXdlRFphUUE4In0.eyJleHAiOjE2NzE1NDc1MDMsImlhdCI6MTY3MTU0MzkwMywiYXV0aF90aW1lIjoxNjcxNTQyMjA1LCJqdGkiOiJkMDhmOTNlOS0wZDAwLTRmODUtYjQ4NC1jODQxNjEwNDY4YTQiLCJpc3MiOiJodHRwczovL2FhaS1kZW1vLmVvc2MtcG9ydGFsLmV1L2F1dGgvcmVhbG1zL2NvcmUiLCJzdWIiOiI0NmQ5OTc3NzI2ZTU5ZjkzYmJkMzhlMTBiMmMwOGZhOGY3ZjJiNTQxZWYxYzY2YmFiMjc3OTYwZTFmODU2NGY0QGVnaS5ldSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImUyYjQ0ZDY3LTE3NGMtNDAxYy05Y2FmLTJiZDUzYTRlMDU1YSIsIm5vbmNlIjoiNzc0MTY1NDY2MDIyYTdhYjQyODliNzcwMTIzZWExNjkiLCJzZXNzaW9uX3N0YXRlIjoiODkzNDZmOGMtMmViNy00YTQ0LWI1MTYtOTE2MWViYzhhMmIwIiwic2NvcGUiOiJvcGVuaWQgZWR1cGVyc29uX2VudGl0bGVtZW50IHZvcGVyc29uX2lkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiI4OTM0NmY4Yy0yZWI3LTRhNDQtYjUxNi05MTYxZWJjOGEyYjAiLCJ2b3BlcnNvbl9pZCI6IjQ2ZDk5Nzc3MjZlNTlmOTNiYmQzOGUxMGIyYzA4ZmE4ZjdmMmI1NDFlZjFjNjZiYWIyNzc5NjBlMWY4NTY0ZjRAZWdpLmV1In0.GOw4YvkOdKi_UcOFxOLeoowZvC4-IkP_JrtgfM3ubBu0Dpi6O12AJ7fTd6IXq5XfBxAq1jC9DyczfiLTl5oaHdVHG7rOjgW-l822Bl7BT_r8w7obuwrN12DQSzYKpvM4J4GlucPIAXzSdVd23JGWoSMMhAFZ71qHL1MH7d4EbPt_sDRXJoZ0_rj8Rlg2xcLBDo4FBIvzQNjBkPbqRvG4KqVnMG5rOel8uzYZ57Npx_kbbo46fg6WToQiWaOl-WoET6N9AnBPGzFqw8K_ZzVRLMSEy_EMyuO6LdEIh5XUqp1ehgf_gBuR2fP7U1_EwZcgQs3My8cZEqkRoW6NdSCH8A</variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/clients/me</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>


        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                        <element in="object" out="e:entries">
                            <attribute-create out="key">../acronym/text()</attribute-create>
                            <element-ignore if="name()!='permissions' and name()!='providers'">
                                <element-create if="../text()">entry(name(..),../text())</element-create>
                            </element-ignore>

                            <element in="permissions" out="e:entries">
                                <attribute-create out="key">'permissions'</attribute-create>
                                <element in="object" out="e:entries">
                                    <attribute-create out="key">../collection/text()</attribute-create>
                                    <elements-ignore path="access_permissions/object">
                                       <element-create>entry(../operation/text(),../access_type/text())</element-create>
                                    </elements-ignore>
                                    <element-ignore/>
                                </element>
                            </element>

                            <element in="providers" out="e:entries">
                                <attribute-create out="key">'providers'</attribute-create>

                                <element in="object" out="e:entries">
                                    <attribute-create out="key">../id/text()</attribute-create>

                                    <element-ignore if="name()!='permissions' and name()!='installations'">
                                        <element-create if="../text()">entry(name(..),../text())</element-create>
                                    </element-ignore>

                                    <element in="installations" out="e:entries">
                                        <attribute-create out="key">'installations'</attribute-create>


                                            <element in="object" out="e:entries">
                                                <attribute-create out="key">../id/text()</attribute-create>
                                                <element-ignore if="name()!='permissions'">
                                                    <element-create if="../text()">entry(name(..),../text())</element-create>
                                                </element-ignore>
                                                <element in="permissions" out="e:entries">
                                                    <attribute-create out="key">'permissions'</attribute-create>
                                                <element in="object" out="e:entries">
                                                    <attribute-create out="key">../collection/text()</attribute-create>
                                                    <elements-ignore path="access_permissions/object">
                                                        <element-create>entry(../operation/text(),../access_type/text())</element-create>
                                                    </elements-ignore>
                                                    <element-ignore/>
                                                </element>
                                            </element>

                                            </element>


                                    </element>

                                    <element in="permissions" out="e:entries">
                                        <attribute-create out="key">'permissions'</attribute-create>
                                        <element in="object" out="e:entries">
                                            <attribute-create out="key">../collection/text()</attribute-create>
                                            <elements-ignore path="access_permissions/object">
                                                <element-create>entry(../operation/text(),../access_type/text())</element-create>
                                            </elements-ignore>
                                            <element-ignore/>
                                        </element>
                                    </element>
                                </element>





                            </element>
                        </element>
                </element-ignore>
                <element-ignore/>
            </element>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

<view name="projectDetails">
    <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

    <connector type="HTTPConnector">
        <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/projects/101017452</parameter>
        <parameter name="method">GET</parameter>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
            <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

        </parameter>
    </connector>
    <serializer type="JSONStreamSerializer"/>
    <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="contentType">text/xml</parameter>
        </renderer>
    </renderers>
</view>

    <view name="listInstallationsOrdered">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('listInstallations')"/>
        </connector>

        <processors>

            <element in="e:entries">
                <set variable="project" index="e:entry[@key='id']/text()">view('listProjects')/e:entries/e:entries</set>
                <element in="e:entries">
                    <element-create if="find($project,current()/../e:entry[@key='project']/text())">entry('projectName',find($project,current()/../e:entry[@key='project']/text())/e:entry[@key='acronym']/text())</element-create>
                    <element-create if="not(find($project,current()/../e:entry[@key='project']/text()))">entry('projectName','unknown')</element-create>
                </element>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="sort">concat('Project : ',../e:entry[@key='projectName'],'  ***  Provider : ',../e:entry[@key='organisation'])</attribute-create>
                </element>
                <element-ignore/>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,'@sort')</element-create>

            </element>

            <element in="e:entries">
              <element-create-as-parent out="e:entries" group-by="@sort" attributes="@sort">
                      <element in="e:entries"/>
              </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute in="sort" out="key"/>
                    <element in="e:entries">
                        <attribute-ignore in="sort"/>
                    </element>
                </element>
            </element>


        </processors>


            <cache type="FileCache">
                <trigger type="DependencyRefreshedTrigger">
                    <parameter name="views">
                        <entry>listInstallations</entry>
                    </parameter>
                </trigger>
            </cache>
    </view>


    <view name="listInstallations">

    <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
    <connector type="HTTPConnector">
        <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/installations/all</parameter>
        <parameter name="method">GET</parameter>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
            <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

        </parameter>
    </connector>
    <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore if="name()!='unit_of_access'">
                            <element-create>entry(name(..),../text())</element-create>
                        </element-ignore>
                        <element in="unit_of_access" out="e:entries">
                            <attribute-create out="key">'metrics'</attribute-create>
                            <element-ignore>
                                <element-create>entry(name(..),../text())</element-create>
                            </element-ignore>
                        </element>
                    </element>

                </element-ignore>

            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">3</parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="listProjects">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/projects</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object"  out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <element-ignore if="name()!='providers'">
                            <element-create>entry(name(..),../text())</element-create>
                        </element-ignore>
                        <element-ignore in="providers">
                            <element in="object"  out="e:entries">
                                <element-ignore  if="name()!='installations'">
                                    <element-create>entry(name(..),../text())</element-create>
                                </element-ignore>
                                <element-ignore in="installations">
                                    <element in="object"  out="e:entries">
                                        <element-ignore>
                                            <element-create>entry(name(..),../text())</element-create>
                                        </element-ignore>
                                    </element>
                                </element-ignore>
                            </element>
                        </element-ignore>

                    </element>

                </element-ignore>
                <element-ignore/>
            </element>


            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="key">../e:entry[@key='id']</attribute-create>
                    <element in="e:entries">
                        <attribute-create out="key">../e:entry[@key='id']</attribute-create>
                            <element in="e:entries">
                                <attribute-create out="key">../e:entry[@key='id']</attribute-create>
                            </element>
                    </element>
                </element>

            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">10</parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="testLogo"  xmlns:java="http://software.in2p3.fr/lavoisier/java">
        <argument name="url">https://operations-portal.egi.eu/buid/images/egi_logo.png</argument>
        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="read-timeout">5</parameter>
            <parameter name="connect-timeout">5</parameter>
            <fallback eval="new_element('error','image not found')">
                <exception type="java.net.UnknownHostException"/>
                <exception type="java.io.IOException"/>
                <exception type=" java.lang.RuntimeException"/>
            </fallback>
        </connector>
        <serializer type="EncapsulateSerializer"/>


        <processors>
            <element in="e:entries">
                <element-ignore in="e:entry">
                        <text-create>../text()</text-create>
                    <text-ignore/>
                </element-ignore>
            </element>
        </processors>
    </view>

    <view name="listProvidersRaw">

        <argument name="page">1</argument>
        <argument name="size">100</argument>
    <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
    <connector type="HTTPConnector">
        <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/providers?size=',$size,'&amp;page=',$page)"/>
        <parameter name="method">GET</parameter>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
            <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
        </parameter>
    </connector>
    <serializer type="JSONStreamSerializer"/>
    </view>

    <view name="listProviders">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('listProvidersRaw')"></parameter>
        </connector>

        <processors>
            <element in="object">
                <element-create>view('listProvidersRaw',entry('page','2'))/object/*</element-create>
            </element>
            <element in="object"  out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>entry(name(..),../text())</element-create>
                        </element-ignore>

                    </element>

                </element-ignore>
                <element-ignore/>
            </element>



            <element in="e:entries">
                <element in="e:entries">
                    <element in="e:entry" if="@key='logo'">
                        <text if="view('testLogo',entry('url',.))/error/text()">'Not found'</text>
                    </element>
                </element>
            </element>

        </processors>

        <cache type="FileCache">

            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">6</parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="listroles">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/roles</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="registerClient">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/clients</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="listClients">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/clients</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="publishProject">
        <argument name="id">5564</argument>
        <argument name="acronym">EOSC API</argument>
        <argument name="title">EOSC API project</argument>
        <argument name="start_date">2021-01-01</argument>
        <argument name="end_date">2023-12-31</argument>
        <argument name="call_identifier">2020-EINFRA-2022</argument>

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/projects/',$id)"/>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('id'), ': ',quot($id),','
            , quot('acronym'), ': ',quot($acronym),','
              , quot('title'), ': ',quot($title),','
            , quot('start_date'), ': ',quot($start_date),','
             , quot('end_date'), ': ',quot($end_date),','
            , quot('call_identifier'), ': ',quot($call_identifier)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="addInstallation">

        <argument name="project">888743</argument>
        <argument name="infrastructure">wok</argument>
        <argument name="organisation">umg-br</argument>
        <argument name="installation">temporary_installation</argument>
        <argument name="unit_of_access">63562ce6a6b3c27f486bdea3</argument>

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/installations</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('project'), ': ',quot($project),','
            , quot('organisation'), ': ',quot($organisation),','
              , quot('infrastructure'), ': ',quot($infrastructure),','
            , quot('installation'), ': ',quot($installation),','
            , quot('unit_of_access'), ': ',quot($unit_of_access)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="deleteInstallation">
        <argument name="installation_id">63562d71a6b3c27f486bdea6</argument>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/installations/',$installation_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>


        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="publishProvider">
        <argument name="id"></argument>
        <argument name="name">provider_name</argument>
        <argument name="website">website</argument>
        <argument name="abbreviation">abbr</argument>
        <argument name="logo">https://eosc-portal.wip/build/images/logo_opsportal_short.png</argument>

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/providers</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('id'), ': ',quot($id),','
            , quot('name'), ': ',quot($name),','
              , quot('website'), ': ',quot($website),','
            , quot('abbreviation'), ': ',quot($abbreviation),','
            , quot('logo'), ': ',quot($logo)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="deleteProvider">
        <argument name="provider_id">provider_id</argument>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/providers/',$provider_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
            <fallback eval="new_element('code','409')|new_element('message','The provider cannot be deleted. There is a Metric assigned to it.')">
                <exception type="java.io.IOException" />
            </fallback>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="associatesProvider">
        <argument name="project">888743</argument>
        <argument name="provider">scai</argument>

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/projects/',$project,'/associate')"/>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat('{',quot('providers'),':[',quot($provider),']}')"/>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="dissociatesProvider">
        <argument name="project">888743</argument>
        <argument name="provider">iict</argument>

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/projects/',$project,'/dissociate')"/>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat('{',quot('providers'),':[',quot($provider),']}')"/>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="publishMetricDefinition">
        <argument name="metric_name">metric_test_api122</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>

       <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('metric_name'), ': ',quot($metric_name),','
            , quot('metric_description'), ': ',quot($metric_description),','
            , quot('metric_type'), ': ',quot($metric_type),','
            , quot('unit_type'), ': ',quot($unit_type)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>




    <view name="patchMetricDefinition" xmlns:java="http://software.in2p3.fr/lavoisier/java">
        <argument name="metric_id">6213a0b6fbedc07f931b436a</argument>
        <argument name="metric_name">nb_eosc_services_test_core</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>
        <variable name="post" eval="concat('{'
            , quot('metric_name'), ':',quot($metric_name),','
            , quot('metric_description'), ':',quot($metric_description),','
            , quot('metric_type'), ':',quot($metric_type),','
            , quot('unit_type'), ':',quot($unit_type)
            ,'}')"/>

       <variable name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions/',$metric_id)"/>
        <variable name="access_token" eval="concat('Authorization:Bearer',view('getAccessToken')/object/access_token/text())"></variable>


        <connector type="ShellConnector">
            <parameter name="executable">/bin/sh </parameter>
            <parameter name="arguments">
                <entry eval="concat(property('shell.dir'),'curlApi.sh')"/>
                <entry eval="$url"/>
                <entry eval="$access_token"/>
                <entry eval="$post"/>
            </parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="deleteMetricDefinition">
        <argument name="metric_id">62165480fbedc07f931b436e</argument>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions/',$metric_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
            <fallback eval="new_element('code','409')|new_element('message','The Metric Definition cannot be deleted. There is a Metric assigned to it.')">
                <exception type="java.io.IOException" />
            </fallback>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="listMetricDefinition">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                <element in="object" out="e:entries">
                    <attribute-create out="key">../metric_definition_id/text()</attribute-create>
                    <element-ignore>
                        <element-create>
                            entry(local-name(current()/..),current()/../text())
                        </element-create>
                    </element-ignore>
                </element>
                </element-ignore>

            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">3</parameter>
            </trigger>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="listMetricType">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions/metric-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                   <element in="object" out="e:entries">
                       <attribute-create out="key">../metric_type/text()</attribute-create>
                       <element-ignore></element-ignore>
                   </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">4</parameter>
            </trigger>
        </cache>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>

    <view name="listMetricsDetails"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="projectId">888743</argument>
        <argument name="provider">0</argument>
        <argument name="installation">0</argument>
        <argument name="details"></argument>
        <argument name="start">0</argument>
        <argument name="end">0</argument>

        <variable name="url_end" eval="choose($details=2,
        concat('projects/',$projectId,'/providers/',$provider,'/metrics?size=100'),
        choose($details=1,
                concat('projects/',$projectId,'/metrics?size=100'),
                concat('installations/',$installation,'/metrics?size=100')))"/>

        <variable name="url" eval="choose($start!=0 and $end!=0,concat('https://accounting.devel.argo.grnet.gr/accounting-system/',$url_end,'&amp;start=',$start,'&amp;end=',$end),concat('https://accounting.devel.argo.grnet.gr/accounting-system/',$url_end))"/>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>
            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <attribute-create out="url">$url</attribute-create>
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>

                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element in="e:entries"/>
                <element-ignore/>
            </element>

            <element in="e:entries">
                <set variable="definition" index="@key">view('listMetricDefinition')/e:entries/e:entries</set>
                <element in="e:entries">
                    <element-create>find($definition,../e:entry[@key='metric_definition_id']/text())/*</element-create>
                    <element-ignore in="e:entry" if="@key='metric_definition_id'"/>
                </element>

            </element>

        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="listMetricsbyProject"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="projectId">101017452</argument>

        <variable name="url" eval="concat('https://accounting.devel.argo.grnet.gr/accounting-system/projects/',$projectId,'/metrics?size=100')"/>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>

                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element in="e:entries"/>
                <element-ignore/>
            </element>

            <element in="e:entries">
                <set variable="definition" index="@key">view('listMetricDefinition')/e:entries/e:entries</set>
                <element in="e:entries">
                    <element-create>find($definition,../e:entry[@key='metric_definition_id']/text())/*</element-create>
                    <element-ignore in="e:entry" if="@key='metric_definition_id'"/>
                </element>

            </element>

        </processors>
        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="listUnits">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://accounting.devel.argo.grnet.gr/accounting-system/metric-definitions/unit-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../symbol/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>
                    </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">5</parameter>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>




</views>