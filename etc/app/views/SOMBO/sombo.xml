<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >

    <view name="spmt.services">
        <connector type="HTTPConnector">
            <parameter name="url">https://eosc-hub-devel.agora.grnet.gr/api/v2/services/</parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <cache type="FileCache">
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">8</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>

    </view>

    <view name="marketplace.providers" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('marketplace.api')"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>

            <fallback eval="view('marketplace.providers.file')">
                <exception type="java.io.IOException"/>
            </fallback>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
        <element in="item" out="e:entries">
            <element in="object" out="e:entries">
                <attribute-create out="key">../SITENAME-SERVICEGROUP/text()</attribute-create>
                <element in="URL" out="e:entry"><attribute-create out="key">'url'</attribute-create></element>
                <element in="CONTACT_EMAIL" out="e:entry">
                    <attribute-create out="key">'email'</attribute-create>
                    <text-create>join(../item/text(),',')</text-create>
                    <element-ignore/>
                </element>
                <element-ignore/>
            </element>

        </element>
    </processors>
    </view>
    <view name="marketplace.providers.file" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="FileConnector">
            <parameter name="path">app/resources/json/services.json</parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>
        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="key">../SITENAME-SERVICEGROUP/text()</attribute-create>
                    <element in="URL" out="e:entry"><attribute-create out="key">'url'</attribute-create></element>
                    <element in="CONTACT_EMAIL" out="e:entry">
                        <attribute-create out="key">'email'</attribute-create>
                        <text-create>join(../item/text(),',')</text-create>
                       <element-ignore/>
                    </element>
                    <element-ignore/>
                </element>

            </element>
        </processors>
    </view>

    <view name="dpmt.providers" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="HTTPConnector">
            <parameter name="url">http://dp-api.eudat.eu/providers</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Accept">application/json</entry>
                <entry key="Authorization" eval="property('authentication.dpmt')"/>
            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <element-ignore in="items">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../title/text()</attribute-create>
                        <element in="description" out="e:entry">
                            <attribute-create out="key">'description'</attribute-create>
                        </element>
                        <element in="title" out="e:entry">
                            <attribute-create out="key">'NAME'</attribute-create>
                        </element>
                        <element in="review_state" out="e:entry">
                            <attribute-create out="key">'status'</attribute-create>
                        </element>
                        <element-create>entry('CONTACT_EMAIL','eudat@eudat.org')</element-create>
                        <element-ignore/>
                    </element>
                    <element-ignore/>
                </element-ignore>
                <element-ignore/>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries"/>
                <element-create>sort_by_string(../e:entries,"e:entry[@key='NAME']")</element-create>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',22,14)"/>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>




    <view name="JiraComment" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="ticketId">EOSCSO-2</argument>

        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/issue/',$ticketId,'/comment')"/>


        </connector>


        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <attribute-create out="key">'comments'</attribute-create>

                <element-ignore in="comments" >
                    <element-create>entry('NbComments',count(../object))</element-create>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../created/text()</attribute-create>
                        <element-ignore in="author">
                            <element in="displayName" out="e:entry">
                                <attribute-create out="key">'author'</attribute-create>
                            </element>

                        </element-ignore>
                        <element in="created" out="e:entry">
                            <attribute-create out="key">'date'</attribute-create>
                        </element>
                        <element in="body" out="e:entry">
                            <attribute-create out="key">'body'</attribute-create>
                        </element>

                        <element-ignore/>
                    </element>
                </element-ignore>
                <element-ignore/>

            </element>

        </processors>

    </view>

    <view name="JiraServiceProviders" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="HTTPConnector">
            <parameter name="url"     eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/search?fields=assignee,status,created,updated,customfield_10507,customfield_11600,customfield_10509&amp;jql=project=',quot(property('jira.sp')),'&amp;maxResults=1000')"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object" out="e:entries">

                <element-ignore in="issues">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../key/text()</attribute-create>

                        <element-ignore in="fields">

                            <element in="created" out="e:entry">
                                <attribute-create out="key">'created'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>

                            <element in="updated" out="e:entry">
                                <attribute-create out="key">'updated'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>


                            <element in="assignee" out="e:entry">
                                <attribute-create out="key">'assignee'</attribute-create>
                                <element-ignore in="displayName"><text/></element-ignore>
                                <element-ignore/>
                                <text if=".='null'">'Unassigned'</text>
                            </element>



                        <element in="customfield_10507" out="e:entry">
                            <attribute-create out="key">'organisation'</attribute-create>
                        </element>

                        <element in="customfield_11600" out="e:entry">
                            <attribute-create out="key">'marketplace_url'</attribute-create>
                        </element>

                            <element in="customfield_10509" out="e:entry">
                                <attribute-create out="key">'service_name'</attribute-create>
                            </element>



                        <element-ignore in="status">
                            <element in="name" out="e:entry">
                                <attribute-create out="key">'status'</attribute-create>
                            </element>

                        </element-ignore>

                            <element-ignore/>
                        </element-ignore>
                        <element-ignore/>
                </element>
                </element-ignore>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,3)"/>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="JiraUsers" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="HTTPConnector">
            <parameter name="url"               eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/user/assignable/search?project=',property('jira.project'))" />
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="item" out="e:entries">
                <element-ignore>
                    <element in="name" out="e:entry">
                        <attribute-create out="key">../../displayName/text()</attribute-create>
                    </element>

                </element-ignore>

            </element>
        </processors>
        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,3)"/>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>
    


    <view name="JiraSOList" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="HTTPConnector">
            <parameter name="url"      eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/search?fields=assignee,status,created,updated,customfield_10711,customfield_10223,customfield_10100,customfield_10254,customfield_10900&amp;jql=project=',quot(property('jira.project')),' AND issuetype=',quot('Service Order'),'&amp;maxResults=1000')"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>

            <element in="object" out="e:entries">
                <element-ignore in="issues">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../key/text()</attribute-create>


                        <element-ignore in="fields">



                            <element in="created" out="e:entry">
                                <attribute-create out="key">'created'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>

                            <element in="updated" out="e:entry">
                                <attribute-create out="key">'updated'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>


                            <element in="assignee" out="e:entry">
                                <attribute-create out="key">'assignee'</attribute-create>
                                <element-ignore in="displayName"><text/></element-ignore>
                                <element-ignore/>
                                <text if=".='null'">'Unassigned'</text>
                            </element>

                            <element in="customfield_10711" out="e:entry">
                                <attribute-create out="key">'SO-1'</attribute-create>
                            </element>

                            <element in="customfield_10900" out="e:entry">
                                <attribute-create out="key">'SO-ServiceOrderTarget'</attribute-create>
                            </element>

                            <element in="customfield_10100" out="e:entry">
                                <attribute-create out="key">'EpicLink'</attribute-create>
                            </element>

                            <element in="customfield_10254" out="e:entry">
                                <attribute-create out="key">'Order Reference'</attribute-create>
                            </element>

                            <element in="customfield_10223" out="e:entry">
                                <attribute-create out="key">'AoDs Request status'</attribute-create>
                                <element-ignore in="value"><text></text></element-ignore>
                                <element-ignore/>
                            </element>



                            <element-ignore in="status">
                                <element in="name" out="e:entry">
                                    <attribute-create out="key">'status'</attribute-create>
                                </element>
                            </element-ignore>

                            <element-ignore/>
                        </element-ignore>
                        <element-ignore/>
                    </element>
                </element-ignore>
            </element>

            <element in="e:entries">
                <set variable="JiraEpicList" index="@key">view('JiraEpicList')/e:entries/e:entries</set>
                <element in="e:entries">
                    <element-create>find($JiraEpicList,../e:entry[@key='EpicLink']/text())/*</element-create>
                </element>
            </element>

            <element in="e:entries">
                <element-ignore/>
                <element-create>sort_by_string(../e:entries,'e:entry[@key="status"]/text()')</element-create>
            </element>

            <element in="e:entries">
                <element-create-as-parent out="e:entries" attributes="new_attribute('key',e:entry[@key='status']/text())" group-by="e:entry[@key='status']/text()">
                    <element in="e:entries"/>
                </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="count">count(../e:entries)</attribute-create>
                    <element in="e:entries">
                        <element-create>entry('id',../@key)</element-create>
                    </element>
                </element>
            </element>

            <element in="e:entries">
                <element-ignore in="e:entries" if="@key='New'"/>
                <element-create as="first-child">../e:entries[@key='New']</element-create>
            </element>


        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,3)"/>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="JiraEpicNotReferenced" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="XMLConnector">
            <parameter name="content" eval="view('JiraEpicList')"/>
        </connector>

        <processors>
            <element in="e:entries">
                <set variable="JiraSOList">view('JiraSOList')</set>
                <attribute-create out="nbEntries">count(../e:entries)</attribute-create>
                <element in="e:entries" if="not(@key=$JiraSOList/e:entries/e:entries/e:entries/e:entry[@key='EpicLink']/text())"/>
                <element-ignore/>
            </element>

            <element in="e:entries">
                <attribute-create out="nbEntriesOrphan">count(../e:entries)</attribute-create>
            </element>


        </processors>
    </view>

    <view name="JiraEpicList" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >
        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/search?fields=created,updated,customfield_10228,summary,status,customfield_10228,customfield_1010&amp;jql=project=',quot(property('jira.project')),' AND issuetype=',quot('epic'),'&amp;maxResults=1000')"/>

        </connector>
        <serializer type="JSONStreamSerializer"/>

        <processors>

            <element in="object" out="e:entries">
                <element-ignore in="issues">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../key/text()</attribute-create>
                        <element-ignore in="fields">

                            <element in="summary" out="e:entry">
                                <attribute-create out="key">'Project Summary'</attribute-create>
                            </element>



                            <element in="created" out="e:entry">
                                <attribute-create out="key">'created'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>

                            <element in="updated" out="e:entry">
                                <attribute-create out="key">'updated'</attribute-create>
                                <text>substring(.,0,17)</text>
                            </element>

                            <element in="customfield_10228" out="e:entry">
                                <attribute-create out="key">'CI-DisplayName'</attribute-create>
                            </element>

                            <element-ignore in="status">
                                <element in="name" out="e:entry">
                                    <attribute-create out="key">'Project status'</attribute-create>
                                </element>
                            </element-ignore>

                            <element-ignore/>

                        </element-ignore>
                        <element-ignore/>
                    </element>
                </element-ignore>
            </element>

        </processors>



    </view>


    <view name="JiraTicketList2" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:date="http://exslt.org/dates-and-times">

        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/search?fields=customfield_10705,summary,status,customfield_10228,customfield_1010&amp;jql=project=',quot('EOSCSO'),' AND issuetype=',quot('epic'))"/>

        </connector>

        <serializer type="JSONStreamSerializer"/>

        <processors>

            <element in="object" out="e:entries">
                <element-ignore in="issues">
                    <element in="object" out="e:entries">

                    <element-ignore in="fields">

                                <element in="customfield_10705" out="e:entry">
                                    <attribute-create out="key">'ProjectName'</attribute-create>
                                </element>

                                <element-ignore in="status">
                                    <element in="name" out="e:entry">
                                        <attribute-create out="key">'status'</attribute-create>
                                    </element>
                                </element-ignore>

                        </element-ignore>
                    </element>
                </element-ignore>


            </element>


        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes"  eval="choose(property('env')='test',12,7)"/>
            </trigger>
        </cache>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>

    </view>


    <view name="jiraDisciplines" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <connector type="XMLConnector">
            <parameter name="content" eval="view('VoDisciplinesTree_Raw')"/>
        </connector>
        <processors>

            <element in="disciplines" out="e:entries">
                <element-ignore in="discipline">
                    <element in="discipline" out="e:entry">
                        <attribute in="value" out="key"/>
                        <attribute-ignore/>
                        <text-create>../@value</text-create>
                        <element-ignore/>

                    </element>
                </element-ignore>

            </element>

        </processors>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="contentType">text/xml</parameter>
            </renderer>
        </renderers>
    </view>



    <view name="dpmt_push"  xmlns:java="http://software.in2p3.fr/lavoisier/java" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <argument name="so"/>
        <argument name="key"/>
        <variable name="message" eval="java:encodeToString(java:java.util.Base64.getEncoder(), java:getBytes($so))"/>


        <connector type="HTTPConnector">

            <parameter name="url"
                       eval="concat('https://messaging-devel.argo.grnet.gr/v1/projects/ARGOTEST/topics/dpmt_test:publish?key=',property('ams.key'))"/>
            <parameter name="force-redirect">true</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>

            <parameter name="post" eval="concat('{', quot('messages'), ': [ {',quot('attributes'),': {',quot('key'),' : ',quot($key) , '},', quot('data'), ' : ',quot($message),'}]}')"/>

        </connector>
    <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <element in="messageIds" out="e:entry">
                    <attribute-create out="key">'message'</attribute-create>
                    <text-create>concat('Notification Item#', ../item/text(), ' successfully created')</text-create>
                    <element-ignore/>
                </element>
            </element>
        </processors>
</view>


<view name="dpmt_pull">
<connector type="HTTPConnector">
    <parameter name="url"
               eval="concat('https://messaging-devel.argo.grnet.gr/v1/projects/ARGOTEST/subscriptions/dpmt_test_sub:pull?key=',property('ams.key'))"/>
    <parameter name="force-redirect">true</parameter>
    <parameter name="method">POST</parameter>
    <parameter name="header">
        <entry key="Content-Type">application/json</entry>
    </parameter>
    <parameter name="post">{ "maxMessages": "10" }</parameter>

</connector>
<serializer type="JSONStreamSerializer"></serializer>
</view>


        </views>

