<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : lavopsportal 
        File    : accounting-metrics.xml
        Created by cyril on 2022/02/17 
    -->
    <view name="getAccessToken" authenticators="admin">
        <variable name="client-id" eval="property('acc-client-id')"></variable>
        <variable name="client-secret" eval="property('acc-client-secret')"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('acc-url')"/>
            <parameter name="header">
                <entry key="Content-Type">application/x-www-form-urlencoded</entry>
            </parameter>
            <parameter name="post" eval="concat('client_id=',$client-id,'&amp;client_secret=',$client-secret,'&amp;grant_type=client_credentials')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="seconds">250</parameter>
            </trigger>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

    <view name="getAAIToken" authenticators="admin">
        <variable name="client-id" eval="property('opsportal-aai-id')"></variable>
        <variable name="client-secret" eval="property('opsportal-aai-secret')"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('opsportal-aai-endpoint')"/>
            <parameter name="header">
                <entry key="Content-Type">application/x-www-form-urlencoded</entry>
            </parameter>
            <parameter name="post" eval="concat('client_id=',$client-id,'&amp;scope=openid%20email%20profile')"/>
        </connector>

        <serializer type="EncapsulateSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="seconds">250</parameter>
            </trigger>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>


    <view name="loginAAI" authenticators="aai">

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"/>
        </connector>

        <processors>
            <element in="root">
                <element-create>entry('token',user('token'))</element-create>
                <element-create>view('userInfo', entry('token',user('token')))</element-create>
            </element>

        </processors>

        <renderers>
            <renderer type="HTMLRenderer">
                <parameter name="template">app/html/profile.html</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="userInfo">
        <argument name="token"/>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('egi.oidc.userInfo'),$token)"/>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
        </connector>
        <serializer type="JSONStreamSerializer"/>
    </view>

    <view name="listProjects">

        <variable name="access_token">eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJiRy1TUERFRU9hempOQzVDY0hQZ3k3Q2lzVmlhQ1AzeXpmemh3b0RIcnV3In0.eyJleHAiOjE2NTgzMjgwNzAsImlhdCI6MTY1ODMyNDQ3MCwianRpIjoiMmRhYzdjNzktOTczMy00MzFhLWE2MDktM2JkOGE0ZDlmYjFjIiwiaXNzIjoiaHR0cHM6Ly9sb2dpbi1kZXZlbC5laW5mcmEuZ3JuZXQuZ3IvYXV0aC9yZWFsbXMvZWluZnJhIiwic3ViIjoiZGNiOGFhZTUtZDFhNi00NGNhLTg4MzgtMzIxYzdhYWZhZmRkIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiZW9zYy1vcGVyYXRpb25zLXBvcnRhbCIsImFjciI6IjEiLCJzY29wZSI6ImFhcmMgdm9wZXJzb25faWQgYWNjb3VudGluZy1zeXN0ZW0iLCJ2b3BlcnNvbl9pZCI6ImVvc2Mtb3BlcmF0aW9ucy1wb3J0YWxAZWluZnJhLmdybmV0LmdyIiwiY2xpZW50SWQiOiJlb3NjLW9wZXJhdGlvbnMtcG9ydGFsIiwiY2xpZW50SG9zdCI6IjEzNC4xNTguMjMxLjI4Iiwicm9sZXMiOlsibWV0cmljX2luc3BlY3RvciIsIm1ldHJpY19kZWZpbml0aW9uX2luc3BlY3RvciJdLCJjbGllbnRBZGRyZXNzIjoiMTM0LjE1OC4yMzEuMjgifQ.MzOD9wQY3i5lDcWsO5UbUqXDUbiVGXr4GnnBR0EN5QAh40LLOvMfFJ09zDkktgKjbHJKXUL7wWX2m2fzz-M1CJZmIEQN5aM2XMU-AVwC-xyFb_G23g2_vnQEESeTeLgqm7MEDj3JJuxXZGFdJ2OGu3DllWPtRs73aZA2eztCg_NuAV7B5K4p2yv7MOhAb1h_RqEJuGp-qT6g9_6cgauKRm4rMfiQ9D3E31KIJTB4qHVgKxxiPJ7KMgl4XSzQMIa9oz0d2WNKOZA_fcRcJLN-tOGGfgrEgBm59t7-YZ5AvYqJ_nOZp6_eaSBMX2c7ey-CJ8XeoCKwYphlyuYSeyHajw</variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/projects</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>


    <view name="registerClient">

        <variable name="access_token">eyJraWQiOiJvaWRjIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI0NmQ5OTc3NzI2ZTU5ZjkzYmJkMzhlMTBiMmMwOGZhOGY3ZjJiNTQxZWYxYzY2YmFiMjc3OTYwZTFmODU2NGY0QGVnaS5ldSIsImF6cCI6ImUyYjQ0ZDY3LTE3NGMtNDAxYy05Y2FmLTJiZDUzYTRlMDU1YSIsImlzcyI6Imh0dHBzOlwvXC9hYWktZGVtby5lb3NjLXBvcnRhbC5ldVwvb2lkY1wvIiwiZXhwIjoxNjU4MzA4NjA1LCJpYXQiOjE2NTgzMDUwMDUsImp0aSI6IjliNjQ5MjlmLTEyMWItNDU1MS05NDVlLWQyM2VjMWNhZDc0YyJ9.AV6-KPsK_tO_8wJWEm2RLPdt_P3neqP7TM8BecOnBbRpI2_Fnh9xcD9H1liyku4Xxr5sWgCkPJp2_pc84xMoJ1Q92ED82CS3XL6fDItZfbbbOGhuyrkdPCYQyiEcv2249nYC2p6tfU1vvzeWi3O_xce8PsTvWGc09lYr7hXNvHt8gNFXA91Okhbmt1ljuNmoNZSQ282YJ_yoP8IWtZ86yxrpZQV82hqN0TCGuNIiElRiE1VgFl4u1oNbYGm786w9MW6VUB8WVKB0JWzdvmEJKiFOD-D0HaKCGuIQEj5zfl2uAi1WN9BgEzxN7JcygQ5XZGGHIaXdL8rBGnBkEQH50g</variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/clients</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>


    <view name="listDef">
  <!--
  <object>
    <voperson_id>46d9977726e59f93bbd38e10b2c08fa8f7f2b541ef1c66bab277960e1f8564f4@egi.eu</voperson_id>
    <name>Cyril Lorphelin</name>
    <email>cyril.lorphelin@cc.in2p3.fr</email>
</object>-->
        <variable name="access_token">eyJraWQiOiJvaWRjIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI0NmQ5OTc3NzI2ZTU5ZjkzYmJkMzhlMTBiMmMwOGZhOGY3ZjJiNTQxZWYxYzY2YmFiMjc3OTYwZTFmODU2NGY0QGVnaS5ldSIsImF6cCI6ImUyYjQ0ZDY3LTE3NGMtNDAxYy05Y2FmLTJiZDUzYTRlMDU1YSIsImlzcyI6Imh0dHBzOlwvXC9hYWktZGVtby5lb3NjLXBvcnRhbC5ldVwvb2lkY1wvIiwiZXhwIjoxNjU4MzA4NjA1LCJpYXQiOjE2NTgzMDUwMDUsImp0aSI6IjliNjQ5MjlmLTEyMWItNDU1MS05NDVlLWQyM2VjMWNhZDc0YyJ9.AV6-KPsK_tO_8wJWEm2RLPdt_P3neqP7TM8BecOnBbRpI2_Fnh9xcD9H1liyku4Xxr5sWgCkPJp2_pc84xMoJ1Q92ED82CS3XL6fDItZfbbbOGhuyrkdPCYQyiEcv2249nYC2p6tfU1vvzeWi3O_xce8PsTvWGc09lYr7hXNvHt8gNFXA91Okhbmt1ljuNmoNZSQ282YJ_yoP8IWtZ86yxrpZQV82hqN0TCGuNIiElRiE1VgFl4u1oNbYGm786w9MW6VUB8WVKB0JWzdvmEJKiFOD-D0HaKCGuIQEj5zfl2uAi1WN9BgEzxN7JcygQ5XZGGHIaXdL8rBGnBkEQH50g</variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>



    <view name="publishMetricDefinition">
        <argument name="metric_name">metric_test_api122</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>

       <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('metric_name'), ': ',quot($metric_name),','
            , quot('metric_description'), ': ',quot($metric_description),','
            , quot('metric_type'), ': ',quot($metric_type),','
            , quot('unit_type'), ': ',quot($unit_type)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>




    <view name="patchMetricDefinition" xmlns:java="http://software.in2p3.fr/lavoisier/java">
        <argument name="metric_id">6213a0b6fbedc07f931b436a</argument>
        <argument name="metric_name">nb_eosc_services_test_core</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>
        <variable name="post" eval="concat('{'
            , quot('metric_name'), ':',quot($metric_name),','
            , quot('metric_description'), ':',quot($metric_description),','
            , quot('metric_type'), ':',quot($metric_type),','
            , quot('unit_type'), ':',quot($unit_type)
            ,'}')"/>

       <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>
        <variable name="access_token" eval="concat('Authorization:Bearer',view('getAccessToken')/object/access_token/text())"></variable>


        <connector type="ShellConnector">
            <parameter name="executable">/bin/sh </parameter>
            <parameter name="arguments">
                <entry eval="concat(property('shell.dir'),'curlApi.sh')"/>
                <entry eval="$url"/>
                <entry eval="$access_token"/>
                <entry eval="$post"/>
            </parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>
    </view>



    <view name="deleteMetricDefinition">
        <argument name="metric_id">62165480fbedc07f931b436e</argument>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
            <fallback eval="new_element('code','409')|new_element('message','The Metric Definition cannot be deleted. There is a Metric assigned to it.')">
                <exception type="java.io.IOException" />
            </fallback>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>

    <view name="listMetricDefinition">
<!--        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>-->
<!--        <variable name="access_token">eyJraWQiOiJvaWRjIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI0NmQ5OTc3NzI2ZTU5ZjkzYmJkMzhlMTBiMmMwOGZhOGY3ZjJiNTQxZWYxYzY2YmFiMjc3OTYwZTFmODU2NGY0QGVnaS5ldSIsImF6cCI6ImUyYjQ0ZDY3LTE3NGMtNDAxYy05Y2FmLTJiZDUzYTRlMDU1YSIsImlzcyI6Imh0dHBzOlwvXC9hYWktZGVtby5lb3NjLXBvcnRhbC5ldVwvb2lkY1wvIiwiZXhwIjoxNjU4MjQ1NDU2LCJpYXQiOjE2NTgyNDE4NTYsImp0aSI6IjQ2MDg0NGYxLWRkZDEtNDZjMS04NWEwLTRkZjAyOGNiZTVjNSJ9.M1rhz8BVKFqokdnLtqb5Ty1zVbOINhhiXeDeDBK-A7Gf-h2BxkI8ZxlUtuDpyVE7UigutwFQRHTqejOxZqr-X_nauTn2ooRRWAH7XGy2kkiNyiN5kZU-VxApj4O9A44sMx3OZwWZBMWLwtXCzOS4_RGR3f87t96TKqubit2OiVtSiOzWOgPTqDHEuOVi2vvI-_V2VT9qHXo_sw3OfoEHK22m4nMN6HmsfRi05Hv0vPpyBwDHcQMIqwHIc_JItuC7r8hZbUPqtJE9BIpv5TLuZiOArpR044XEpTFwtNwFJtN9E4j9Bkss6eLU4IpQkyqf8zhgVk7_I_YLLR_RmqbPLw</variable>-->
        <variable name="access_token">eyJraWQiOiJvaWRjIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI0NmQ5OTc3NzI2ZTU5ZjkzYmJkMzhlMTBiMmMwOGZhOGY3ZjJiNTQxZWYxYzY2YmFiMjc3OTYwZTFmODU2NGY0QGVnaS5ldSIsImF6cCI6ImUyYjQ0ZDY3LTE3NGMtNDAxYy05Y2FmLTJiZDUzYTRlMDU1YSIsImlzcyI6Imh0dHBzOlwvXC9hYWktZGVtby5lb3NjLXBvcnRhbC5ldVwvb2lkY1wvIiwiZXhwIjoxNjU4MzA4NjA1LCJpYXQiOjE2NTgzMDUwMDUsImp0aSI6IjliNjQ5MjlmLTEyMWItNDU1MS05NDVlLWQyM2VjMWNhZDc0YyJ9.AV6-KPsK_tO_8wJWEm2RLPdt_P3neqP7TM8BecOnBbRpI2_Fnh9xcD9H1liyku4Xxr5sWgCkPJp2_pc84xMoJ1Q92ED82CS3XL6fDItZfbbbOGhuyrkdPCYQyiEcv2249nYC2p6tfU1vvzeWi3O_xce8PsTvWGc09lYr7hXNvHt8gNFXA91Okhbmt1ljuNmoNZSQ282YJ_yoP8IWtZ86yxrpZQV82hqN0TCGuNIiElRiE1VgFl4u1oNbYGm786w9MW6VUB8WVKB0JWzdvmEJKiFOD-D0HaKCGuIQEj5zfl2uAi1WN9BgEzxN7JcygQ5XZGGHIaXdL8rBGnBkEQH50g</variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="key">../metric_definition_id/text()</attribute-create>
                    <element-ignore>
                        <element-create>
                            entry(local-name(current()/..),current()/../text())
                        </element-create>
                    </element-ignore>
                </element>

            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">10</parameter>
            </trigger>
        </cache>

    </view>

    <view name="listMetricType">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions/metric-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                   <element in="object" out="e:entries">
                       <attribute-create out="key">../metric_type/text()</attribute-create>
                       <element-ignore></element-ignore>
                   </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">31</parameter>
            </trigger>
        </cache>
    </view>

    <view name="listMetricsbyId"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="metricId">620a4fb0bbe46734c6bfa785</argument>
        <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metricId,'/metrics?size=100')"/>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>

                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element in="e:entries"/>
                <element-ignore/>
            </element>

        </processors>


    </view>


    <view name="listUnits">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/unit-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../symbol/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>
                    </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">30</parameter>
            </trigger>
        </cache>
    </view>




</views>