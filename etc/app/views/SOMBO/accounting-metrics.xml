<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : lavopsportal 
        File    : accounting-metrics.xml
        Created by cyril on 2022/02/17 
    -->

    <view name="getAccessToken" authenticators="admin">
        <variable name="client-id" eval="property('acc-client-id')"></variable>
        <variable name="acc-refresh_token" eval="property('acc-refresh_token')"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('acc-client-id'),':',property('acc-client-pwd'),'@',property('acc-url'))"/>
            <parameter name="header">
                <entry key="Content-Type">application/x-www-form-urlencoded</entry>

            </parameter>
            <parameter name="post" eval="concat('client_id=',$client-id,'&amp;grant_type=refresh_token&amp;refresh_token=',$acc-refresh_token,'&amp;scope=openid%20email%20profile%20voperson_id%20eduperson_entitlement')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="seconds">3000</parameter>
            </trigger>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>




    <view name="listProjects">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/projects</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>


    <view name="registerClient">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/clients</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>


    <view name="listDef">

        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>
        <serializer type="JSONStreamSerializer"/>

    </view>



    <view name="publishMetricDefinition">
        <argument name="metric_name">metric_test_api122</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>

       <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('metric_name'), ': ',quot($metric_name),','
            , quot('metric_description'), ': ',quot($metric_description),','
            , quot('metric_type'), ': ',quot($metric_type),','
            , quot('unit_type'), ': ',quot($unit_type)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>




    <view name="patchMetricDefinition" xmlns:java="http://software.in2p3.fr/lavoisier/java">
        <argument name="metric_id">6213a0b6fbedc07f931b436a</argument>
        <argument name="metric_name">nb_eosc_services_test_core</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>
        <variable name="post" eval="concat('{'
            , quot('metric_name'), ':',quot($metric_name),','
            , quot('metric_description'), ':',quot($metric_description),','
            , quot('metric_type'), ':',quot($metric_type),','
            , quot('unit_type'), ':',quot($unit_type)
            ,'}')"/>

       <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>
        <variable name="access_token" eval="concat('Authorization:Bearer',view('getAccessToken')/object/access_token/text())"></variable>


        <connector type="ShellConnector">
            <parameter name="executable">/bin/sh </parameter>
            <parameter name="arguments">
                <entry eval="concat(property('shell.dir'),'curlApi.sh')"/>
                <entry eval="$url"/>
                <entry eval="$access_token"/>
                <entry eval="$post"/>
            </parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>
    </view>



    <view name="deleteMetricDefinition">
        <argument name="metric_id">62165480fbedc07f931b436e</argument>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
            <fallback eval="new_element('code','409')|new_element('message','The Metric Definition cannot be deleted. There is a Metric assigned to it.')">
                <exception type="java.io.IOException" />
            </fallback>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>

    <view name="listMetricDefinition">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>
        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer ',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="key">../metric_definition_id/text()</attribute-create>
                    <element-ignore>
                        <element-create>
                            entry(local-name(current()/..),current()/../text())
                        </element-create>
                    </element-ignore>
                </element>

            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">10</parameter>
            </trigger>
        </cache>

    </view>

    <view name="listMetricType">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definitions/metric-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                   <element in="object" out="e:entries">
                       <attribute-create out="key">../metric_type/text()</attribute-create>
                       <element-ignore></element-ignore>
                   </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">31</parameter>
            </trigger>
        </cache>
    </view>

    <view name="listMetricsbyId"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="metricId">620a4fb0bbe46734c6bfa785</argument>
        <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metricId,'/metrics?size=100')"/>
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>

                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element in="e:entries"/>
                <element-ignore/>
            </element>

        </processors>


    </view>


    <view name="listUnits">
        <variable name="access_token" eval="view('getAccessToken')/object/access_token/text()"></variable>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/unit-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization" eval="concat('Bearer',$access_token)"></entry>

            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../symbol/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>
                    </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">30</parameter>
            </trigger>
        </cache>
    </view>




</views>