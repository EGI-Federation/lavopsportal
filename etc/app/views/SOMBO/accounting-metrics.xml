<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd">
    <!-- 
        Project : lavopsportal 
        File    : accounting-metrics.xml
        Created by cyril on 2022/02/17 
    -->
    <view name="publishMetricDefinition" authenticators="admin">
        <argument name="metric_name">metric_test_api122</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition</parameter>
            <parameter name="method">POST</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
                <entry key="Authorization: Bearer">eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJiRy1TUERFRU9hempOQzVDY0hQZ3k3Q2lzVmlhQ1AzeXpmemh3b0RIcnV3In0.eyJleHAiOjE2NDU3NzY2MzAsImlhdCI6MTY0NTc3NjMzMCwiYXV0aF90aW1lIjoxNjQ1Nzc2MzI5LCJqdGkiOiIxMTU4ZDlkMC03NmVhLTQ2ZGEtODAzMi1jY2FjZThiZDdlYWYiLCJpc3MiOiJodHRwczovL2xvZ2luLWRldmVsLmVpbmZyYS5ncm5ldC5nci9hdXRoL3JlYWxtcy9laW5mcmEiLCJzdWIiOiJiNDQ0MWY1ZC0wZTgyLTQxMGItYmY2My0wOGU4MzU1NTQwMDYiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhY2NvdW50aW5nLXN5c3RlbS1wdWJsaWMiLCJub25jZSI6ImJlN2M1ZTIwLTVhYjMtNDM5Ny1hYWQ1LTUxZDdiZmJjZjZjNCIsInNlc3Npb25fc3RhdGUiOiI5YjZmMGI0MS0yY2ZlLTQ1NjQtYWM5YS0wNGU1ODYzNTU2NWYiLCJhY3IiOiIxIiwic2NvcGUiOiJvcGVuaWQiLCJzaWQiOiI5YjZmMGI0MS0yY2ZlLTQ1NjQtYWM5YS0wNGU1ODYzNTU2NWYifQ.TEuP_7Q2x6wWu09XADLH5CJ07lQ68t_ENWX5qHLDwA9MpLcp3wPZOeqoU0v9tZcOAkkZ0ReC7Ees6VsVh7Gu04GxUJmcU0BFpv_MuAf4yRaC19itkWj0-5D6PiGaRW_3Uvqf2qwJZFZEeFWtwPqgU3OTt-eTjCcPROCvMbndKytcQ48WQT7ZdoPu88L4VkoQfmWnz4MwU28YIAOhYOkP20D-zBUsIAfob8gJV5TOtR1T8DUcQiTNuc3po8mARCxqhuvImM_vZCBquaTABVRRVSu_ryaNmZkWo7tZVjbRsUmzfizZKc0UhIbKY4hXQquQuN3MS58oV_jFbcJZdxdSuA</entry>
            </parameter>

            <parameter name="post" eval="concat( '{'
            , quot('metric_name'), ': ',quot($metric_name),','
            , quot('metric_description'), ': ',quot($metric_description),','
            , quot('metric_type'), ': ',quot($metric_type),','
            , quot('unit_type'), ': ',quot($unit_type)
            ,'}')"/>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>




    <view name="patchMetricDefinition" xmlns:java="http://software.in2p3.fr/lavoisier/java" authenticators="admin">
        <argument name="metric_id">6213a0b6fbedc07f931b436a</argument>
        <argument name="metric_name">nb_eosc_services_test_core</argument>
        <argument name="metric_description">metric_test_description</argument>
        <argument name="metric_type">aggregated</argument>
        <argument name="unit_type">#</argument>
        <variable name="post" eval="concat('{'
            , quot('metric_name'), ':',quot($metric_name),','
            , quot('metric_description'), ':',quot($metric_description),','
            , quot('metric_type'), ':',quot($metric_type),','
            , quot('unit_type'), ':',quot($unit_type)
            ,'}')"/>
       <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>


        <connector type="ShellConnector">
            <parameter name="executable">/bin/sh </parameter>
            <parameter name="arguments">
                <entry eval="concat(property('shell.dir'),'curlApi.sh')"/>
                <entry eval="$url"/>
                <entry eval="$post"/>
            </parameter>
        </connector>
        <serializer type="EncapsulateSerializer"></serializer>
    </view>



    <view name="deleteMetricDefinition" authenticators="admin">
        <argument name="metric_id">62165480fbedc07f931b436e</argument>

        <connector type="HTTPConnector">

            <parameter name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metric_id)"/>
            <parameter name="method">DELETE</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>
            <fallback eval="new_element('code','409')|new_element('message','The Metric Definition cannot be deleted. There is a Metric assigned to it.')">
                <exception type="java.io.IOException" />
            </fallback>

        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

    </view>

    <view name="listMetricDefinition" authenticators="admin">

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="item" out="e:entries">
                <element in="object" out="e:entries">
                    <attribute-create out="key">../metric_definition_id/text()</attribute-create>
                    <element-ignore>
                        <element-create>
                            entry(local-name(current()/..),current()/../text())
                        </element-create>
                    </element-ignore>
                </element>

            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">10</parameter>
            </trigger>
        </cache>

    </view>

    <view name="listMetricType">

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/metric-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                   <element in="object" out="e:entries">
                       <attribute-create out="key">../metric_type/text()</attribute-create>
                       <element-ignore></element-ignore>
                   </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">31</parameter>
            </trigger>
        </cache>
    </view>

    <view name="listMetricsbyId"   xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

        <argument name="metricId">620a4fb0bbe46734c6bfa785</argument>
        <variable name="url" eval="concat('https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/',$metricId,'/metrics?size=100')"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="$url"></parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore in="content">
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../id/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>

                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>

            <element in="e:entries">
                <element in="e:entries"/>
                <element-ignore/>
            </element>

        </processors>


    </view>


    <view name="listUnits">

        <connector type="HTTPConnector">
            <parameter name="url">https://acc.devel.argo.grnet.gr/accounting-system/metric-definition/unit-types</parameter>
            <parameter name="method">GET</parameter>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>
        </connector>

        <serializer type="JSONStreamSerializer"></serializer>

        <processors>
            <element in="object" out="e:entries">
                <element-ignore>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../symbol/text()</attribute-create>
                        <element-ignore>
                            <element-create>
                                entry(local-name(current()/..),current()/../text())
                            </element-create>
                        </element-ignore>
                    </element>
                </element-ignore>
            </element>
        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"></trigger>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">30</parameter>
            </trigger>
        </cache>
    </view>



</views>