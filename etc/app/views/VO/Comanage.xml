<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd"
       xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" xmlns:t="http://software.in2p3.fr/lavoisier/tables.xsd" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <!-- 
        Project : lavopsportal 
        File    : Comanage.xml
        Created by cyril on 2021/11/24 
    -->


    <view name="Comanage.insert.users">
        <connector type="HTTPConnector">
            <parameter name="url" eval="property('Comanage.insert.users')"></parameter>
            <parameter name="header">
                <entry key="x-api-key" eval="property('lavoisier-token')"/>
                <entry key="Accept">application/xml</entry>
            </parameter>
            <parameter name="connect-timeout">1400</parameter>
            <parameter name="read-timeout">1500</parameter>
        </connector>

        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">4</parameter>
                <parameter name="minute">35</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>
    </view>


    <view name="CoManageVOs">

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('comanage-user'),':',property('comanage-pwd'),'@',property('comanage-instance'),'/cous.json?coid=2')"/>
            <parameter name="default">{"root":"empty"}</parameter>
        </connector>

        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object" out="vos">
                <element-ignore in="Cous">
                    <element in="object" out="vo">
                        <attribute-create out="id">../Id/text()</attribute-create>
                        <attribute-create out="coid">../CoId/text()</attribute-create>
                        <attribute-create out="name">../Name/text()</attribute-create>
                        <attribute-create out="description">../Description/text()</attribute-create>
                        <element-create if="property('env')='prod'">view('CoManageMembers',entry('cogroupid',../Id/text()))/users/*</element-create>
                        <element-ignore/>
                    </element>
                    <element-ignore/>
                </element-ignore>
            </element>
            <element in="vos">
                <element in="vo">
                    <element in="user">
                        <element-create>new_element('VO',new_text(../../@name))</element-create>
                    </element>
                </element>
                <element-ignore/>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="FixedTimeTrigger">
                <parameter name="hour">3</parameter>
                <parameter name="minute">55</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
        </cache>


    </view>


    <view name="CoManageMembers">
        <argument name="cogroupid"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('comanage-user'),':',property('comanage-pwd'),'@aai.egi.eu/registry/co_person_roles.json?couid=',$cogroupid)"/>
            <parameter name="default">{"root":"empty"}</parameter>

        </connector>
        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object" out="users">
                <element-ignore in="CoPersonRoles">
                    <element in="object" out="user">
                        <attribute-create out="id">../Person/Id/text()</attribute-create>
                        <attribute-create out="affiliation">../Affiliation/text()</attribute-create>
                        <attribute-create out="status">../Status/text()</attribute-create>
                        <element-ignore/>
                    </element>
                </element-ignore>
                <element-ignore/>
            </element>

            <element in="users">
                <element in="user">
                    <element-create>view('CoManagePerson',entry('copersonid',../@id))/object/*</element-create>
                    <element-create>view('CoManageEmail',entry('copersonid',../@id))/object/*</element-create>
                </element>
            </element>

            <element in="users">
                <element-ignore in="user" if="@status!='Active'"/>
            </element>
        </processors>
    </view>

    <view name="CoManagePerson">
        <argument name="copersonid"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('comanage-user'),':',property('comanage-pwd'),'@aai.egi.eu/registry/names.json?copersonid=',$copersonid)"/>
            <parameter name="default">{"root":"empty"}</parameter>

        </connector>
        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object">
                <elements-ignore path="Names/object">
                    <element in="Given" />
                    <element in="Family"/>
                    <element in="ActorIdentifier" out="DN"/>
                    <element-ignore/>
                </elements-ignore>
                <element-ignore/>
            </element>

            <element in="object">
                <element-create>new_element('CN',new_text(concat(../Given/text(),' ',../Family/text())))</element-create>
                <element-create>new_element('CA',new_text('aai'))</element-create>
                <element-create>new_element('VOMS',new_text('aai'))</element-create>
            </element>
        </processors>
    </view>

    <view name="CoManageEmail">
        <argument name="copersonid"/>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat('https://',property('comanage-user'),':',property('comanage-pwd'),'@aai.egi.eu/registry/email_addresses.json?copersonid=',$copersonid)"/>
            <parameter name="default">{"root":"empty"}</parameter>

        </connector>
        <serializer type="JSONStreamSerializer"/>


        <processors>
            <element in="object">
                <elements-ignore path="EmailAddresses/object">
                    <element in="Mail" out="mail"/>
                    <element-ignore/>
                </elements-ignore>
                <element-ignore/>
            </element>
        </processors>

    </view>


</views>