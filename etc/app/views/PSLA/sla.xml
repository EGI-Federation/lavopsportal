<views xmlns="http://software.in2p3.fr/lavoisier/application.xsd" >

    <view name="JiraUpdateTicket" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="ticketId">EOSCSO-2</argument>
        <argument name="postJson">{
            "fields": {
            "customfield_10226":"harry"
            }
            }</argument>

        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/issue/',$ticketId)"/>

            <parameter name="method">PUT</parameter>
            <parameter name="post" eval="$postJson"/>
            <parameter name="header">
                <entry key="Content-Type">application/json</entry>
            </parameter>

            <!--<fallback eval="new_element('ERROR', arguments())">-->
                <!--<exception type="java.io.ioException"/>-->

                <!--<exception type="java.net.SocketTimeoutException"/>-->
                <!--<exception type="java.net.ConnectException" predicate-on-message="contains(.,'Connection refused')"/>-->
                <!--<exception type="org.xml.sax.SAXParseException"/>-->
                <!--<exception type="java.io.FileNotFoundException"/>-->
            <!--</fallback>-->
        </connector>

        <serializer type="EncapsulateSerializer"/>




    </view>

    <view name="JiraAddComment" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

    <argument name="ticketId">EOSCSO-2</argument>
    <argument name="postJson">{"body": "This is a new comment"}</argument>

    <connector type="HTTPConnector">
        <parameter name="url"
                   eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/issue/',$ticketId,'/comment')"/>

        <parameter name="method">POST</parameter>
        <parameter name="post" eval="$postJson"/>
        <parameter name="header">
            <entry key="Content-Type">application/json</entry>
        </parameter>

        <!--<fallback eval="new_element('ERROR', arguments())">-->
        <!--<exception type="java.io.ioException"/>-->

        <!--<exception type="java.net.SocketTimeoutException"/>-->
        <!--<exception type="java.net.ConnectException" predicate-on-message="contains(.,'Connection refused')"/>-->
        <!--<exception type="org.xml.sax.SAXParseException"/>-->
        <!--<exception type="java.io.FileNotFoundException"/>-->
        <!--</fallback>-->
    </connector>

    <serializer type="EncapsulateSerializer"/>




</view>

    <view name="JiraComment" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <argument name="ticketId">EOSCSO-2</argument>



        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/issue/',$ticketId,'/comment')"/>


        </connector>


        <serializer type="JSONStreamSerializer"/>

        <processors>
            <element in="object" out="e:entries">
                <attribute-create out="key">'comments'</attribute-create>

                <element-ignore in="comments" >
                    <element-create>entry('NbComments',count(../object))</element-create>
                    <element in="object" out="e:entries">
                        <attribute-create out="key">../created/text()</attribute-create>
                        <element-ignore in="author">
                            <element in="displayName" out="e:entry">
                                <attribute-create out="key">'author'</attribute-create>
                            </element>

                        </element-ignore>
                        <element in="created" out="e:entry">
                            <attribute-create out="key">'date'</attribute-create>
                        </element>
                        <element in="body" out="e:entry">
                            <attribute-create out="key">'body'</attribute-create>
                        </element>

                        <element-ignore/>
                    </element>
                </element-ignore>
                <element-ignore/>

            </element>

        </processors>

    </view>


    <view name="JiraTicketList" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" >

        <connector type="HTTPConnector">
            <parameter name="url"
                       eval="concat('https://',property('userJira'),':',property('pwdJira'),'@jira.eosc-hub.eu/rest/api/2/search?jql=issuetype=',quot('Service%20order'),'&amp;maxResults=1000')"/>

        </connector>

        <serializer type="JSONStreamSerializer"/>

        <processors>

            <element in="object" out="e:entries">

                <attribute-create out="key">local-name(..)</attribute-create>

                <element-ignore if="not(*/*)">
                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                </element-ignore>

                <element in="issues" out="e:entries">

                    <attribute-create out="key">local-name(..)</attribute-create>
                    <element-ignore if="not(*/*)">
                        <element-create if="../text()">entry(local-name(..),../text())</element-create>
                    </element-ignore>

                    <element in="object" out="e:entries">

                        <attribute-create out="key">../key</attribute-create>

                        <element-ignore if="not(*/*)">
                            <element-create if="../text()">entry(local-name(..),../text())</element-create>
                        </element-ignore>

                        <element in="fields" out="e:entries">

                            <attribute-create out="key">local-name(..)</attribute-create>
                            <!--<element-create>entry('NbComments',choose(view('JiraComment',entry('ticketId',../../key))/e:entries/e:entry[@key='NbComments'],view('JiraComment',entry('ticketId',../../key))/e:entries/e:entry[@key='NbComments'],0))</element-create>-->

                            <element-ignore if="not(*/*)">
                                <element-create if="../text()">entry(local-name(..),../text())</element-create>
                            </element-ignore>

                            <element in="issuetype" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="project" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="priority" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="labels" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="assignee" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="status" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>
                            <element in="customfield_10250" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>

                            <element in="customfield_10201" out="e:entries">
                                <attribute-create out="key">local-name(..)</attribute-create>
                                <element-ignore if="not(*/*)">
                                    <element-create if="../text()">entry(local-name(..),../text())</element-create>
                                </element-ignore>
                            </element>

                            <element-ignore in="customfield_10000"/>


                            <element-ignore/>
                        </element>
                    </element>
                </element>

            </element>

            <element in="e:entries">

                <element-ignore in="e:entries">

                    <element in="e:entries">



                        <element in="e:entry" if="@key='key'">
                            <attribute in="key">'id'</attribute>
                        </element>

                        <element-create>entry('link',concat('https://jira.eosc-hub.eu/browse/',../e:entry[@key='key']/text()))</element-create>

                        <element-ignore in="e:entries" if="@key='fields'">
                            <element-ignore in="e:entries" if="@key='status'">
                                <element in="e:entry" if="@key='name'">
                                    <attribute in="key">'status'</attribute>
                                </element>
                            </element-ignore>

                            <element in="e:entry" if="@key='customfield_10228'">
                                <attribute in="key">'author'</attribute>
                            </element>
                            <element in="e:entry" if="@key='customfield_10400'">
                                <attribute in="key">'SO-1'</attribute>
                            </element>
                            <element in="e:entry" if="@key='customfield_10401'">
                                <attribute in="key">'SO-2'</attribute>
                            </element>
                            <element in="e:entry" if="@key='customfield_10403'">
                                <attribute in="key">'SO-3'</attribute>
                            </element>
                            <element in="e:entry" if="@key='customfield_10404'">
                                <attribute in="key">'SO-4'</attribute>
                            </element>
                            <element in="e:entry" if="@key='customfield_10405'">
                                <attribute in="key">'SO-5'</attribute>
                            </element>

                            <element in="e:entry" if="@key='created'">
                                <attribute in="key">'Creation Date'</attribute>
                            </element>

                            <element in="e:entry" if="@key='updated'">
                                <attribute in="key">'Last Update'</attribute>
                            </element>

                            <element in="e:entry" if="@key='summary' or @key='NbComments'"/>
                        </element-ignore>

                        <element-ignore/>

                    </element>
                </element-ignore>

            </element>


                <element in="e:entries">
                    <element-ignore/>
                    <element-create>sort_by_string(../e:entries,'e:entry[@key="status"]/text()')</element-create>
                </element>

            <element in="e:entries">
                    <element-create-as-parent out="e:entries" attributes="new_attribute('key',e:entry[@key='status']/text())" group-by="e:entry[@key='status']/text()">
                        <element in="e:entries"/>
                    </element-create-as-parent>
            </element>

            <element in="e:entries">
                <element in="e:entries">
                    <attribute-create out="count">count(../e:entries)</attribute-create>
                </element>
            </element>

        </processors>

        <cache type="FileCache">
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="DeltaTimeTrigger">
                <parameter name="minutes">4</parameter>
            </trigger>
        </cache>

    <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="contentType">text/xml</parameter>
        </renderer>
    </renderers>

</view>


<view name="translationJira">

<connector type="FileConnector">
    <parameter name="path">app/resources/xml/jiraEntries.xml</parameter>
</connector>

</view>


        </views>

